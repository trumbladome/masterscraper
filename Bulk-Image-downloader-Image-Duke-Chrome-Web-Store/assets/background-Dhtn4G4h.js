import{C as q,d as Z,H as ee}from"./init-CM239Bla.js";import{b as C}from"./browser-polyfill-Bo2e-ahS.js";function J(e){return e==="undefined"||e==null||Object.keys(e).length===0&&e.constructor===Object}function B(){const e=new Date,a=e.getDate(),i=e.getMonth()+1,c=e.getFullYear();return`${i}-${a}-${c}`}function G(e,a){e.trim()===""&&(e="*");const i=new Array;return a&&(a=a.trim()),e=z(e,";"),e=V(e,";"),e.split(";").forEach(c=>{let l=te(c.trim(),a);l!=null&&l.forEach(g=>{i.push(g)})}),i}function te(e,a){if(e=z(e,"*"),!a||a.length===0)return e.endsWith("*")||(e+="|"),[e];a=z(a,";"),a=V(a,";");let i=!1;if(a.split(";").forEach(l=>{e.includes(l)&&(i=!0)}),i)return e.endsWith("*")||(e+="|"),[e];if(e.indexOf("*")===-1)return null;let c=new Array;return a.split(";").forEach(l=>{for(let g=0;g<e.length;g++)if(e.charAt(g)==="*"){let v=e.slice(0,g)+"*"+l+"*"+e.slice(g+1);v.endsWith("*")||(v+="|"),c.push(v)}}),c}function z(e,a){let i="";for(let c=0;c<e.length;c++)e.charAt(c)===a&&e.charAt(c+1)===a||(i+=e.charAt(c));return i}function V(e,a){return e.charAt(e.length-1)===a?e.slice(0,e.length-1):e}function X(e){e&&(e.remoteCheck=Date.now(),chrome.storage.local.set({config:e}))}async function re(){let{config:e}=await chrome.storage.local.get(["config"]);if(e&&e.remoteCheck){const a=Date.now(),i=3*24*60*60*1e3;a-e.remoteCheck>i&&(e=await K(!1),X(e))}return e||null}async function K(e){try{const a=await fetch(e?chrome.runtime.getURL("config/netrule.json"):`${q}/config/netrule.json?v=${B()}`,{headers:{"Content-Type":"application/json;charset=utf-8"}});if(!e&&!a.ok)throw new Error(`HTTP ${a.status}`);return await a.json()}catch(a){console.warn(`Netrule.json failed to update from ${e?"local":"remote"} repository! | `,a.message)}}function ne(e,a,i){if(i.header_name=="")return[];let c=new Array,l=new Array;return a?l=G(e,i.url_contains):l=G(e),l.forEach(g=>{const v={priority:2,action:{type:"modifyHeaders"},condition:{urlFilter:g,resourceTypes:["main_frame","sub_frame","stylesheet","script","image","font","object","xmlhttprequest","ping","csp_report","media","websocket","webtransport","webbundle","other"]}},S=[{header:i.header_name}];i.apply_on==="res"?v.action.responseHeaders=S:v.action.requestHeaders=S,i.action==="delete"?S[0].operation="remove":(S[0].operation="set",S[0].value=i.header_value),c.push(v)}),c}async function oe(){let e=await re();e||(e=await K(!0),X(e));function a(){if(!e.headers)return;const i=[],c=[];let l=4e4;e.headers.forEach(g=>{g.status==="on"&&ne(e.target_page,e.use_url_contains,g).forEach(v=>{v.id=l,c.push(v),i.push(l),l++})}),Z("Add Rules counts: "+c.length),c.length>=chrome.declarativeNetRequest.MAX_NUMBER_OF_UNSAFE_DYNAMIC_RULES?console.warn(`You've reached the maximum number of URL filters allowed by the browser. Please disable some rules or remove some "url contains".`):chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:i,addRules:c})}a()}function ae(e,a=!1){for(const l of document.querySelectorAll("daimages"))l.remove();const i=document.createElement("div");i.classList.add("daimages");const c=document.createElement("iframe");i.append(c),a?(i.style.setProperty("width","0px"),i.style.setProperty("height","0px")):(i.style.setProperty("width","100%"),i.style.setProperty("height","100%"),c.height="100%"),c.src=e,c.allowTransparency="true",document.body.append(i)}function se(){const e={};return e.promise=new Promise((a,i)=>{e.resolve=a,e.reject=i}),e}function ie(e){const{resolve:a,promise:i}=se(),c=l=>{l===e&&(C.tabs.onRemoved.removeListener(c),a())};return C.tabs.onRemoved.addListener(c),i}async function ce(e){let a,i;try{a=await C.tabs.create(e)}catch(c){if(!e.openerTabId)throw c;i=e.openerTabId,delete e.openerTabId,a=await C.tabs.create(e)}return ie(a.id),i&&C.tabs.update(i,{active:!0}).catch(console.warn),a.id}function fe(){let e,a;function i(p,y=!0){l({url:p,nf:!y,cmd:"open"})}function c(p){const R=p.dataset.sendto.replace("%url",encodeURIComponent(a)).replace("%raw_url",a);i(R)}function l(p){const y={identifier:"imageDukeContentMainWorldBridge",listener:"imgus",payload:p};chrome.runtime.sendMessage(y)}const g=p=>{p.name.indexOf("iframe")>-1&&(e=p,p.onMessage.addListener(y=>{switch(y.cmd){case"imgShowed":window.postMessage({cmd:"imgShowed",dimention:{w:y.dimention.w,h:y.dimention.h}},location.href),document.getElementById("injectingCollector").style.display="none";break;case"dl-done":document.querySelector("[data-cmd=save]").disabled=!1;break}}))};chrome.runtime.onConnect.addListener(g);function v(p){e?e.postMessage(p):setTimeout(()=>v(p),100)}chrome.runtime.onMessage.addListener(function(p,y,R){switch(p.method){case"showImg":a=Array.isArray(p.imgSrc)?p.imgSrc[0]:p.imgSrc,v(p);break}});function S(){[...document.querySelectorAll("[data-i18n]")].forEach(p=>{const y=p.dataset.i18nValue||"textContent";p[y]=chrome.i18n.getMessage(p.dataset.i18n)})}function A(){document.addEventListener("click",({target:p})=>{switch(p.dataset.cmd){case"save":document.querySelector("[data-cmd=save]").disabled=!0,v({method:"downloadThisImage"});break;case"sendTo":c(p);break}})}function _(){S(),A()}_()}async function le(e,a,i){const c=a.id;try{const l={url:`${ee}/show.html`,openerTabId:c,active:i},g=await ce(l);ue(g,e.url,e.caption,a)}catch{}}async function ue(e,a,i,c){const l=C.runtime.getURL("src/static/showiframe.html");await C.scripting.executeScript({target:{tabId:e},func:ae,args:[l,!1]}),await C.scripting.executeScript({target:{tabId:e},func:fe}),C.tabs.sendMessage(e,{method:"showImg",imgSrc:a,imgCaption:i,senderTabInfo:c})}function pe(){let e={},a;const i=chrome.runtime.getManifest(),c={name:i.name,version:i.version},l={migrateOldStorage:function(r){r()},get:function(r,s){chrome.storage.local.get(r,function(n){for(var t in n)try{if(!n[t])throw Error;n[t]=JSON.parse(n[t])}catch{delete n[t]}s(n)})},set:function(r,s){for(var n in r)r[n]=JSON.stringify(r[n]);chrome.storage.local.set(r,s)},remove:function(r){chrome.storage.local.remove(r)}},g={};g.create=chrome.tabs.create;const v={parse_msg:function(r,s,n){return{msg:r.payload,origin:s.url,postMessage:n}},listen:function(r,s=!1){chrome.runtime.onMessage.addListener((n,t,o)=>{if(n&&n.identifier==="imageDukeContentMainWorldBridge"&&n.listener==="imgus"&&(r(n,t,o),s))return!0})}},S=function(r){if(!(!r||!r.url)){var s=r.url,n=r.path,t=JSON.parse(r.mimetoext),o=new RegExp(r.priorityExt,"i"),u={url:s};n?(n.slice[-1]!="/"&&(n+="/"),u.saveAs=!1):n="";var f=function(m,h){if(!m.filename.includes(".")||!m.filename.match(o)){var b=m.filename.match(/([^\.])+/)[0];o=s.match(o),o||(o=t[m.mime]),o||(o=r.ext),b+="."+o,h({filename:n+b})}else if(n){var b=m.filename;h({filename:n+b})}chrome.downloads.onDeterminingFilename.removeListener(f)};r.filename?((!r.filename.includes(".")||!r.filename.match(o))&&(o=s.match(o),o||(o=r.ext),r.filename+="."+o),u.filename=n+r.filename):chrome.downloads.onDeterminingFilename.addListener(f),chrome.downloads.download(u)}};RegExp.escape=function(r){return r.replace(/[/\\^$-.+*?|(){}[\]]/g,"\\$&")};var A=function(r,s,n){return s[1]==="/"&&s[0]==="/"?n?r.slice(0,r.indexOf(":")+1)+s:s:/^[\w-]{2,20}:/i.test(s)?s:r.replace(s[0]==="/"?/(\/\/[^/]+)\/.*/:/(\/)[^/]*(?:[?#].*)?$/,"$1")+s};async function _(){try{const r=await fetch(chrome.runtime.getURL("config/config.json"),{headers:{"Content-Type":"application/json;charset=utf-8"}});if(!r.ok)throw new Error(`Network response was not ok: ${r.statusText}`);return r.json()}catch(r){console.info("Error fetching config.json:",r)}}async function p(){return(await fetch(chrome.runtime.getURL("config/rules.json"),{headers:{"Content-Type":"application/json;charset=utf-8"}})).json()}async function y(){const r=["grants","sieve","tls","keys","hz","modlist","otherprefs4imageduke"];try{let s=await chrome.storage.local.get(r);J(s)&&(s=await _(),s.sieve=await p());const n=(t,o)=>{let u=o[t];return typeof u=="string"&&(u=JSON.parse(u)),u};for(const t in s)try{if(!s[t])throw new Error;t!=="sieve"?e[t]=n(t,s):F(n(t,s))}catch{delete s[t]}}catch(s){console.error("preparePrefs Error retrieving storage items:",s)}}const R=async(r,s)=>{let n;const t=o=>{const u=o.sieve,f=o.modlist;if(u){const m={};f.forEach(h=>{m[h]={old:u[h],new:{...n[h]}},n[h].off=u[h].off}),typeof s=="function"&&s({updated:n,resolving:m})}else N({sieve:n},()=>{typeof s=="function"&&s({updated:n})});console.info(`${c.name}: Sieve updated from ${r?"local":"remote"} repository.`)};try{const o=await fetch(r?chrome.runtime.getURL("config/rules.json"):`${q}/config/rules.json?v=${B()}`,{headers:{"Content-Type":"application/json;charset=utf-8"}});if(!r&&!o.ok)throw new Error(`HTTP ${o.status}`);n=await o.json(),l.get(["sieve","modlist"],t)}catch(o){console.warn(`${c.name}: Sieve failed to update from ${r?"local":"remote"} repository! | `,o.message),r||l.get("sieve",u=>{u.sieve||R(!0,s)})}};var F=function(r){typeof r=="string"?r=JSON.parse(r):r=JSON.parse(JSON.stringify(r));var s=[];a=[];for(var n in r){var t=r[n];if(t.ruleName=n,!(!t.link&&!t.img||t.img&&!t.to&&!t.res)){try{if(t.off)throw n+" is off";if(t.res)if(/^:\n/.test(t.res))a[s.length]=t.res.slice(2),t.res=1;else{if(t.res.indexOf(`
`)>-1){var o=t.res.split(/\n+/);t.res=RegExp(o[0]),o[1]&&(t.res=[t.res,RegExp(o[1])])}else t.res=RegExp(t.res);a[s.length]=t.res,t.res=!0}}catch{continue}t.to&&t.to.indexOf(`
`)>0&&t.to.indexOf(`:
`)!==0&&(t.to=t.to.split(`
`)),delete t.note,s.push(t)}}e.sieve=s},N=function(r,s){r||(r={});var n,t=function(o){var u,f,m,h={},b={};for(f in n){if(u=!1,typeof n[f]=="object"){if(h[f]=r[f]||o[f]||n[f],u=!0,!Array.isArray(n[f]))for(m in n[f])(h[f][m]===void 0||typeof h[f][m]!=typeof n[f][m])&&m!="save"&&(h[f][m]=(!e||e[f][m]===void 0?n:e)[f][m])}else m=r[f]||o[f]||n[f],typeof m!=typeof n[f]&&(m=n[f]),(!e||e[f]!==m)&&(u=!0),h[f]=m;(u||o[f]===void 0)&&(b[f]=h[f])}if(e=h,h.grants){m=h.grants||[];var O=[];for(f=0;f<m.length;++f)m[f].op!==";"&&O.push({op:m[f].op,url:m[f].op.length===2?RegExp(m[f].url,"i"):m[f].url});O.length&&(e.grants=O)}r.sieve&&(b.sieve=typeof r.sieve=="string"?JSON.parse(r.sieve):r.sieve,F(b.sieve)),l.set(b,function(){r.sieve||l.get("sieve",function(d){d.sieve?F(d.sieve):R(!0)}),typeof s=="function"&&s()})};(async function(){const o=await _();J(o)||(n=o,l.get(Object.keys(n),t))})()},Q=async function(r,s,n){var t,o;if(s===null?t=r:(o=v.parse_msg(r,s,n),t=o.msg),!!t.cmd)switch(t.cmd){case"hello":oe(),J(e)&&await y();var u,f,m,h=!1,b={hz:e.hz,sieve:e.sieve,tls:e.tls,keys:e.keys,grants:e.grants,otherprefs4imageduke:e.otherprefs4imageduke},O={numpad:e.hz.numpad,key:e.keys.hz_grants,grants:e.grants};if(e.grants)for(m=e.grants,u=0,f=m.length;u<f;++u)(m[u].url==="*"||m[u].op[1]&&m[u].url.test(o.origin)||o.origin.indexOf(m[u].url)>-1)&&(h=m[u].op[0]==="!");o.postMessage({cmd:"hello",prefs:h?O:b,allow:!h});break;case"cfg_get":Array.isArray(t.keys)||(t.keys=[t.keys]),l.get(t.keys,function(w){o.postMessage({cfg:w})});break;case"cfg_del":Array.isArray(t.keys)||(t.keys=[t.keys]),l.remove(t.keys),o.postMessage({});break;case"savePrefs":N(t.prefs),o.postMessage({});break;case"update_sieve":R(!1,function(w){o.postMessage(w)});break;case"download":if(typeof chrome.downloads>"u"){o.postMessage(!1);break}S({...t,isPrivate:o.isPrivate}),o.postMessage(!0);break;case"open":Array.isArray(t.url)||(t.url=[t.url]),t.url.forEach(function(w){if(!(!w||typeof w!="string")){if(t.openShow){const x={id:s.tab.id,url:s.tab.url};le(t,x,!t.nf);return}var E={url:w,active:!t.nf};try{g.create(E)}catch{delete E.openerTabId,g.create(E)}}}),o.postMessage({});break;case"resolve":let d={cmd:"resolved",id:t.id,m:null,params:t.params},j=e.sieve[d.params.rule.id];if(d.params.rule.req_res&&(d.params.rule.req_res=a[d.params.rule.id]),d.params.rule.skip_resolve){d.params.url=[""],o.postMessage(d);return}let H=/([^\s]+)(?: +:(.+)?)?/.exec(t.url);t.url=H[1];let I=H[2]||null;j.res===1&&(d.m=!0,d.params._="",d.params.url=[H[1],I]);let W={method:I?"POST":"GET",headers:{},body:I||void 0};I&&(W.headers["Content-Type"]="application/x-www-form-urlencoded");try{const w=await fetch(t.url,W),E=await w.text();let x;if(/^(image|video|audio)\//i.test(w.headers.get("Content-Type"))){d.m=t.url,d.noloop=!0,console.warn(`${c.name}: rule ${d.params.rule.id} matched against an image file`),o.postMessage(d);return}if(x=w.url,!x){x=E.slice(0,4096);let k=/<base\s+href\s*=\s*("[^"]+"|'[^']+')/.exec(x);k?x=A(t.url,k[1].slice(1,-1).replace(/&amp;/g,"&"),!0):x=t.url}if(j.res===1){d.params._=E,d.params.base=x.replace(/(\/)[^\/]*(?:[?#].*)*$/,"$1"),o.postMessage(d);return}let M=a[d.params.rule.id];M=(Array.isArray(M)?M:[M]).map(k=>{let L=k.source||k;if(L.indexOf("$")===-1)return k;let P=d.params.length;P=Array.from({length:P},(U,$)=>$).join("|");let Y=new RegExp("([^\\\\]?)\\$("+P+")","g");return typeof k=="string"?L.replace(Y,(U,$,D)=>D<d.params.length&&$!=="\\"?$+RegExp.escape(d.params[D]||""):U):RegExp(L.replace(Y,(U,$,D)=>D<d.params.length&&$!=="\\"?$+RegExp.escape(d.params[D]||""):U))});let T=M[0].exec(E);if(T){let k=d.params.rule.loop_param;j.dc&&(k==="link"&&j.dc!==2||k==="img"&&j.dc>1)&&(T[1]=decodeURIComponent(decodeURIComponent(T[1]))),d.m=A(x,T[1].replace(/&amp;/g,"&")),(T[2]&&(T=T.slice(1))||M[1]&&(T=M[1].exec(E)))&&(d.m=[d.m,T.filter((L,P)=>P&&L).join(" - ")])}else console.info(`${c.name}: no match for ${d.params.rule.id}`);o.postMessage(d)}catch(w){console.error(`${c.name}: fetch failed for rule ${d.params.rule.id}`,w)}break;case"toggle":o.postMessage({});break}};v.listen(Q,!0),l.migrateOldStorage(function(){l.get("version",function(r){var s=864e5,n=r.version||{},t=n.lastCheck||0;if(n.current!==c.version){var o=n.current;n={current:c.version,lastCheck:Date.now()+(Math.random()*15|0)*s},console.info(c.name+" has been "+(o?"updated!":"installed!")),l.set({version:n},function(){o?R(!0):N()});return}N(null,function(){e.tls.sieveAutoUpdate&&(t&&Date.now()-t<15*s||fetch(A(`${q}/config/info.json?v=${B()}`,!0)).then(u=>{if(!u.ok)throw new Error(`Network response was not ok: ${u.statusText}`);return u.json()}).then(u=>{t<u.rules_ver_timestamp&&R(),n.lastCheck=Date.now(),l.set({version:n})}).catch(u=>{console.warn(`${c.name}: update check failed!`,u),n.lastCheck=Date.now(),l.set({version:n})}))})})})}export{pe as a,ce as c,se as d,ae as i,le as o,ie as w};
