import{b as h}from"./browser-polyfill-Bo2e-ahS.js";import{r as _e,I as ae,p as b,a as Ge,f as Je,g as bt}from"./env-C8Txkd6L.js";import{d as We,w as yt,i as Et,c as vt,a as jt}from"./background-Dhtn4G4h.js";import{g as xe,s as Ke,a as Rt,b as _t}from"./_storage-DvOIWZ9r.js";import{r as F,H as Ve,C as xt}from"./init-CM239Bla.js";import{u as Ze}from"./util-BGCjUTK8.js";const{createLock:Pt,createLockPool:It}=_e,Ot=typeof navigator<"u"&&/iP(hone|(o|a)d);/.test(navigator.userAgent);function Tt(r){return new Promise((e,t)=>{const s=new FileReader;s.onload=()=>e(s.result),s.onerror=()=>t(s.error||new Error("failed to convert Blob to ArrayBuffer")),s.readAsArrayBuffer(r)})}function ue(r){return new Promise((e,t)=>{r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error||new Error("IDB request failed"))})}function kt({name:r,version:e,onupgradeneeded:t,indexedDB:s=Ct()}){if(!r)throw new Error("missing storage name");if(!s)throw new Error("missing indexedDB");let n,i=0;return{use:o,startTransaction:a};async function o(l){i++,n||(n=c());const d=await n;let p,m;try{m=await l(d)}catch(w){p=w}if(i--,i||(d.close(),n=null),p)throw p;return m}function a(l,d,p){return o(async m=>{const w=m.transaction(l,d),[O]=await Promise.all([p(w),new Promise((A,ce)=>{w.oncomplete=()=>A(),w.onerror=()=>ce(w.error||new Error("IDB transaction failed"))})]);return O})}function c(){return new Promise((l,d)=>{const p=s.open(r,e);p.onerror=()=>d(p.error||new Error("IDB open failed")),p.onsuccess=()=>l(p.result),p.onupgradeneeded=t})}}function St({name:r,conflictAction:e="throw",indexedDB:t}={}){const s=kt({indexedDB:t,name:r,version:1,onupgradeneeded:wt}),n=new Map,i=Pt(),o=It();let a;return c({set:d,delete:p,deleteMany:m,get:ce,getMeta:gt,stackUp:ft,clear:O,clearAll:A});function c(u){for(const[g,f]of Object.entries(u))u[g]=(...R)=>(a||(a=l()),a.then(()=>f(...R)));return u}function l(){return s.startTransaction(["metadata"],"readonly",async u=>{const g=u.objectStore("metadata"),[f,R]=await Promise.all([ue(g.getAllKeys()),ue(g.getAll())]);for(let _=0;_<f.length;_++)n.set(f[_],R[_])})}function d(u,g,f){return i.read(()=>o.write([u],async()=>{const R=n.get(u);if(R){if(e==="throw")throw new Error(`idb-storage key conflict: ${u}`);if(e==="ignore")return R;if(e==="stack")return await Se(u)}typeof g=="function"&&({resource:g,meta:f}=await g()),f||(f={}),f.stack=0,Ot&&g instanceof Blob?(f.blobType=g.type,g=await Tt(g)):f.blobType=null,f.size=g.size||g.byteLength||g.length;const _=Object.assign({},R,f);return await s.startTransaction(["metadata","resource"],"readwrite",W=>{const T=W.objectStore("metadata"),q=W.objectStore("resource");T.put(_,u),q.put(g,u)}),n.set(u,_),_}))}function p(u){return w([u])}function m(u){return w(u)}function w(u,g=!1){return i.read(()=>o.write(new Set(u),async()=>{const f=new Map;await s.startTransaction(["metadata","resource"],"readwrite",R=>{const _=R.objectStore("metadata"),W=R.objectStore("resource");for(let T=0;T<u.length;T++){const q=n.get(u[T]);if(!q)continue;if(g||!q.stack){_.delete(u[T]),W.delete(u[T]),f.set(u[T],null);continue}const le=f.get(u[T])||Object.assign({},q);le.stack--,_.put(le,u[T]),f.set(u[T],le)}});for(const[R,_]of f.entries())_?n.set(R,_):n.delete(R)}))}function O(){return w([...n.keys()],!0)}function A(){return i.write(async()=>{await s.startTransaction(["metadata","resource"],"readwrite",u=>{const g=u.objectStore("metadata"),f=u.objectStore("resource");g.clear(),f.clear()}),n.clear()})}function ce(u){return i.read(()=>o.read([u],async()=>{const g=n.get(u);if(!g)throw new Error(`missing key: ${u}`);const f=await s.startTransaction(["resource"],"readonly",R=>{const _=R.objectStore("resource");return ue(_.get(u))});return g.blobType!=null?new Blob([f],{type:g.blobType}):f}))}function gt(u){return i.read(()=>o.read([u],()=>{const g=n.get(u);if(!g)throw new Error(`missing key: ${u}`);return g}))}function ft(u){return i.read(()=>o.write([u],()=>Se(u)))}async function Se(u){const g=n.get(u);if(!g)throw new Error(`missing key: ${u}`);const f=Object.assign({},g);return f.stack++,await s.startTransaction(["metadata"],"readwrite",R=>{R.objectStore("metadata").put(f,u)}),n.set(u,f),f}function wt(u){u.oldVersion<1&&(u.target.result.createObjectStore("metadata"),u.target.result.createObjectStore("resource"))}}function Ct(){return typeof indexedDB<"u"?indexedDB:typeof webkitIndexedDB<"u"?webkitIndexedDB:typeof mozIndexedDB<"u"?mozIndexedDB:typeof OIndexedDB<"u"?OIndexedDB:typeof msIndexedDB<"u"?msIndexedDB:null}var At={createIDBStorage:St};const Ce=typeof content<"u"&&content.XMLHttpRequest;function Ae(r,e,t=XMLHttpRequest){return new Promise((s,n)=>{const i=new t;i.open("GET",r),i.responseType=e,i.onload=()=>{i.status===200?s(i):n(new Error(`Bad status ${i.status}: ${r}`))},i.onerror=()=>{n(new Error(`Failed to load: ${r}`))},i.ontimeout=()=>{n(new Error(`Connection timeout: ${r}`))},i.send()})}function Mt(r,e){return Ae(r,e).catch(s=>{if(ae)return t();if(Ce)return Ae(r,e,Ce);throw s});function t(){return fetch(r,{mode:"cors",cache:"force-cache"}).then(s=>{if(!s.ok)throw new Error(`Bad status ${s.status}: ${r}`);return s[e]()}).then(s=>({response:s,getResponseHeader:()=>{}}))}}function Lt(r){return new Promise(e=>setTimeout(e,r))}let Qe=[];b.ready().then(()=>{Me(),b.on("change",r=>{r.retryOnFailure!=null&&Me()})});function Me(){Qe=[...Ge(b.get("retryOnFailure"),2)].map(Ut)}function Ut(r){const e=new RegExp(r[0],"i"),t=r[1].split(/\s+/).map(Number);return{rx:e,max:t[0],delay:t[1],exp:t[2]}}async function Dt(r,e){const t=Qe.find(s=>s.rx.test(e));if(t){let s=t.delay;for(let n=0;n<t.max;n++){try{return await r()}catch(i){console.warn(i),console.warn(`try again after ${s}s`)}await Lt(s*1e3),s*=t.exp}}return await r()}b.ready().then(()=>{Ue(),b.on("change",r=>{r.fetchDelay!=null&&Ue()})});const Le=_e.createLockPool({maxActiveReader:3});let B=new Map;function Ue(){const r=new Map;for(const e of Ge(b.get("fetchDelay"))){const[t,s]=e[0].trim().split(/\s+/),n=Number(s)*1e3;r.set(t,{...B.get(t),delayMs:n})}B=r}async function Bt(r,e){const t=new URL(r).origin;return B.has(t)?await Le.write([t],async()=>{const s=(B.get(t).lastFetch||0)+B.get(t).delayMs-Date.now();await qt(s>0?s:0);try{return await e()}finally{B.get(t).lastFetch=Date.now()}}):await Le.read([t],e)}function qt(r){return new Promise(e=>setTimeout(e,r))}const ee=Nt();function Nt(){const r=At.createIDBStorage({name:"image-cache",conflictAction:"stack"});return{add:t,get:s,delete:n,deleteMany:i,clearAll:o,fetchImage:e};async function e(l,d,p,m){return ae?await Je(l,m):await a(l,d,p,m)}function t({url:l,tabId:d,frameId:p,referrer:m}){return r.set(l,async()=>await Bt(l,async()=>{const w=await Dt(()=>e(l,d,p,m),l),O=w.blob;delete w.blob;const A=Object.assign(w,await c(O));return{resource:O,meta:A}}))}function s(l){return r.get(l)}function n(l){return r.delete(l)}function i(l){return r.deleteMany(l)}function o(){return r.clearAll()}async function a(l,d,p,m){const w=await h.tabs.sendMessage(d,{method:"fetchImage",url:l,referrer:m},{frameId:p});if(w.blobUrl){const O=await Mt(w.blobUrl,"blob");w.blob=O.response,delete w.blobUrl,h.tabs.sendMessage(d,{method:"revokeURL",url:w.blobUrl},{frameId:p}).catch(console.error)}return w}async function c(l,d){if(l.type=="image/svg+xml")return{width:0,height:200};let p={width:0,height:0};try{const m=await createImageBitmap(l);m.width&&(p={width:m.width,height:m.height}),m.close()}catch(m){console.error(m,"--",l,"---",d)}return p}}function $t(){const r=new Map;return{add:e,delete:t,toList:s};function e(n){const i=r.get(n);r.set(n,(i||0)+1)}function t(n){const i=r.get(n);i>1?r.set(n,i-1):r.delete(n)}function s(){const n=[];for(const[i,o]of r.entries())for(let a=0;a<o;a++)n.push(i);return n}}let zt=0;async function Xt({type:r,title:e,text:t}){if(r!=="prompt")throw new Error(`Dialog ${r} is not supported`);const{resolve:s,promise:n}=We(),i=zt++,o=c=>{if(c.method==="promptInit"&&c.id===i)return Promise.resolve({title:e,text:t});c.method==="promptResolve"&&c.id===i&&s(c.value)};h.runtime.onMessage.addListener(o);let a;try{return a=await h.windows.create({type:"popup",url:h.runtime.getURL(`src/static/dialog.html?id=${i}`),width:520,height:320}),await Promise.race([n,yt(a.tabs[0].id)])}catch(c){return console.error(c),null}finally{if(h.runtime.onMessage.removeListener(o),a)try{await h.windows.remove(a.id)}catch(c){console.warn(c)}}}function H(r){h.notifications.create({type:"basic",title:"ImageDuke",message:r.message||String(r),iconUrl:"src/static/images/icon48.png"})}function Ft(r){r.message!=="Download canceled by the user"&&(r.args?H(`${String(r.message||r)}
url: ${r.args[0]}
filename: ${r.args[1]}`):H(String(r.message||r)))}const Ht=bt(),be=new Map;h.downloads.onChanged.addListener(Yt);function Yt(r){const e=be.get(r.id);if(!e)return;const t=r.state&&r.state.current,s=r.error&&r.error.current;s?e.q.reject(s):t==="complete"&&(e.completed=!0,e.q.resolve())}function Gt(r,e=!1){const t={q:We()},{blob:s,erase:n,oncomplete:i}=r;delete r.blob,delete r.erase,delete r.oncomplete;let o;if(s?o=a(s):/^data:/.test(r.url)?o=fetch(r.url).then(p=>p.blob()).then(a):o=l().catch(c),t.q.promise.catch(()=>{}).then(d),e)return t.q.promise;return o;function a(p){return t.blobUrl=URL.createObjectURL(p),r.url=t.blobUrl,l().catch(c)}function c(p){throw t.q.reject(p),p}async function l(){const p=await Ht;r.url.startsWith("http")&&r.referrer&&p.name==="Firefox"&&(r.headers||(r.headers=[]),r.headers.push({name:"Referer",value:r.referrer})),delete r.referrer;const m=await h.downloads.download(r);t.id=m,be.set(m,t)}function d(){t.blobUrl&&(URL.revokeObjectURL(t.blobUrl),t.blobUrl=null),t.id&&be.delete(t),t.completed&&n&&h.downloads.erase({id:t.id}).catch(console.error),i&&i()}}class Jt extends SyntaxError{constructor(e,t,s,n){super(`${e} ${t[s]||""} at position ${s}`),this.description=e,this.expression=t,this.position=s,this.noMatch=!!n}}class Wt{constructor(e,t,s){this.e=e,this.rules=t,this.config=s,this.sp=!1,this.lt=!1,this.ch=0,this.i=0,this.branch="",this.level=0,this.nxtOp="",this.opPos=-1}rest(){return this.e.substr(this.i)}eof(){return this.i>=this.e.length}gb(e){e&&(this.sp=this.lt=!1,this.i+=e,this.ch=this.i)}err(e,t){throw new Jt(e||"Unexpected char",this.e,this.i,!!t)}teIdSt(e){const t=this.gtCh();return e=Object.assign(Object.assign({},this.config.identStart),e),!!(e.re&&e.re.test(t)||this.gtCd()>=128&&(!e.re2||e.re2.test(t)))}teIdPt(e){const t=this.gtCh();return e=Object.assign(Object.assign({},this.config.identPart),e),!!(e.re&&e.re.test(t)||this.gtCd()>=128&&(!e.re2||e.re2.test(t)))}gbCh(){return this.sp=this.lt=!1,this.ch=this.i+1,this.e.charAt(this.i++)}gtCh(e){return this.e.charAt(this.i+(e||0))}gtCd(e){return this.e.charCodeAt(this.i+(e||0))}tyCh(e){return e!==this.e.charAt(this.i)?!1:(this.sp=this.lt=!1,this.i++,this.ch=this.i,!0)}gbSp(){let e=!1,t=!1;for(;!this.eof()&&((e=this.teSP())||(t=this.teLT()));)this.i++,this.sp=this.sp||e,this.lt=this.lt||t;return this.sp||this.lt}teSP(e){const t=this.gtCd(e);return t===32||t===9}teLT(e){const t=this.gtCd(e);return t===10||t===13}gbHex(e){let t=0,s=0,n;const i="0123456789abcdef";for(s=0;s<e&&!this.eof()&&(n=i.indexOf(this.gtCh().toLowerCase()),n>=0);++s)this.i++,this.ch=this.i,t=t*16+n;return s!==e&&e!==1/0||!s?null:String.fromCodePoint(t)}gtOp(){if(this.nxtOp&&this.opPos===this.i)return this.nxtOp;const e=this.config.ops;let t=this.e.substr(this.i,this.config.maxOpLen),s=t.length;for(;s>0;){if(t in e&&(!e[t]||this.teSP(s)||this.teLT(s)||this.i+s>=this.e.length))return this.nxtOp=t,this.opPos=this.i,t;t=t.substr(0,--s)}return null}gbOp(e){this.gbSp();const t=this.gtOp();return t&&t in e?(this.gb(t.length),t):null}tySep(e){const t=this.gtCh();return e?t&&e.indexOf(t)>=0?(this.gbCh(),t):this.sp&&e.indexOf(" ")>=0||(this.lt||this.eof())&&e.indexOf(`
`)>=0?!0:e.indexOf("\0")>=0:!1}parseNext(e){const t=this.branch,s=this.level,n=this.i;let i;try{const o=this.moveRule(e);return i=o.pre(this)||this.parseNext(1),this.gbSp(),i=o.post(this,i),this.config.range&&!i.range&&(i.range=[n,this.ch]),i}finally{this.branch=t,this.level=s}}moveRule(e=0){if(typeof e=="string"){if(!(e in this.rules))throw new Error(`No registered label ${e}`);this.branch=e,this.level=0}else e===1&&this.level++;const t=this.rules[this.branch];if(this.level>=t.length)throw this.err("No matching rule",!0);const s=t[this.level];return typeof s=="string"?this.moveRule(s):s}parseMulti(e,t){const s=[];let n,i,o=0,a;do{this.gbSp(),a=this.i;try{if(i=this.parseNext(t),s[o]=i,n=this.tySep(e.separators),e.types&&e.types.indexOf(i.type)<0)return this.err(`Invalid argument type: ${i.type}`)}catch(c){if(c instanceof SyntaxError&&c.noMatch)if(n=this.tySep(e.separators),!n||n===!0){if(!e.trailling&&o>0)return this.err("Expected expression");o>0&&(n=!0);break}else if(e.sparse)s[o]=e.sparse!==!0?e.sparse:null,this.config.range&&s[o]!==null&&(s[o].range=[a,this.eof()&&!this.lt?this.ch:this.i]);else return this.err("Expected expression");else throw c}o++}while(n&&!this.eof()&&o<=e.maxSep);return n&&this.eof()&&!e.trailling?this.err("Expected expression"):((n&&!s.length||s.length===1&&(n||!e.separators)||s.length>1)&&(s.match=!0),s)}}class Kt{constructor(e,t,s,n,i){this.rules=e,this.startBranch=t,this.config={identStart:s||{re:/[$_A-Za-z]/},identPart:n||{re:/[$_0-9A-Za-z]/},maxOpLen:0,range:!!i,ops:{}};for(const o in e)e[o].forEach(a=>{if(typeof a=="string")return;const c=a.register();for(const l in c)l in this.config.ops||(this.config.ops[l]=!!c[l].space,this.config.maxOpLen=Math.max(this.config.maxOpLen,l.length))})}parse(e){const t=new Wt(e,this.rules,this.config);t.gbSp();const s=t.parseNext(this.startBranch);return t.gbSp(),t.eof()?s:t.err()}}class C{constructor(){this.config={}}unwrapMulti(e){e.maxSep=e.separators?typeof e.maxSep>"u"?1/0:e.maxSep:0}addExtra(e,t,s){return e.extra?typeof e.extra=="function"?e.extra(t,s):Object.assign(Object.assign({},e.extra),t):t}register(){return{}}pre(e){return null}post(e,t){return t}}/*!
 * Copyright (c) 2018 Adrian Panella <ianchi74@outlook.com>
 *
 * This software is released under the MIT License.
 * https://opensource.org/licenses/MIT
 */class K extends C{constructor(e){super(),this.config=e}pre(e){const t=[e.i,e.lt,e.sp];if(this.config.test&&!this.config.test.includes(e.gtCh()))return null;try{const s=e.parseNext(this.config.subRules);return this.addExtra(this.config,s,e)}catch{return[e.i,e.lt,e.sp]=t,null}}}class j extends C{constructor(e,t=!1){super(),this.config=e,this.required=t;let s;for(const n in e)s=e[n],s.empty=s.close&&s.empty||!1,s.separators=s.close&&s.separators||"",this.unwrapMulti(s)}register(){return this.config}post(e,t){const s=t.range?t.range[0]:e.i;let n=e.gbOp(this.config);if(this.required&&!n)return e.err(`Expected operator (${Object.keys(this.config).join(",")})`);for(;n;){const i=this.config[n];if(i.ltypes&&i.ltypes.indexOf(t.type)<0)return e.err("Invalid left-hand side");const o=e.parseMulti(i,i.subRules||(i.rasoc?0:1));if(!o.length&&!i.empty)return e.err("Expression expected.");if(delete o.match,i.close&&!e.tyCh(i.close))return e.err("Closing character expected. Found");t=this.addExtra(i,{type:i.type,[i.left||"left"]:t,[i.right||"right"]:i.separators?o:o[0]},e),i.oper&&(t[i.oper]=n),e.config.range&&(t.range=[s,e.ch]),n=i.rasoc?"":e.gbOp(this.config)}return t}}const Y="BinaryExpression",ye="LogicalExpression",et="AssignmentExpression",M="AssignmentPattern",G="ArrayPattern",te="ObjectPattern",D="Literal",Vt="TemplateLiteral",De="TemplateElement",Zt="TaggedTemplateExpression",S="Identifier",Qt="ThisExpression",Ee="ArrayExpression",er="ObjectExpression",U="MemberExpression",Pe="CallExpression",tr="ConditionalExpression",rr="SequenceExpression",re="UpdateExpression",se="UnaryExpression",pe="NewExpression",sr="ExpressionStatement",N="SpreadElement",L="RestElement",nr="ArrowFunctionExpression",J="operator",tt="prefix",Ie="object",v="property",P="expression",ir=P+"s",rt="statement",y="nocomma_expr",de="token";function Oe(r,e,t){const s=e[r].findIndex(n=>n&&n.type===L);return s>=0&&s!==e[r].length-1&&t.err("rest element must be the last"),e}const x={type:Y,oper:J},st=Object.assign(Object.assign({},x),{space:!0}),ne={type:ye,oper:J},nt={type:et,ltypes:[S,U],oper:J,rasoc:!0,subRules:y},or={type:se,oper:J,prefix:tt},it=Object.assign(Object.assign({},or),{isPre:!0}),ar=Object.assign(Object.assign({},it),{space:!0}),ot={type:re,oper:J,prefix:tt,types:[S,U]},cr=Object.assign(Object.assign({},ot),{isPre:!0}),lr={type:Ee,prop:"elements",close:"]",separators:",",sparse:!0,trailling:!0,empty:!0,subRules:Ee},ur={type:"params",prop:"params",close:")",separators:",",trailling:!0,empty:!0,subRules:"bindElem",extra:Oe.bind(null,"params")},Be={type:G,close:"]",prop:"elements",isPre:!0,separators:",",sparse:!0,empty:!0,trailling:!0,subRules:G,extra:Oe.bind(null,"elements")},qe={type:te,close:"}",prop:"properties",isPre:!0,separators:",",empty:!0,trailling:!0,subRules:te,extra:(r,e)=>(r.properties=r.properties.map(t=>{const s=t.type!==S&&t.type!==M?t:{type:"Property",key:t.type===S?t:t.left,value:t,kind:"init",method:!1,shorthand:!0,computed:!1};return t.range&&(s.range=t.range),s}),Oe("properties",r,e))},pr={type:er,prop:"properties",close:"}",separators:",",trailling:!0,empty:!0,subRules:Ie,types:[S,"Property",N],extra:r=>(r.properties=r.properties.map(e=>{const t=e.type!==S?e:{type:"Property",key:e,value:e,kind:"init",method:!1,shorthand:!0,computed:!1};return e.range&&(t.range=e.range),t}),r)},ve={type:"Property",left:"key",right:"value",extra:r=>Object.assign(Object.assign({},r),{key:r.key.type===P?r.key.argument:r.key,kind:"init",method:!1,shorthand:!1,computed:r.key.type===P}),subRules:y},dr={type:rr,prop:ir,separators:","},hr={close:")",subRules:P},Te={type:U,left:Ie,right:v,extra:{computed:!1},subRules:v},at=Object.assign(Object.assign({},Te),{close:"]",extra:{computed:!0},subRules:P}),Ne={type:Pe,left:"callee",right:"arguments",separators:",",close:")",empty:!0,subRules:y};function I(r,e){const t={};Array.isArray(e)||(e=[e]),Array.isArray(r[0])||(r=[r]);for(let s=0;s<e.length;s++)for(let n=0;n<r[s].length;n++)t[r[s][n]]=e[s];return t}class he extends C{constructor(e){super(),this.config=e,e.prop=e.prop||P,this.unwrapMulti(e)}pre(e){const t=e.i,s=this.config,n=e.parseMulti(s,s.subRules||1);if(!n.match)return n.length?n[0]:null;if(delete n.match,!n.length&&(!s.empty||!s.separators))return e.err("Expression expected");const i=this.addExtra(s,{type:s.type,[s.prop]:s.separators?n:n[0]},e);return e.config.range&&(i.range=[t,e.eof()&&!e.lt?e.ch:e.i]),i}}class mr extends C{constructor(e){super(),this.config=Object.assign({firstOp:"?",secondOp:":"},e)}post(e,t){const s=this.config;if(e.gbSp(),!e.tyCh(s.firstOp))return t;const n=e.parseNext(s.subRules||0);if(e.gbSp(),!e.tyCh(s.secondOp))return e.err(`Operator ${s.secondOp} expected, but found`);const i=e.parseNext(s.subRules||0);return this.addExtra(s,{type:s.type,[s.first||"test"]:t,[s.middle||"consequent"]:n,[s.last||"alternate"]:i},e)}}class E extends C{constructor(e){super(),this.config=e,this.preConf={},this.postConf={};let t;for(const s in e)t=e[s],t.close?t.isPre=!0:t.separators=t.empty=void 0,this.unwrapMulti(t),t.isPre?this.preConf[s]=e[s]:this.postConf[s]=e[s]}register(){return this.config}pre(e){const t=e.gbOp(this.preConf);if(!t)return null;const s=this.preConf[t],n=e.parseMulti(s,s.subRules||0);return!n.length&&!s.empty?e.err("Expression expected."):(delete n.match,s.close&&!e.tyCh(s.close)?e.err("Closing character expected. Found"):this.makeNode(t,s.separators||!n.length||!n[0]?n:n[0],e))}post(e,t){const s=this.postConf;let n=null;return e.lt||(n=e.gbOp(s)),n?s[n].types&&s[n].types.indexOf(t.type)<0?e.err(`Invalid argument type: ${t.type}`):this.makeNode(n,t,e):t}makeNode(e,t,s){const n=this.config[e],i=n.type?{type:n.type,[n.prop||"argument"]:t}:t;return n.oper&&(i[n.oper]=e),n.prefix&&(i[n.prefix]=!!n.isPre),this.addExtra(n,i,s)}}class $e extends C{constructor(e){super(),this.config=e||{}}pre(e){const t=this.config;let s;if(!e.teIdSt(t.identStart))return null;for(s=e.gbCh();!e.eof()&&e.teIdPt(t.identPart);)s+=e.gbCh();return t.this&&s==="this"?{type:Qt}:t.literals&&s in t.literals?{type:t.typeLiteral||D,[t.propLiteral||"value"]:t.literals[s],raw:s}:t.reserved&&t.reserved.indexOf(s)>=0?e.err("Invalid reserved identifier"):{type:t.typeIdent||S,[t.propIdent||"name"]:s}}}class V extends C{constructor(e={radix:10,decimal:!0,exp:!0}){if(super(),this.config=e,e.radix<2||e.radix>36)throw new RangeError("Radix out of range");let t=`0-${e.radix<10?e.radix-1:9}`;e.radix>10&&(t+=`A-${String.fromCharCode(64+e.radix-10)}`),e.radix!==10&&(e.decimal=!1,e.exp=!1),this.digits=new RegExp(`[${t}]`,"i"),e.prefix&&(this.prefix=new RegExp(`^${e.prefix}`,"i"))}pre(e){const t=this.config;let s="",n,i="";if(this.prefix){const o=this.prefix.exec(e.rest());if(!o)return null;i=o[0],e.gb(i.length)}for(;this.digits.test(e.gtCh());)s+=e.gbCh();if(t.decimal&&e.gtCh()===".")for(s+=e.gbCh();this.digits.test(e.gtCh());)s+=e.gbCh();if((!s||s===".")&&!i)return e.gb(-s.length),null;if(n=e.gtCh(),t.exp&&(n==="e"||n==="E")){for(s+=e.gbCh(),n=e.gtCh(),(n==="+"||n==="-")&&(s+=e.gbCh());this.digits.test(e.gtCh());)s+=e.gbCh();this.digits.test(e.gtCh(-1))||e.err(`Expected exponent (${s}${e.gtCh()})`)}return s.length?e.teIdSt()?e.err():{type:D,value:t.decimal?parseFloat(s):parseInt(s,t.radix),raw:i+s}:e.err("Invalid number format")}}const me="Unterminated Regular Expression";class gr extends C{constructor(e={}){super(),e.flags=e.flags||"gimuy",this.config=e}pre(e){const t=e.i;if(!e.tyCh("/"))return null;let s,n="",i=!1,o=!1,a="",c;for(;!e.eof();)if(n+=s=e.gbCh(),s==="\\"){if(e.teLT())return e.err(me);n+=e.gbCh()}else{if(e.teLT())return e.err(me);if(i)s==="]"&&(i=!1);else if(s==="/"){o=!0;break}else s==="["&&(i=!0)}if(!o)return e.err(me);for(n=n.substr(0,n.length-1);!e.eof()&&this.config.flags&&this.config.flags.indexOf(e.gtCh())>=0;)a+=e.gbCh();try{c=new RegExp(n,a)}catch(l){return e.err(l.message)}return{type:D,value:c,raw:e.e.substring(t,e.i),regex:{pattern:n,flags:a}}}}class $ extends C{constructor(e={LT:!0,hex:!0,raw:!0}){super(),this.config=e}pre(e){const t=this.config;let s=!1,n="",i=t.unquoted===!1&&t.templateRules?"`":"",o=!1,a,c=e.i,l=!1,d=t.LT;const p=[],m=[],w=[];if(typeof t.unquoted>"u"){if(a=e.gtCh(),t.templateRules&&a==="`")l=!0,d=!0,c++;else if(a!=='"'&&a!=="'")return null;i=e.gbCh()}else t.templateRules&&(l=!0,d=!0);for(;!e.eof();)if(a=e.gbCh(),a===i){o=!0,l&&m.push(Object.assign({type:De,value:{cooked:n,raw:e.e.substring(c,e.i-1)},tail:!0},e.config.range?{range:[c,e.i-1]}:{}));break}else if(l&&a==="$"&&e.tyCh("{")){if(m.push(Object.assign({type:De,value:{cooked:n,raw:e.e.substring(c,e.i-2)},tail:!1},e.config.range?{range:[c,e.i-2]}:{})),n="",p.push(e.parseNext(t.templateRules)),e.gbSp(),!e.tyCh("}"))return e.err('Expected "}" but found ');c=e.i}else if(a==="\\"){const A=e.i-1;if(d&&e.teLT())a=e.gbCh(),a==="\r"&&e.tyCh(`
`);else switch(a=e.gbCh(),a){case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"b":n+="\b";break;case"f":n+="\f";break;case"v":n+="\v";break;case"u":case"x":if(t.hex){if(t.cp&&(s=e.tyCh("{")),a=e.gbHex(s?1/0:a==="u"?4:2),a===null)return e.err("Hexadecimal digit expected");if(s&&!e.tyCh("}"))return e.err("Closing } expected");s=!1}n+=a;break;default:n+=a}w.push({offset:A,length:e.i-A})}else if(t.LT&&e.teLT(-1)){if(!l)return e.err("Invalid line terminator in string");a==="\r"&&e.tyCh(`
`),n+=`
`}else n+=a;if(!o&&!t.unquoted&&e.err("Unclosed quote after "),l)return{type:Vt,quasis:m,expressions:p};const O={type:D,value:n,raw:t.raw?e.e.substring(c,e.i):i+n+i};return t.escapes&&(O.escapes=w),O}}function fr(r,e){return{identStart:r,identPart:e,literals:{true:!0,false:!1,null:null},this:!0}}const wr={type:"Program",prop:"body",extra:{sourceType:"script"},separators:`;
`,sparse:{type:"EmptyStatement"},trailling:!0,empty:!0},br=[{"||":ne},{"&&":ne}],yr=[{"|":x},{"^":x},{"&":x},I(["==","!=","===","!=="],x),I([["<",">","<=",">="],["instanceof","in"]],[x,st]),I(["<<",">>",">>>"],x),I(["+","-"],x),I(["*","/","%"],x)],ie=[new V({radix:16,prefix:"0x"}),new V({radix:8,prefix:"0o"}),new V({radix:2,prefix:"0b"}),new V],z=new j({".":Te,"[":at});function Er(r,e){const t=new $e(fr(r,e)),s=ie.concat([new $({LT:!0,hex:!0,cp:!0,raw:!0,templateRules:P}),t,new E({"[":lr}),new gr,new E({"{":pr})]),n=new E({new:{type:pe,prop:"callee",isPre:!0,space:!0,subRules:pe,extra:a=>(a.callee.type!==Pe?a.arguments=[]:(a.arguments=a.callee.arguments,a.callee=a.callee.callee),a)}}),i=new E({"(":hr}),o=new $e({identStart:r,identPart:e});return{[rt]:[new he(wr),new he({type:sr,prop:P,extra:a=>a.expression.type===D&&typeof a.expression.value=="string"?Object.assign(Object.assign({},a),{directive:a.expression.raw.substring(1,a.expression.raw.length-1)}):a}),P],[P]:[new he(dr),y],[y]:[new j(I(["=","+=","-=","*=","/=","%=",">>=","<<=",">>>=","|=","&=","^="],nt)),new mr({type:tr,subRules:y}),ye],[ye]:[...br.map(a=>new j(a)),Y],[Y]:[...yr.map(a=>new j(a)),se],[se]:[new E(I([["+","-","!","~"],["typeof","void","delete"]],[it,ar])),re],[re]:[new E(I(["++","--"],cr)),new E(I(["++","--"],ot)),U],[U]:[new j({".":Te,"[":at,"(":Ne,"`":{type:Zt,left:"tag",right:"quasi",subRules:"template"}}),n,i,de],[de]:s,[v]:[o],[pe]:[n,new j({"(":Ne}),z,i,de],[Ie]:[new j({":":ve}),new E({"[":{type:P,close:"]",subRules:y}}),...ie,o,new $({LT:!0,hex:!0,raw:!0})],[Ee]:[new E({"...":{type:N,isPre:!0,subRules:y}}),y],template:[new $({LT:!0,hex:!0,raw:!0,unquoted:!1,templateRules:P})],lvalue:[z,t]}}/*!
 * Copyright (c) 2018 Adrian Panella <ianchi74@outlook.com>
 *
 * This software is released under the MIT License.
 * https://opensource.org/licenses/MIT
 */function vr(r,e){const t=new E({"[":Be,"{":qe}),s=new E({"[":Object.assign(Object.assign({},Be),{subRules:"ArrayBind"}),"{":Object.assign(Object.assign({},qe),{subRules:"ObjectBind"})}),n=Object.assign(Object.assign({},Er(r,e)),{bindElem:[new E({"...":{type:L,isPre:!0,subRules:v}}),new j({"=":{type:M,subRules:y}}),s,v],destructuringAssignement:[new j({"=":Object.assign(Object.assign({},nt),{ltypes:void 0})},!0),t],[te]:[new E({"...":{type:L,isPre:!0,subRules:v}}),new K({subRules:"property_with_target"}),new j({"=":{type:M,subRules:y}}),z,v],ObjectBind:[new E({"...":{type:L,isPre:!0,subRules:v}}),new K({subRules:"property_with_target_bind"}),new j({"=":{type:M,subRules:y}}),v],property_with_target:[new j({":":Object.assign(Object.assign({},ve),{subRules:"property_target"})},!0),new E({"[":{type:P,close:"]",subRules:y}}),...ie,new $({LT:!0,hex:!0,raw:!0}),v],property_target:[new j({"=":{type:M,subRules:y}}),t,z,v],property_with_target_bind:[new j({":":Object.assign(Object.assign({},ve),{subRules:"property_target_bind"})},!0),new E({"[":{type:P,close:"]",subRules:y}}),...ie,new $({LT:!0,hex:!0,raw:!0}),v],property_target_bind:[new j({"=":{type:M,subRules:y}}),s,v],[G]:[new E({"...":{type:L,isPre:!0,subRules:v}}),new j({"=":{type:M,subRules:y}}),z,t,v],ArrayBind:[new E({"...":{type:L,isPre:!0,subRules:v}}),new j({"=":{type:M,subRules:y}}),s,v],arrow:[new j({"=>":{type:nr,subRules:y,right:"body",left:"params",extra:i=>(i.params=i.params.type!=="params"?[i.params]:i.params.params,Object.assign(Object.assign({},i),{id:null,generator:!1,expression:!0,async:!1}))}},!0),new E({"(":ur}),v]});return n[y].splice(1,0,new K({subRules:"arrow"})),n[y].splice(0,0,new K({subRules:"destructuringAssignement",test:"[{"})),n}class jr extends Kt{constructor(e,t,s,n){super(vr(t,s),e?P:rt,t,s,n)}}I(["==","!=","===","!=="],x),I(["<",">","<=",">="],st),I(["<<",">>",">>>"],x),I(["+","-"],x),I(["*","/","%"],x);class Rr{evaluate(e,t){return this._eval(e,t||{})}_eval(e,t){try{if(!(e.type in this))throw new Error(`Unsupported expression type: ${e.type}`);return this[e.type](e,t)}catch(s){throw s.node||(s.node=e),s}}_resolve(e,t,s,...n){const i=n.map(o=>(o||void 0)&&this._eval(o,e));return s(...i)}}function X(r,e){return new Error(`Unsuported ${r}: ${e}`)}const ze={"|":(r,e)=>r|e,"^":(r,e)=>r^e,"&":(r,e)=>r&e,"==":(r,e)=>r==e,"!=":(r,e)=>r!=e,"===":(r,e)=>r===e,"!==":(r,e)=>r!==e,"<":(r,e)=>r<e,">":(r,e)=>r>e,"<=":(r,e)=>r<=e,">=":(r,e)=>r>=e,instanceof:(r,e)=>r instanceof e,in:(r,e)=>r in e,"<<":(r,e)=>r<<e,">>":(r,e)=>r>>e,">>>":(r,e)=>r>>>e,"+":(r,e)=>r+e,"-":(r,e)=>r-e,"*":(r,e)=>r*e,"/":(r,e)=>r/e,"%":(r,e)=>r%e,"**":(r,e)=>r**e},Xe={"-":r=>-r,"+":r=>+r,"!":r=>!r,"~":r=>~r,typeof:r=>typeof r,void:r=>{}},k=0,Z=1,Fe=2;class _r extends Rr{lvalue(e,t){return{o:{},m:""}}Literal(e){return e.value}Identifier(e,t){return t[e.name]}ThisExpression(e,t){return t}ArrayExpression(e,t){return this._resolve(t,0,(...s)=>s,...e.elements)}MemberExpression(e,t){return this._member(e,t,s=>s&&s.o[s.m])}_MemberObject(e,t){return this._member(e,t,s=>s)}_member(e,t,s){const n=e.optional||e.shortCircuited;return this._resolve(t,n?Fe+Z:Fe,(i,o)=>n?i===null||typeof i>"u"?s(void 0):e.computed?this._resolve(t,k,a=>s({o:i,m:a}),e.property):s({o:i,m:e.property.name}):s({o:i,m:e.computed?o:e.property.name}),e.object,n||!e.computed?void 0:e.property)}CallExpression(e,t){const s=e.optional||e.shortCircuited,n=(i,o,a)=>{if(!(s&&(o===null||typeof o>"u"))){if(typeof o!="function")throw new TypeError("Callee is not a function");return s?this._resolve(t,k,(...c)=>o.apply(i,c),...e.arguments):o.apply(i,a)}};return this._resolve(t,Z,(i,...o)=>e.callee.type===U?n(i==null?void 0:i.o,i==null?void 0:i.o[i.m],o):n(t,i,o),e.callee.type===U?Object.assign(Object.assign({},e.callee),{type:"_MemberObject"}):e.callee,...s?[]:e.arguments)}ConditionalExpression(e,t){return this._resolve(t,Z,s=>this._eval(s?e.consequent:e.alternate,t),e.test)}SequenceExpression(e,t){return this._resolve(t,k,(...s)=>s.pop(),...e.expressions)}LogicalExpression(e,t){return this._resolve(t,Z,s=>{switch(e.operator){case"||":return s||this._eval(e.right,t);case"&&":return s&&this._eval(e.right,t);case"??":return s??this._eval(e.right,t);case"##":return this._eval(e.right,t);default:throw X(Y,e.operator)}},e.left)}BinaryExpression(e,t){if(!(e.operator in ze))throw X(Y,e.operator);return this._resolve(t,k,ze[e.operator],e.left,e.right)}UnaryExpression(e,t){if(!(e.operator in Xe))throw X(se,e.operator);return this._resolve(t,k,Xe[e.operator],e.argument)}ExpressionStatement(e,t){return this._eval(e.expression,t)}Program(e,t){return this._resolve(t,k,(...s)=>s.pop(),...e.body)}Compound(e,t){return this.Program(e,t)}}const He={"=":(r,e,t)=>r[e]=t,"+=":(r,e,t)=>r[e]+=t,"-=":(r,e,t)=>r[e]-=t,"*=":(r,e,t)=>r[e]*=t,"/=":(r,e,t)=>r[e]/=t,"%=":(r,e,t)=>r[e]%=t,"**=":(r,e,t)=>r[e]**=t,"<<=":(r,e,t)=>r[e]<<=t,">>=":(r,e,t)=>r[e]>>=t,">>>=":(r,e,t)=>r[e]>>>=t,"|=":(r,e,t)=>r[e]|=t,"&=":(r,e,t)=>r[e]&=t,"^=":(r,e,t)=>r[e]^=t},xr={"++":(r,e)=>++r[e],"--":(r,e)=>--r[e]},Pr={"++":(r,e)=>r[e]++,"--":(r,e)=>r[e]--};class Ir extends _r{lvalue(e,t){let s;switch(e.type){case S:return{o:t,m:e.name};case U:if(s=this._MemberObject(e,t),!s)throw new Error("Invalid left side expression");return s;default:throw new Error("Invalid left side expression")}}ArrayExpression(e,t){return this._resolve(t,0,(...s)=>{const n=[];return e.elements.forEach((i,o)=>{if(i&&i.type===N)for(const a of s[o])n.push(a);else i?n.push(s[o]):n.length++}),n},...e.elements.map(s=>(s==null?void 0:s.type)===N?s.argument:s))}ObjectExpression(e,t){const s=[],n=[],i=[],o=[],a=e.properties.map((c,l)=>{let d;if(c.type===N)return s.push(void 0),o.push(l),c.argument;if(c.computed)s.push(void 0),i.push(l),n.push(c.key);else{if(c.key.type===S)d=c.key.name;else if(c.key.type===D)d=c.key.value.toString();else throw new Error("Invalid property");s.push(d)}return c.value});return this._resolve(t,k,(...c)=>(i.forEach(l=>s[l]=c.shift()),c.reduce((l,d,p)=>(o.indexOf(p)>=0?Object.keys(d??{}).forEach(m=>l[m]=d[m]):l[s[p]]=d,l),{})),...n,...a)}TemplateLiteral(e,t){return this._resolve(t,k,(...s)=>s.reduce((n,i,o)=>n+=i+e.quasis[o+1].value.cooked,e.quasis[0].value.cooked),...e.expressions)}TaggedTemplateExpression(e,t){return this.CallExpression({type:Pe,callee:e.tag,optional:e.optional,shortCircuited:e.shortCircuited,arguments:[{type:"ArrayExpression",elements:e.quasi.quasis},...e.quasi.expressions]},t)}TemplateElement(e,t){return e.value.cooked}_assignPattern(e,t,s,n,i){switch(e.type){case G:if(t!=="=")throw new Error("Invalid left-hand side in assignment");if(!Array.isArray(s))throw new Error("TypeError: must be array");for(let c=0;c<e.elements.length;c++)e.elements[c]&&(e.elements[c].type===L?this._assignPattern(e.elements[c].argument,t,s.slice(c),n,i):this._assignPattern(e.elements[c],t,s[c],n,i));break;case te:if(t!=="=")throw new Error("Invalid left-hand side in assignment");if(s===null||typeof s>"u")throw new Error("TypeError: must be convertible to object");const o={};for(let c=0;c<e.properties.length;c++)if(e.properties[c].type===L){const l=Object.keys(s).filter(d=>!(d in o)).reduce((d,p)=>(d[p]=s[p],d),{});this._assignPattern(e.properties[c].argument,t,l,n,i)}else{const l=e.properties[c].computed?this._eval(e.properties[c].key,n):e.properties[c].key.type===D?e.properties[c].key.value:e.properties[c].key.name;o[l]=!0,this._assignPattern(e.properties[c].value,t,s[l],n,i)}break;case"AssignmentPattern":return typeof s>"u"&&(s=this._eval(e.right,i??n)),this._assignPattern(e.left,t,s,n,i);default:const a=this.lvalue(e,n);return He[t](a.o,a.m,s)}return s}AssignmentExpression(e,t){if(!(e.operator in He))throw X(et,e.operator);const s=this._eval(e.right,t);return this._assignPattern(e.left,e.operator,s,t)}UpdateExpression(e,t){const s=e.prefix?xr:Pr;if(!(e.operator in s))throw X(re,e.operator);const n=this.lvalue(e.argument,t);return s[e.operator](n.o,n.m)}UnaryExpression(e,t){if(e.operator==="delete"){const s=this.lvalue(e.argument,t);return delete s.o[s.m]}return super.UnaryExpression(e,t)}NewExpression(e,t){return this._resolve(t,k,(s,...n)=>new s(...n),e.callee,...e.arguments)}}/*!
 * Copyright (c) 2018 Adrian Panella <ianchi74@outlook.com>
 *
 * This software is released under the MIT License.
 * https://opensource.org/licenses/MIT
 */class Or extends Ir{ArrowFunctionExpression(e,t){return(...s)=>{const n=Object.create(t);return this._assignPattern({type:G,elements:e.params},"=",s,n,t),this._eval(e.body,n)}}}const ke={"/":"／","\\":"＼","?":"？","|":"｜","<":"＜",">":"＞",":":"：",'"':"＂","*":"＊","~":"～"};navigator.userAgent.includes("android")&&Object.assign(ke,{";":"；",",":"，","+":"＋","=":"＝","[":"［","]":"］"});const Tr=new RegExp(`[${Sr(Object.keys(ke).join(""))}]+`,"g"),kr=/[\x00-\x1f\x7f-\x9f\u200e\u200f\u202a-\u202e]/g;function Sr(r){return r.replace(/\[|\]/g,"\\$&")}function Cr(r){b.get("escapeZWJ")&&(r=r.replace(/\u200d/g,"")),r=je(r.replace(kr,"").replace(Tr,t=>b.get("escapeWithUnicode")?Array.from(t).map(s=>ke[s]).join(""):"_").replace(/\s+/g," "));const e=b.get("variableMaxLength");return r.length>e&&(r=je(r.slice(0,e))),r}function je(r){return r.replace(/^[\s\u180e]+|[\s\u180e]+$/g,"")}function Ar(r){const e=r.split(/\\|\//g);return e.map((t,s)=>(t=je(t).replace(/^\.+|\.+$/g,n=>"．".repeat(n.length)),b.get("escapeFF127")&&(t=t.replace(/%/g,"％"),s<e.length-1&&(t=t.replace(/\./g,"．"))),t)).join("/")}function Mr(r){const e=Lr,t=/\${(.+?)}/g;let s,n=0;const i=[];for(;s=t.exec(r);)s.index!==n&&i.push({type:"static",value:r.slice(n,s.index)}),i.push({type:"variable",value:e(s[1]),raw:s[1]}),n=t.lastIndex;if(n!==r.length){const o=r.slice(n);i.push({type:"static",value:o})}return o=>Ar(i.map(a=>{if(a.type==="static")return a.value;try{return Cr(String(a.value(o)))}catch(c){throw new Error(`Failed to evaluate ${a.raw}: ${c.message}`)}}).join(""))}function Lr(r){const t=new jr().parse(r),s=new Or;return n=>{const i=s.evaluate(t,{Number,String,Math,...n});if(i===void 0)throw new Error("The result is undefined");return i}}const ct=["ase","art","bmp","blp","cd5","cit","cpt","cr2","cut","dds","dib","djvu","egt","exif","gif","gpl","grf","icns","ico","iff","jng","jpeg","jpg","jfif","jp2","jps","lbm","max","miff","mng","msp","nitf","ota","pbm","pc1","pc2","pc3","pcf","pcx","pdn","pgm","PI1","PI2","PI3","pict","pct","pnm","pns","ppm","psb","psd","pdd","psp","px","pxm","pxr","qfx","raw","rle","sct","sgi","rgb","int","bw","tga","tiff","tif","vtf","xbm","xcf","xpm","3dv","amf","ai","awg","cgm","cdr","cmx","dxf","e2d","egt","eps","fs","gbr","odg","svg","stl","vrml","x3d","sxd","v2d","vnd","wmf","emf","art","xar","png","webp","jxr","hdp","wdp","cur","ecw","iff","lbm","liff","nrrd","pam","pcx","pgf","sgi","rgb","rgba","bw","int","inta","sid","ras","sun","tga"];ct.push("jpe","jif","jfi");const Ur=new RegExp("^(.+)(\\.(?:"+ct.join("|")+"))\\b","i");function Dr(r){return`${r.getFullYear()}-${e(r.getMonth()+1)}-${e(r.getDate())} ${e(r.getHours())} ${e(r.getMinutes())} ${e(r.getSeconds())}`;function e(t){return String(t).padStart(2,"0")}}function Br(r){const e=new Date;r.date=e,r.dateString=Dr(e)}function qr(r,e){Object.assign(r,e);var t=new URL(r.url);r.hostname=t.hostname;var s,n,i;if(r.base)s=r.base;else try{s=t.href.match(/([^/]+)\/?$/)[1]}catch{s=b.get("defaultName")}try{[,n,i]=s.match(Ur)}catch{n=s,i=b.get("defaultExt")}r.base=ge(s),r.name=ge(n),r.ext=ge(i),t=new URL(r.pageUrl),r.pageHostname=t.hostname,r.pageName=Nr(t.pathname)}function Nr(r){const e=r.match(/\/([^/]*)\/?$/)[1],t=e.lastIndexOf(".");return t<0?e:e.slice(0,t)}function ge(r){for(;/%[0-9a-f]{2}/i.test(r);)try{r=decodeURIComponent(r)}catch{break}return r}_e.createLock({maxActiveReader:5});async function $r({url:r,env:e,tabId:t,frameId:s,referrer:n,alt:i}){let o;[e,o]=await Promise.all([e||h.tabs.sendMessage(t,{method:"getEnv"}),b.get("useCache")&&ee.fetchImage(r,t,s,n).catch(l=>{throw H(l),l})]),Br(e),qr(e,{url:r,base:o&&o.filename,alt:i});const a=b.get("filePatternStandaloneEnabled")&&e.pageContentType.startsWith("image/")?b.get("filePatternStandalone"):b.get("filePattern"),c=Mr(a)(e);await Gt({url:r,blob:o&&o.blob,filename:c,saveAs:b.get("saveAs"),conflictAction:b.get("filenameConflictAction"),referrer:n,erase:b.get("clearDownloadHistory")==="all"},!0)}const Q=[{id:"wqitem.jd.com",version:"1.0.4",reg:"wqitem.jd.com",url:"wqitem.jd.com.js"},{id:"www.xiaohongshu.com",version:"1.0.26",reg:"www.xiaohongshu.com.*(item|explore)",url:"www.xiaohongshu.com.js"},{id:"product.suning.com",version:"1.0.13",reg:"suning.com",url:"suning.com.js",extras:[{title:"下载评论",fun:"downloadMJX"}]},{id:1,version:"1.9.55",reg:"item.(jkcs|yiyao)?jd.(com|hk)",url:"jd.js",extras:[{title:"下载评论",fun:"downloadMJX"}],clientEnabled:!0},{id:2,version:"1.4.15",reg:"vip.com|vipglobal.hk",url:"vip.js"},{id:"m.1688.com",version:"1.0.5",reg:"m.1688.com",url:"m.1688.js"},{id:3,version:"1.17.1",reg:"detail.1688.com",url:"1688.js",extras:[{title:"下载评论 | Download comments",fun:"downloadMJX"}]},{id:"jinritemai.com",version:"1.0.69",reg:"haohuo.jinritemai.com",url:"jinritemai.com.js"},{id:"etsy.com",version:"1.0.4",reg:"www.etsy.com/(.*/)?listing/\\d+",url:"etsy.com.js"},{id:4,version:"1.3.6",reg:"mp.weixin.qq.com/s",url:"mpweixin.js"},{id:5,version:"1.6.3",reg:"toomics.com|toomics.site|toomics.net",url:"toomics.js"},{id:"toomics.com",version:"1.6.1",reg:"toomics.com|toomics.site|toomics.net",url:"toomics.js"},{id:6,version:"1.6",reg:"ac.qq.com",url:"acqq.js"},{id:7,version:"1.5.50",reg:"www.amazon\\.",url:"amazon.js",extras:[{title:{zh:"下载评论",default:"Download comments"},fun:"downloadMJX"}]},{id:8,version:"1.1.4",reg:"meiwu.co|huaban.com|huabanpro.com",url:"huaban.js"},{id:9,version:"1.2.6",reg:"yupoo.com",url:"yupoo.js"},{id:10,version:"1.4",reg:"www.wish.com",url:"wish.js"},{id:11,version:"1.5.33",reg:"aliexpress\\.",url:"aliexpress.js",extras:[{title:{zh:"下载评论",default:"Download comments"},fun:"downloadMJX"}]},{id:12,version:"1.1",reg:"trgomania.com",url:"trgomania.js"},{id:13,version:"1.8.30",reg:"toptoon.net",url:"toptoon.js"},{id:14,version:"1.0",reg:"\\.airbnb\\.",url:"airbnb.js"},{id:15,version:"1.1",reg:"\\.booking\\.",url:"booking.js"},{id:16,version:"1.18",reg:"hotels.ctrip.com",url:"ctrip.js",extras:[{title:"下载评论",fun:"downloadMJX"}]},{id:17,version:"1.6",reg:"www.agoda.com",url:"agoda.js"},{id:18,version:"1.0",reg:"www.uootu.com",url:"uootu.js"},{id:19,version:"1.1.4",reg:"image.baidu.com",url:"baidu.js"},{id:20,version:"1.2.48",reg:"www\\.google\\..*/search\\?",url:"google.js"},{id:21,version:"1.9.2",reg:"^https?://www.pinterest",url:"pinterest.js"},{id:22,version:"1.3.49",updateDesc:"添加了一键下载评论晒图",reg:"^https?://item.taobao.com|m.taobao.com/.*detail.htm",url:"taobao.js",extras:[{title:"下载评论图片",fun:"downloadMJX"}]},{id:23,version:"1.3.44",updateDesc:"添加了一键下载评论晒图",reg:"detail.(m.)?(?:tmall|liangxinyao).(?:com|hk)",url:"tmall.js",extras:[{title:"下载评论图片",fun:"downloadMJX"}]},{id:"traveldetail.fliggy.com",version:"1.0.6",reg:"fliggy.com",url:"fliggy.js"},{id:"www.americanas.com.br",version:"1.0.1",reg:"americanas.com.br/produto",url:"www.americanas.com.br.js"},{id:24,version:"1.22",reg:"^https?://www.aihuishou.com",url:"aihuishou.js"},{id:25,version:"1.6.9",reg:"^https?://yande.re",url:"yande.js"},{id:26,version:"1.5.6",reg:"^https?://beta.sankakucomplex.com",url:"sankakucomplex.js"},{id:28,version:"1.0.11",reg:"www.vvic.com/item/",url:"vvic-item.js"},{id:"17zwd.com",version:"1.0.12",reg:"17zwd.com/item",url:"17zwd.com.js"},{id:30,version:"1.2.4",reg:"yangkeduo.com/(goods\\d?.html|goods_comments.html|mall_certificates.html)|pinduoduo.com\\/goods.html\\?.*goods_id=\\d+",url:"pinduoduo.js",extras:[{title:"下载评论图片、视频",fun:"downloadMJX"}]},{id:"mms.pinduoduo",version:"1.0.12",reg:"mms.pinduoduo.com/chat-merchant/index.html|mms.pinduoduo.com/chat-windows/index.html",url:"mms.pinduoduo.js"},{id:31,version:"1.0.49",reg:"weibo.com",url:"weibo.js"},{id:32,version:"1.0.3",reg:"(cn|www).bing.com/images/search",url:"bing.js"},{id:33,version:"1.0.5",reg:"www.cnu.cc/works/\\d+",url:"cnu.cc.js"},{id:"instagram.com",version:"1.0.36",reg:"instagram.com",url:"instagram.js",funlist:[{funId:"add-download-btn",desc:"Show a download button for images and videos",enabled:!0},{funId:"download-by-double-click",desc:"Download the single image by double click",enabled:!0}]},{id:"tu.heiguang.com",version:"1.0.0",reg:"tu.heiguang.com/works/show_\\d+\\.html",url:"tu.heiguang.com.js"},{id:"tuchong.com",version:"1.0.1",reg:"tuchong.com/\\d+/\\d+/|.+\\.tuchong\\.com/\\d+",url:"tuchong.com.js"},{id:"www.poco.cn",version:"1.0.0",reg:"www.poco.cn/works/detail",url:"www.poco.cn.js"},{id:"www.dhgate.com",version:"1.0.28",reg:"www.dhgate.com/.*product",url:"www.dhgate.com.js",extras:[{title:"下载评论",fun:"downloadMJX"}]},{id:"www.alibaba.com",version:"1.0.35",reg:"www.alibaba.com/product-detail/|alibaba.com/product",url:"alibaba.js",extras:[{title:"下载评论 | Download comments",fun:"downloadMJX"}]},{id:"youzan.com",version:"1.0.12",reg:"shop\\d+.youzan.com/v\\d+/goods|youzan.com.*/detail/",url:"youzan.com.js"},{id:"kaola.com",version:"1.0.3",reg:"goods.kaola.com(.hk)?/product/\\d+.html",url:"kaola.com.js"},{id:"yandex.ru",version:"1.0.6",reg:"yandex.ru/images/search",url:"yandex.ru.js"},{id:"www.tujia.com",version:"1.0.1",reg:"www.tujia.com/detail/\\d+.htm",url:"tujia.com.js"},{id:"www.kidsfootlocker.com",version:"1.0.1",reg:"www.kidsfootlocker.com/product",url:"kidsfootlocker.com.js"},{id:"zh.ifixit.com-store",version:"1.0.7",reg:"zh.ifixit.com/Store",url:"ifixit.store.js"},{id:"manga.bilibili",version:"1.0.5",reg:"manga.bilibili.com",url:"bilibili.js"},{id:"manhua.dmzj.com",version:"1.0.19",reg:"(www|manhua).dmzj1?.com",url:"manhua.dmzj.com.js"},{id:"pop-fashion.com",version:"1.0.2",reg:"www.pop-fashion.com/details/report|www.popfashioninfo.com/details",url:"pop-fashion.js"},{id:"haohaozhu.cn",version:"1.0.0",reg:"haohaozhu.cn/tupian",url:"haohaozhu.cn.js"},{id:"www.konami.com",version:"1.0.7",reg:"www.konami.com/yugioh/duel_links/",url:"www.konami.com.js"},{id:"www.techuangyi.com",version:"1.0.1",reg:"www.techuangyi.com",url:"www.techuangyi.com.js"},{id:"book.yunzhan365.com",version:"1.0.8",reg:"yunzhan365.com",url:"book.yunzhan365.com.js"},{id:"62591.mofa.ht",version:"1.0.3",reg:"62591.mofa.ht/catalog/product/",url:"62591.mofa.ht.js"},{id:"poshmark.com",version:"1.0.2",reg:"poshmark.com/listing",url:"poshmark.js"},{id:"www.farfetch.cn",version:"1.0.10",reg:"www.farfetch.cn",url:"farfetch.js"},{id:"hathitrust",version:"1.0.7",reg:"hathitrust.org",url:"hathitrust.js"},{id:"shein.com",version:"1.0.5",reg:"shein.com",url:"shein.js"},{id:"konachan.wjcodes.com",version:"1.0.7",reg:"konachan.wjcodes.com",url:"konachan.wjcodes.com.js"},{id:"360msl.com",version:"1.0.1",reg:"360msl.com/article-view-\\d+.htm",url:"360msl.com.js"},{id:"ygo.163.com",version:"1.0.6",reg:"ygo.163.com",url:"ygo.163.com.js"},{id:"lazada.com.my",version:"1.0.26",reg:"www\\.lazada\\..*/products",url:"lazada.com.my.js"},{id:"shopee.tw",version:"1.0.53",reg:"shopee|xiapibuy.com",url:"xiapi.js"},{id:"twitter",version:"1.0.3",reg:"twitter.com",url:"twitter.com.js"},{id:"bigbigwork.com",version:"1.0.2",reg:"www.bigbigwork.com",url:"bigbigwork.com.js"},{id:"coupang.com",version:"1.0.3",reg:"www.coupang.com",url:"coupang.com.js"},{id:"www.zalando.it",version:"1.0.1",reg:"www.zalando.it",url:"zalando.js"},{id:"romwe.com",version:"1.0.2",reg:"romwe.com",url:"romwe.js"},{id:"zaful.com",version:"1.0.3",reg:"zaful.com",url:"zaful.js"},{id:"18comic.vip",version:"1.0.18",reg:"18comic.vip",url:"18comic.vip.js"},{id:"moooi.com",version:"1.0.1",reg:"www.moooi.com",url:"moooi.com.js"},{id:"www.patreon.com",version:"1.0.2",reg:"www.patreon.com",url:"www.patreon.com.js"},{id:"www.depop.com",version:"1.0.4",reg:"www.depop.com",url:"www.depop.com.js"},{id:"baidu.com-ds",version:"1.0.3",reg:"baidu.com/site/",url:"baidu.com-ds.js"},{id:"dangdang.com",version:"1.0.4",reg:"dangdang.com",url:"dangdang.com.js"},{id:"17qcc.com",version:"1.0.1",reg:"17qcc.com",url:"17qcc.com.js"},{id:"inongjia.net",version:"1.0.2",reg:"inongjia.net",url:"inongjia.js"},{id:"behance.net",version:"1.0.6",reg:"www.behance.net",url:"behance.net.js"},{id:"xrksw.com.cn",version:"1.0.2",reg:"xrksw.com.cn",url:"xrksw.com.cn.js"},{id:"lianty.com",version:"1.0.5",reg:"lianty.com.*details",url:"lianty.com.js"},{id:"qzone.qq.com",version:"1.0.11",reg:"user.qzone.qq.com",url:"qzone.qq.com.js"},{id:"iherb.com",version:"1.0.3",reg:"iherb.com",url:"iherb.js"},{id:"www.walmart.com",version:"1.0.8",reg:"www.walmart.com",url:"www.walmart.com.js"},{id:"www.tujidao.com",version:"1.0.1",reg:"www.tujidao.com|www.tujidao\\d+.com",url:"tujidao.js"},{id:"mangaraw.co",version:"1.0.1",reg:"mangaraw.co",url:"mangaraw.co.js"},{id:"zhiyitech.cn",version:"1.0.7",reg:"zhiyitech.cn",url:"zhiyitech.cn.js"},{id:"chanmama.com",version:"1.0.16",reg:"chanmama.com",url:"chanmama.com.js"},{id:"www.qoo10.jp",version:"1.0.10",reg:"www.qoo10.jp/item",url:"www.qoo10.jp.js"},{id:"www.ebay.com",version:"1.0.0",reg:"www.ebay.com/itm",url:"www.ebay.com.js"},{id:"www.temu.com",version:"1.0.9",reg:"www.temu.com/.*\\.html",url:"www.temu.com.js"},{id:"bcy.net",version:"1.0.1",reg:"bcy.net",url:"bcy.net.js"},{id:"gdgpo.czt.gd.gov.cn",version:"1.0.4",reg:"gdgpo.czt.gd.gov.cn",url:"gdgpo.czt.gd.gov.cn.js"},{id:"www.xiaohongshu.com/goods-detail",version:"1.0.3",reg:"www.xiaohongshu.com/goods-detail",url:"www.xiaohongshu.com-good.js"},{id:"im.jinritemai.com",version:"1.0.69",reg:"im.jinritemai.com",url:"im.jinritemai.com.js"},{id:"sycm.taobao.com",version:"1.0.17",reg:"sycm.taobao.com",url:"sycm.taobao.com.js"},{id:"www.facebook.com",version:"1.0.88",reg:"www.facebook.com",url:"www.facebook.com.js"}];async function lt(r,e,t,s,n){const i=[{id:r,action:{type:"modifyHeaders"},condition:{urlFilter:s,resourceTypes:["main_frame","sub_frame","stylesheet","script","image","font","object","xmlhttprequest","ping","csp_report","media","websocket","webtransport","webbundle","other"]}}];i[n]=[{header:e,operation:"set",value:t}],await chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[r],addRules:i})}async function zr(r){const e=r.tabUrl,t=["twitter.com.js","amazon.js"],s=["www.konami.com.js","ygo.163.com.js"];for(let n=0;n<Q.length;n++)if(e.match(Q[n].reg)){const i=Q[n].url;t.indexOf(i)>-1&&await Re(r.tabId,"lib/jquery.min.js"),s.indexOf(i)>-1&&await Re(r.tabId,"lib/dom-to-image.min.js");break}h.tabs.sendMessage(r.tabId,{method:"askAiScriptImgs"})}async function Re(r,e){await h.scripting.executeScript({target:{tabId:r,allFrames:!0},files:[e]}),await h.scripting.executeScript({target:{tabId:r,allFrames:!0},func:()=>{window.aiparser&&window.aiparser()}})}h.runtime.onMessage.addListener((r,e,t)=>{switch(r.cmd){case"NET":return Gr(r).then(t),!0;case"SET_GROUPS":Yr(r,e);break;case"ADD_IMG_LIST":Hr(r,e);break;case"ADD_CROSS_DOMAIN":Fr(r);break;case"COLLECT_COMPLETED":break;case"OPEN-OUTPUT":break;case"SUPPORT_COLLECT_PAUSE":break;case"SILENT_DOWNLOAD":break;case"SET_PAGE_INFO":break;case"ADD_IMG":oe(r,e.tab.id,e.frameId);break;case"DOWNLOAD_BY_DRAG":break;case"SET_HEADERS":return Xr(r).then(t),!0;case"ADD_VIDEO":oe(r,e.tab.id,e.frameId);break;case"GET_CURRENT_TAB_IMAGE":break;case"SET_EXTRA_INFO":break;case"CMD_GET_SCRIPT":return Jr(e).then(t),!0}});async function Xr(r){const e=[];for(let t=0;t<r.headers.length;t++){const s=r.headers[t],n=s.name,i=s.value;for(let o of e){const a=Ze(o)+t;lt(a,n,i,o,"requestHeaders")}}}async function Fr(r){const e="access-control-allow-origin",t=r.domain.domain,s=r.domain.requetUrlReg,n=Ze(s);lt(n,e,t,s,"responseHeaders")}async function Hr(r,e){const t=e.tab.id;oe(r,t,e.frameId)}async function Yr(r,e){oe(r,e.tab.id)}async function Gr(r){const e=r.settings.url;let t={};try{const s=await fetch(e);s.ok?t={status:"ok",data:await s.text()}:t={status:"error"}}catch{t={status:"error"}}return t}async function Jr(r){let e,t="";try{if(e=Q.find(s=>{let n=r.tab&&r.tab.url||null;return n&&n.match(s.reg)}),e){const n="aiscriptsfn/"+e.url;Re(r.tab.id,n),t="isolated world ai script injected"}}catch(s){console.error(s)}return t}function Wr(){h.runtime.onConnect.addListener(Kr)}function Kr(r){r.name=="ui"&&r.onMessage.addListener(e=>{Vr(e,r)})}async function Vr(r,e){switch(r.type){case"uiInit":const t=h.runtime.getURL("src/static/uiframe.html?tabid="+e.sender.tab.id+"&batchId="+r.batchId);await h.scripting.executeScript({target:{tabId:e.sender.tab.id},func:Et,args:[t]});break;case"callTab":Zr(r,e),r.cmd==="initLoop"&&zr(r);break;case"delReqTabs":es(r.batchId);break}}const fe={};function Zr(r,e){const t=r.tabId,s=fe[t];let n=s?s[0]:null;const i=`bg_${t}`;return(!n||!n.sender||n.error)&&(n=h.tabs.connect(t,{name:i}),n.onMessage.addListener(o=>{e.postMessage(o)}),fe[t]=[n,e]),n.postMessage(r),n.onDisconnect.addListener(()=>{const o=n.name.split("_")[1];delete fe[parseInt(o)]}),n}async function oe(r,e,t){function s(i,o){i&&h.tabs.sendMessage(i,o)}r.imageTabId=e,r.senderFrameId=t,r.method="callUI";const n=await xe(F);for(let i in n){let o;const a=n[i].reqTabs;for(let c in a)a[c].id==e&&(o=n[i].downloaderTabId,s(o,r))}}async function Qr(r,e){return await h.tabs.sendMessage(r.to,r)}async function es(r){let e=await xe(F);e&&(delete e[[r]],Ke(F,e,1e3*60*10))}Wr();const ts={PICK_FROM_CURRENT_TAB:{label:h.i18n.getMessage("commandPickFromHighlightedTab"),handler:pt,id:"commandPickFromHighlightedTab"},PICK_FROM_RIGHT_TABS:{label:h.i18n.getMessage("commandPickFromRightTabs"),handler:dt,id:"commandPickFromRightTabs"},PICK_FROM_RIGHT_TABS_EXCLUDE_CURRENT:{label:h.i18n.getMessage("commandPickFromRightTabsExcludeCurrent"),handler:ss,id:"commandPickFromRightTabsExcludeCurrent"}},we=new Map;function rs(r){return(...e)=>{try{const t=r(...e);return!t||!t.catch?t:t.catch(s=>{throw console.error(s),s})}catch(t){throw console.error(t),t}}}h.runtime.onMessage.addListener(rs((r,e,t)=>{switch(r.method){case"closeTab":return r.tabId||(r.tabId=e.tab.id),ns(r);case"cacheImage":return ee.add(r).then(n=>{const i=we.get(r.batchId);return i.cachedImages||(i.cachedImages=$t()),i.cachedImages.add(r.url),n});case"getBatchData":return Promise.resolve(we.get(r.batchId));case"notifyError":return H(r.error);case"fetchImage":return Je(r.url).then(n=>(ae&&n.blob&&(n.blobUrl=URL.createObjectURL(n.blob),delete n.blob),n));case"revokeURL":return URL.revokeObjectURL(r.url);case"openDialog":return Xt(r);case"getCacheURL":return ee.get(r.url).then(n=>URL.createObjectURL(n));case"singleDownload":return r.tabId=e.tab.id,r.frameId=e.frameId,$r(r).catch(Ft),!1;case"batchDownloaderRMcachedImages":const{cachedImages:s}=we.get(r.batchId);return s.delete(r.url),!1;case"contentScriptMsgBridge":return Qr(r,e).then(n=>t(n)),!0;case"batchDownload":return pt(),!1;case"setEnable":return mt(r.enable),!1}}));b.ready().then(()=>{r(),b.on("change",e=>{e.browserAction&&r()});function r(){h.action.setTitle({title:ts[b.get("browserAction")].label})}});ee.clearAll();function ut(){return b.get("collectFromFrames")?h.permissions.request({permissions:["webNavigation"]}).then(r=>{if(!r)throw new Error("webNavigation permission is required for iframe information")}):Promise.resolve()}async function pt(r){try{await ut();const e=await h.tabs.query({currentWindow:!0,highlighted:!0});r||(r=e[0]),await ht(e,r)}catch(e){console.warn(e)}}function dt(r,e=!1){ut().then(()=>h.windows.get(r.windowId,{populate:!0})).then(({tabs:t})=>{const s=t.filter(n=>n.index>r.index&&!n.discarded&&!n.pinned&&!n.hidden);return e||s.push(r),s}).then(t=>ht(t,r)).catch(H)}function ss(r){return dt(r,!0)}async function ht(r,e){is();const s=Math.floor((1+Math.random())*65536).toString(16).substring(1),n={url:`${Ve}/images.html?id=${s}`,openerTabId:e.id};ae&&(n.index=e.index+1);const i=await vt(n);let o=await xe(F);o||(o={}),o[[s]]={reqTabs:r,downloaderTabId:i},Ke(F,o,1e3*60*10)}function ns({tabId:r,opener:e}){e&&h.tabs.update(e,{active:!0}),h.tabs.remove(r)}chrome.runtime.onInstalled.addListener(function(r){r.reason==="install"&&chrome.tabs.create({url:`${Ve}/welcome.html`})});async function is(){let r=[];try{r=await fetch(`${xt}/config/net_request_rules.json?_=${Date.now()}`).then(e=>e.json()),chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:r.map(e=>e.id)}).then(()=>{chrome.declarativeNetRequest.updateSessionRules({addRules:r})})}catch{}}jt();async function mt(r){let e=await Rt("enableBigImgPreview");e===void 0&&(e=!0),r!==void 0&&(e=r),_t("enableBigImgPreview",e),e?(chrome.action.setIcon({path:chrome.runtime.getURL("src/static/images/icon32.png")}),Ye(!0)):(chrome.action.setIcon({path:chrome.runtime.getURL("src/static/images/icon32-gray.png")}),Ye(!1))}function Ye(r){chrome.tabs.query({},function(e){e.forEach(function(t){chrome.tabs.sendMessage(t.id,{method:"setBigImgPreviewEnable",enable:r})})})}(async function(){mt()})();
