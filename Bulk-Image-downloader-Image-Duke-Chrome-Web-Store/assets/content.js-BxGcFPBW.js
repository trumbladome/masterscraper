import{b as h}from"./browser-polyfill-Bo2e-ahS.js";import{g as j,a as C}from"./_storage-DvOIWZ9r.js";import{r as N,a as G}from"./init-CM239Bla.js";import{a as E,s as A,b as H,c as M,t as x,d as V}from"./utils-DTD3pljs.js";import{u as L}from"./utils-CESnkRw-.js";async function T(t,s){const n=E(),m=await j(N);if(!m)return;const u=m[n].reqTabs;for(const l of u){const e=Object.assign({type:"callTab",tabId:l.id,tabUrl:l.url},s);t.postMessage(e)}}function D(t,s){const m=Object.values(s).filter(e=>{if(t.group.size.checked){const{min:d,max:g,ignore:y}=t.size;return e.size?!(Number(d.value)&&Number(d.value)>e.size||Number(g.value)&&Number(g.value)<e.size):!y.checked}else return!0}).filter(e=>{if(t.group.dimension.checked){const{width:d,height:g,ignore:y}=t.dimension;return e.width&&(Number(d.min.value)&&Number(d.min.value)>e.width||Number(d.max.value)&&Number(d.max.value)<e.width)||e.height&&(Number(g.min.value)&&Number(g.min.value)>e.height||Number(g.max.value)&&Number(g.max.value)<e.height)?!1:e.width&&e.height?!0:!y.checked}else return!0}).filter(e=>{if(t.type.all.checked||!t.group.type.checked)return!0;if(e.type){const{jpeg:d,png:g,bmp:y,webp:o,gif:r}=t.type;return!!((e.type==="image/jpeg"||e.type==="image/jpg")&&d.checked||e.type==="image/png"&&g.checked||e.type==="image/bmp"&&y.checked||e.type==="image/webp"&&o.checked||e.type==="image/gif"&&r.checked)}else return!1}).filter(e=>t.group.regexp.checked?new RegExp(t.regexp.input.value).test(e.src):!0).filter(e=>t.group.blacklist.checked?!t.blacklist.input.value.split(/\s*,\s*/).map(g=>g.toLowerCase()).filter(g=>g).some(g=>e.src.toLowerCase().indexOf(g)!==-1):!0).filter(e=>$(e,t)),u=m.map(e=>e.key);return m.filter((e,d)=>t.group.identical.checked&&e.key?u.indexOf(e.key)===d:!0)}async function $(t,s){const m=(await j(N))[E()].reqTabs;if(s.save.directory.value=m.length==1?new URL(m[0].url).hostname:G,!s.group.origin.checked)return!0;const u=t.hostname;for(const l of m){const e=new URL(l.url).hostname;return e.endsWith(u)||u.endsWith(e)||u==="local"}return!1}const F=t=>{const s=Object.assign(t,{forIframe:!0});h.runtime.sendMessage(s)},z=t=>{F(t)},W=(t,s,n,m,u)=>{t.onMessage.addListener(l=>{switch(l.cmd){case"appendToLog":M(l.logText);break;case"dl-done":M("download done");break;case"showToast":H(l.title,l.content);break;case"progress":A(s,l);break;case"addParsedPItem":n(l);break;case"startDownload":break;case"iframeResize":document.querySelector(".daimages").style.height=l.nowHeight+"px";break;case"iframeInited":m();break;case"updateImgNaturalSize":u(l);break}})},O=t=>{const s=Date.now(),n=window.confirm(t);return Date.now()-s<10?!0:n},J=(t,s)=>{const n={counter:{filters:document.getElementById("filters"),images:document.getElementById("images-number"),save:document.getElementById("save-number"),total:document.getElementById("total-number"),progress:document.getElementById("progress")},group:{size:document.getElementById("group-size"),dimension:document.getElementById("group-dimension"),zip:document.getElementById("group-zip"),accurate:document.getElementById("accurate"),calc:document.getElementById("calc"),type:document.getElementById("group-type"),regexp:document.getElementById("group-regexp"),blacklist:document.getElementById("group-blacklist"),origin:document.getElementById("group-origin"),identical:document.getElementById("group-identical"),cors:document.getElementById("network-cors"),referer:document.getElementById("network-referer")},files:{mask:document.getElementById("file-mask")},save:{directory:document.getElementById("custom-directory"),format:document.getElementById("format"),filename:document.getElementById("filename"),dialog:document.getElementById("open-save-dialog")},size:{min:document.getElementById("size-min"),max:document.getElementById("size-max"),ignore:document.getElementById("unknown-size-skip")},dimension:{width:{min:document.getElementById("dimension-width-min"),max:document.getElementById("dimension-width-max")},height:{min:document.getElementById("dimension-height-min"),max:document.getElementById("dimension-height-max")},ignore:document.getElementById("unknown-dimension-skip")},type:{jpeg:document.getElementById("type-jpeg"),bmp:document.getElementById("type-bmp"),gif:document.getElementById("type-gif"),png:document.getElementById("type-png"),webp:document.getElementById("type-webp"),all:document.getElementById("type-all"),noType:document.getElementById("no-type")},regexp:{input:document.getElementById("regexp-input")},blacklist:{input:document.getElementById("blacklist-input")},deep:{level:document.getElementById("deep-level")},prefs:{max:document.getElementById("prefs-max-warning"),zip:document.getElementById("prefs-zip-warning")}};n.title=[],n.appendPageTitle=o=>{o&&n.title.push(o)};function m(o,r,c){r.split(" ").forEach(p=>o.addEventListener(p,c,!1))}function u(){const o=["group-size-field","group-dimension-field","group-type-field","group-regexp-field","group-blacklist-field"];for(let r of o){const p=document.querySelector(`#${r}`).querySelectorAll("input"),v=r.replace("-field","");for(let b of p)b.id!=v&&m(b,"change focus",()=>{document.querySelector(`#${v}`).checked=!0})}}u();function l(){const o=n.save.directory.value.replace(/[\\\\/:*?"<>|]/g,"_");let r=L.rename(n.save.filename.value.replace(/\.zip/g,""))+".zip";return r=o?o+"/"+r:r,{filename:r,saveAs:n.save.dialog.checked,get zip(){let c=!n.group.zip.checked;return c===!1&&n.counter.save.value>Number(n.prefs.zip.value)&&(c=O("Downloading more than 15 images separately is not recommended. Should I download them as a ZIP archive?")),c}}}document.addEventListener("click",({target:o})=>{const r=o.dataset.cmd;if((r==="stop"||r==="save"||r==="save-dir")&&(T(t,{cmd:"stop"}),n.counter.progress.dataset.visible=!1,n.counter.progress.parentElement.style.display="none"),r==="save"||r==="save-dir"){document.querySelector("[data-cmd=save]").disabled=!0;const c=Object.assign(l(),{cmd:"save-images",directory:r==="save-dir",mask:n.files.mask.value,noType:n.type.noType.checked}),p=n.counter.save.value,v=()=>{n.counter.progress.dataset.value=0,n.counter.progress.dataset.max=p,z(c)};p>Number(n.prefs.max.value)&&r==="save"?O(`Are you sure you want to download "${p}" images?`)?v():document.querySelector("[data-cmd=save]").disabled=!1:v()}else if(r==="restart")window.location.reload();else if(r==="insert"){const c=o.closest(".list").parentNode.querySelector("input"),p=c.selectionStart,v=c.selectionEnd;c.value=c.value.substring(0,p)+o.dataset.value+c.value.substring(v,c.value.length),c.focus(),c.selectionStart=c.selectionEnd=v+o.dataset.value.length,c.dispatchEvent(new Event("change",{bubbles:!0})),c.dispatchEvent(new Event("input",{bubbles:!0}))}});{const o=document.getElementById("image-types");o.addEventListener("change",()=>{document.getElementById(o.querySelector(":checked")?"type-selection":"type-all").checked=!0})}window.meta=(o,r)=>{images[o]&&Object.assign(images[o],r)};for(const o of[...document.querySelectorAll("[data-href]")])o.hasAttribute("href")===!1&&(o.dataset.href==="debug"?o.href="https://imageduke.com/test-image-downloader/":o.href=h.runtime.getManifest().homepage_url+"#"+o.dataset.href);document.getElementById("options").addEventListener("click",()=>h.runtime.openOptionsPage());const e=()=>{const o=new Date,r=new Date(document.lastModified);let c=!1;performance&&performance.timing&&performance.timing.domInteractive&&(c=new Date(performance.timing.domInteractive)),n.save.filename.value=(n.save.format.value||n.save.format.placeholder).replace("[date]",o.toLocaleDateString()).replace("[current-date]",o.toLocaleDateString()).replace("[time]",o.toLocaleTimeString()).replace("[current-time]",o.toLocaleTimeString()).replace("[modified-date]",r.toLocaleDateString()).replace("[modified-time]",r.toLocaleTimeString()).replace("[navigation-date]",c?c.toLocaleDateString():"NA").replace("[navigation-time]",c?c.toLocaleTimeString():"NA").replace("[title]",n.title.join(",")||"NA")};setTimeout(e,2e3),n.save.format.addEventListener("input",e);const d=async()=>{const o=(()=>{const b=(n.files.mask.value||"[name][extension]").split("[custom=");return b.length===2?b[1].split("]")[0]:""})(),r=n.group.accurate.checked?"accurate":n.group.calc.checked?"partial-accurate":"no-accurate";let c="";const p=await h.storage.local.get({json:{}});v(p);async function v(b){for(const w of Object.keys(b.json))try{if(new RegExp(w).test(args.get("href"))){c=b.json[w];break}}catch{}try{const w={deep:Number(n.deep.level.value),accuracy:r||"partial-accurate",custom:o||"id"};try{c&&typeof c=="string"&&(w.regexp=[new RegExp(c)]),c&&Array.isArray(c)&&(w.regexp=c.map(k=>new RegExp(k)))}catch(k){console.warn("cannot use the provided JSON rules",k)}T(t,{cmd:"initLoop",loopParams:w})}catch(w){console.warn(w),alert(w.message)}}};n.deep.level.addEventListener("change",d);async function g(o){const r=o.res;r.width?(n.dimension.width.min.value=r.width[0],n.dimension.width.max.value=r.width[1],await y("dimension-width-min",r.width[0]),await y("dimension-width-max",r.width[1])):r.height&&(n.dimension.height.min.value=r.height[0],n.dimension.height.max.value=r.height[1],await y("dimension-height-min",r.height[0]),await y("dimension-height-max",r.height[1])),n.group.dimension.checked||(n.group.dimension.checked=!0);const c=new Event("input",{bubbles:!0,cancelable:!0});n.group.dimension.dispatchEvent(c),new Event("change",{bubbles:!0,cancelable:!0})}window.addEventListener("message",function(o){if(o.source==window){var r=o.data;r.cmd==="resolutionRangeSlider"&&g(r)}});async function y(o,r){const c={},p=await h.storage.local.get({persist:c});Object.assign(c,p.persist),c[o]=r,await h.storage.local.set({persist:c})}return n};function K(t){const s={};document.addEventListener("change",async({target:u})=>{const l=await h.storage.local.get({persist:s});Object.assign(s,l.persist);const e=u.id;if(e){if(u.type==="radio"||u.type==="checkbox")s[e]=u.checked,u.type==="radio"&&[...document.querySelectorAll(`input[type=radio][name="${u.name}"]`)].filter(d=>d!==u).forEach(d=>delete s[d.id]);else{let d=u.value;e==="timeout"?(d=Math.min(Math.max(5,d),120),localStorage.setItem("timeout",d)):e==="detection_delay"?(d=Math.max(0,d),localStorage.setItem("pause-detection",d)):e==="download_delay"?(d=Math.max(0,d),localStorage.setItem("pause-download",d)):(e==="prefs-max-warning"||e==="prefs-zip-warning")&&(d=Math.max(5,d)),s[e]=d}x(s),h.storage.local.set({persist:s})}});const n=async()=>{const u=await h.storage.local.get({persist:s});Object.assign(s,u.persist);for(const l of Object.keys(s)){const e=document.getElementById(l);e&&(e.type==="radio"||e.type==="checkbox"?e.checked=s[l]:e.value=s[l])}t.group.accurate.dataset.checked=t.group.accurate.checked,m(),x(s,!0);{const l=t.group.referer.checked?[{operation:"remove",header:"referer"},{operation:"remove",header:"origin"}]:[{operation:"set",header:"referer",value:""}],e=t.group.cors.checked?[{operation:"set",header:"access-control-allow-origin",value:"*"}]:void 0;z({cmd:"updateRequestHeaders",requestHeaders:l,responseHeaders:e,batchId:E()})}};document.readyState!=="loading"?n():document.addEventListener("DOMContentLoaded",async()=>{n()}),document.addEventListener("click",async({target:u})=>{u.dataset.cmd==="reset"&&window.confirm("Are you sure you want to reset all the settings to the defaults?")&&(await h.storage.local.remove("persist"),window.location.reload())});function m(){t.group.size.checked||t.group.zip.checked?(t.group.accurate.dataset.checked=t.group.accurate.checked,t.group.accurate.checked=!0,t.group.accurate.closest("tr").classList.add("disabled")):(t.group.accurate.closest("tr").classList.remove("disabled"),t.group.accurate.checked=t.group.accurate.dataset.checked==="true"),t.group.accurate.dispatchEvent(new Event("change",{bubbles:!0}))}return t.group.size.addEventListener("change",m),t.group.zip.addEventListener("change",m),s}const Z=t=>{let s=0;const n={};let m=[];const u=[],l={width:0,height:0},e=J(t);let d;const g=K(e);e.deep.level.addEventListener("change",()=>{s=0,document.getElementById("deepLevelLabel").innerText=e.deep.level.value});function y(i){let a,f={range:{min:0,max:6e3}};l.width<i.width&&(l.width=i.width,a="width",f.range.max=l.width,window.postMessage({cmd:"resolutionRangeSliderUpdateOption",newOptions:f,target:a},location.href),x(g)),l.height<i.height&&(l.height=i.height,a="height",f.range.max=l.height,window.postMessage({cmd:"resolutionRangeSliderUpdateOption",newOptions:f,target:a},location.href),x(g))}function o(i=!1){e.counter.images.textContent=Object.keys(n).length;const a=D(e,n),f=e.counter.save.value=e.counter.save.textContent=a.length;document.querySelector("[data-cmd=save]").disabled=f===0,document.querySelector("[data-cmd=copy]").disabled=f===0,f===0&&document.querySelector("#downloadBtn").classList.remove("glow-button");let I="fillImage";i&&(I="filterImage"),d&&d.postMessage({cmd:I,updatedImages:a,videos:u})}document.addEventListener("change",()=>{o(!0)});{let i;const a=()=>{window.clearTimeout(i),window.setTimeout(()=>{o(!0)},500)};document.addEventListener("input",a)}const r=i=>{document.getElementById("injectingCollector").style.display="none",i.cmd==="images"?(i.images.filter(a=>a.type.startsWith("image/")).forEach(a=>{if(n[a.src])return;try{a.hostname=new URL(a.src).hostname}catch{}a.hostname=a.hostname||"local";const{filename:f,name:I}=L.guess(a,e.files.mask.value,e.type.noType.checked);a.filename=f,a.size?a.key=I+"."+a.size+"."+a.hostname:a.width&&a.height&&(a.key=I+"."+a.width+"."+a.height+"."+a.hostname),n[a.src]=a,y(a)}),o()):i.cmd==="progress"?A(e,i):i.cmd==="links"?(s+=i.length,e.counter.total.textContent=s,e.counter.progress.dataset.max=s,i.filters&&(e.counter.filters.textContent=` (filters: ${i.filters})`)):i.cmd==="alternative-image-may-work"?(errors+=1,errors===10&&(e.notify.textContent=h.i18n.getMessage("ui_too_many_errors"))):i.cmd==="release"?document.querySelector("[data-cmd=save]").disabled=!1:i.cmd==="pageTitle"?e.appendPageTitle(i.title):i.cmd==="doingDeepSearch"?document.getElementById("ui_doingdeepsearch").style.display="inline":i.cmd==="ADD_IMG_LIST"?(i.cmd="IFRAME_ADD_IMG_LIST",z(i)):i.cmd==="ADD_IMG"?p(i.item):i.cmd==="SET_GROUPS"?(m=i.groups,d&&d.postMessage({cmd:"SET_GROUPS",groups:m})):i.cmd==="ADD_VIDEO"&&(p(i.item),d&&d.postMessage({cmd:"ADD_VIDEO",videos:u}))},c=function(i){const a=i.parsedPItem;p(a)};function p(i){if(i.type=="VIDEO"){u.push(i);return}const a={width:i.width,height:i.height,src:i.bigUrl,alt:"",custom:"",verified:!0,page:i.ref,position:Object.keys(n).length+10001+i.index,hostname:i.site,groupIndex:i.groupIndex,type:`image/${V(i.bigUrl)}`},{filename:f,name:I}=L.guess(a,e.files.mask.value,e.type.noType.checked);a.filename=f,a.size?a.key=I+"."+a.size+"."+a.hostname:a.width&&a.height&&(a.key=I+"."+a.width+"."+a.height+"."+a.hostname),n[a.src]=a,y(a),o()}function v(){return m}function b(){return u}function w(){return D(e,n)}function S(i){d=i}function k(i){const a=i.size,f=n[a.src];f.height=a.height,f.width=a.width}return{cmdFromImageTabDealer:r,elements:e,cmdFromAiScriptUIIframeDealer:c,giveGroups:v,giveVideos:b,giveImages:w,setIframPort:S,updateImgSize:k}},B=h.runtime.connect({name:"ui"}),{cmdFromImageTabDealer:_,elements:P,cmdFromAiScriptUIIframeDealer:Q,giveGroups:R,giveVideos:U,giveImages:X,setIframPort:Y,updateImgSize:q}=Z(B);h.runtime.onConnect.addListener(ee);function ee(t){t.name.indexOf("iframe")>-1&&t.name.split("_")[1]==E()&&(W(t,P,Q,ne,q),document.addEventListener("click",n=>{const{target:m}=n,u=m.dataset.cmd,l={};u==="rename"&&(l.pattern=document.getElementById("pattern").value),t.postMessage({cmd:u,extra:l})}),Y(t),t.postMessage({cmd:"initImgs",data:[X(),R(),U()]}))}B.onMessage.addListener(t=>{_(t)});h.runtime.onMessage.addListener(function(t,s,n){switch(t.method){case"contentScriptMsgBridge":te(t,s,n);break;case"callUI":_(t);break}});function te(t,s,n){switch(t.data.cmd){case"giveMeGroups":n(R());break;case"giveMeVideos":n(U());break}}async function ne(){const t=await C("persist");let s=1;t&&t["deep-level"]&&(s=t["deep-level"]),document.getElementById("deepLevelLabel").innerText=s,P.deep.level.value=s,T(B,{cmd:"initLoop",loopParams:{deep:s}})}async function ae(){[...document.querySelectorAll("[data-i18n]")].forEach(t=>{const s=t.dataset.i18nValue||"textContent";t[s]=h.i18n.getMessage(t.dataset.i18n)}),document.getElementById("injectingCollector").style.display="block",B.postMessage({type:"uiInit",batchId:E()}),document.addEventListener("input",t=>{t.target.dataset.modified=!!t.target.value})}ae();
