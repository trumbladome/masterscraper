import{b as m}from"./browser-polyfill-Bo2e-ahS.js";import{p as h,a as j,f as A,I as R}from"./env-C8Txkd6L.js";import{u as g}from"./utils-CESnkRw-.js";import{a as W,b as T,P as O}from"./item-4mjj-1IM.js";import{H as U}from"./init-CM239Bla.js";const $=/\s*([^,]\S*[^,](?:\s+[^,]+)?)\s*(?:,|$)/,z=(t,e,n)=>{if(t[n]=t[n]||{},t[n][e])throw new Error(`No more than one image candidate is allowed for a given descriptor: ${e}${n}`);t[n][e]=!0},H=t=>{if(t.fallback)throw new Error("Only one fallback image candidate is allowed");if(t.x&&t.x[1])throw new Error("A fallback image is equivalent to a 1x descriptor, providing both is invalid.");t.fallback=!0},N=(t,e)=>{if(e.length===0)H(t);else if(e.length>1)throw new Error(`Image candidate may have no more than one descriptor, found ${e.length}: ${e.join(" ")}`)},q=(t,e,n)=>{if(Number.isNaN(t))throw new TypeError(`${n||t} is not a valid number`);switch(e){case"w":{if(t<=0)throw new Error("Width descriptor must be greater than zero");if(!Number.isInteger(t))throw new TypeError("Width descriptor must be an integer");break}case"x":{if(t<=0)throw new Error("Pixel density descriptor must be greater than zero");break}case"h":throw new Error("Height descriptor is no longer allowed");default:throw new Error(`Invalid srcset descriptor: ${n}`)}};function F(t,{strict:e=!1}={}){const n=e?{}:void 0;return t.replace(/\r?\n/,"").replace(/,\s+/,", ").split($).filter((r,a)=>a%2===1).map(r=>{const[a,...s]=r.trim().split(/\s+/),c={url:a};e&&N(n,s);for(const l of s){const i=l[l.length-1],o=Number.parseFloat(l.slice(0,-1));switch(e&&(q(o,i,l),z(n,o,i)),i){case"w":{c.width=o;break}case"h":{c.height=o;break}case"x":{c.density=o;break}}}return c})}let C=[];E();h.on("change",t=>{t.srcAlternative!=null&&E()});function E(){C=h.get("srcAlternative").split(",").map(t=>t.trim()).filter(Boolean)}function b(t){const e=F(t);if(!e.length)throw new Error(`No rules in srcset: ${t}`);let n;for(const r of e)(!n||(r.density||r.width||0)>(n.density||n.width||0))&&(n=r);return M(n.url)}function I(t){for(const e of C){const n=t.getAttribute(e);if(n)return M(n)}if(t.srcset)try{return b(t.srcset)}catch(e){console.warn(e)}if(t.src)return t.src}function _(t){const e=t.closest("picture");return e?G(e):t.localName==="a"?D(t):I(t)}function*B(){for(const t of document.querySelectorAll('img, input[type="image"], a, picture')){const e=_(t);!e||/^[\w]+-extension/.test(e)||/^about/.test(e)||(yield{src:e,referrerPolicy:t.referrerPolicy,alt:t.alt})}}function D(t){const e=t.href;return h.get("detectLink")&&/^[^?#]+\.(?:jpg|png|gif|jpeg|svg|webp)(?:$|[?#])/i.test(e)&&e}function G(t){const e=t.querySelectorAll("source");let n;for(const a of e)if(!(a.media&&/max-width/.test(a.media))){if(a.media&&/min-width/.test(a.media)){n=a;break}n=a;break}if(n&&n.srcset)try{return b(n.srcset)}catch(a){console.warn(a)}const r=t.querySelector("img");if(r)return I(r);if(e.length){const a=e[e.length-1].srcset;if(a)try{return b(a)}catch(s){console.warn(s)}}}function M(t){return new URL(t,location.href).href}let x=[];h.ready().then(()=>{S(),h.on("change",t=>{t.urlMap!=null&&S()})});function S(){x=[...j(h.get("urlMap"),2)].map(t=>K(...t))}function K(t,e){if(/\$\{[^}]+\}/.test(e)){const r=new RegExp(t,"i"),a=Function(...Z(),`return \`${e}\``);return s=>{const c=s.match(r);return c?a(...c):s}}const n=new RegExp(t,"ig");return r=>r.replace(n,e)}function*Z(){for(let t=0;t<10;t++)yield`$${t}=""`}function X(t){return x.reduce((e,n)=>n(e),t)}const J=()=>{let t;const e={active:!1,feeds:{1:[],2:[],3:[]},"processed-images":[],"raw-images":[],docs:[],cache:new Set,loopParams:{}};e.setActiveStatus=r=>{e.active=r};var n=()=>{e.active&&t({cmd:"progress",value:e.feeds[1].length+e.feeds[2].length+e.feeds[3].length+e["raw-images"].length+e.docs.length})};return e.events={image(r){t({cmd:"images",images:[r]})},feed(r){t({cmd:"links",filters:(e.loopParams.regexp||[]).length,length:r})},document(){n()},validate(){n()},raw(){n()},doingDeepSearch(){t({cmd:"doingDeepSearch"})}},e.meta=async function(r){let a;for(const[c,l]of Object.entries(g.EXTENSIONS))if(r.src.toLowerCase().endsWith("."+c)||r.width&&r.src.toLowerCase().indexOf("."+c)!==-1||r.src.toLowerCase().indexOf("."+c+"?")!==-1||r.src.startsWith("data:image/"+c)){a={meta:{type:l},origin:"guess"};break}const s=[(e.loopParams.accuracy==="accurate"||e.loopParams.accuracy==="partial-accurate")&&!r.width,e.loopParams.accuracy!=="accurate"||r.size];if(a&&s.some(c=>c))return a;if(r.verified===!0)return{};try{const c=await g.response.heads(r.src);return c.type=g.type(a==null?void 0:a.meta,c),{meta:c,origin:"bg.fetch"}}catch(c){console.warn(c)}return{}},e.inspect=function(r,a,s,c){for(const i of[...r.images]){if(!e.active)break;e.push({width:i.naturalWidth,height:i.naturalHeight,src:i.currentSrc||i.src,alt:i.alt,custom:i.getAttribute(e.loopParams.custom)||"",verified:e.loopParams.accuracy!=="accurate",page:a.href,meta:{origin:s+" - document.images",size:"img.element",type:"skipped"}})}for(const i of[...r.querySelectorAll("source")]){if(!e.active)break;i.srcset&&e.push({src:i.srcset.split(" ")[0],type:i.type,page:a.href,meta:{origin:s+" - source.element"}})}for(const i of r.querySelectorAll("svg")){if(!e.active)break;const o=i.cloneNode(!0);o.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.push({src:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(o.outerHTML),type:"image/svg+xml",page:a.href,meta:{origin:s+" - svg.query"}})}const l=i=>{const o=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/ig;return i.match(o)||[]};if(c.bg)try{[...r.querySelectorAll("*")].map(i=>[getComputedStyle(i).backgroundImage,getComputedStyle(i,":before").backgroundImage,getComputedStyle(i,":after").backgroundImage]).flat().filter(i=>i&&i.includes("url(")).map(i=>l(i)).flat().filter(i=>i).forEach(i=>{e.push({src:i,page:a.href,meta:{origin:s+" - link"}})})}catch(i){console.warn("Cannot collect background images",i)}if(e.loopParams.deep>0&&c.links&&[...r.querySelectorAll("a")].map(i=>i.href).forEach(i=>e.push({src:i,page:a.href,meta:{origin:s+" - link.href"}})),e.loopParams.deep>0&&c.extract){e.events.doingDeepSearch();const i=r.documentElement.innerHTML+`

`+r.textContent;l(i).map(o=>o.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/\\+$/,"").split(/['")]/)[0].split("</")[0]).forEach(o=>{e.push({src:o,page:a.href,meta:{origin:s+" - regex.hard-coded.link"}})})}},e.push=function(r){if(r.src){if(e.loopParams.regexp&&e.loopParams.regexp.some(a=>a.test(r.src))===!1)return;r.position=e.position++;try{const a=new URL(r.src,r.page);if(["http:","https:","file:","data:"].some(s=>s===a.protocol)===!1)return;r.src=a.href,e.cache.has(r.src)===!1&&(e.cache.add(r.src),r.width||["bmp","png","gif","webp","jpg","svg","ico"].some(s=>r.src.indexOf("."+s)!==-1||r.src.startsWith("data:image/"+s))?e.feeds[1].push(r):a.origin===location.origin?e.feeds[2].push(r):e.feeds[3].push(r),e.events.feed(1))}catch{console.warn("invalid URL",r)}}},e.addImage=function(r){if((e.loopParams.accuracy==="accurate"||e.loopParams.accuracy==="partial-accurate")&&!r.width){e["raw-images"].push(r),e.head();return}if(!r.type.startsWith("image/")){e["raw-images"].push(r),e.head();return}e["processed-images"].push(r),e.events.image(r)},e.head=async function(){if(e.head.jobs>5||e.active===!1)return;const r=await m.storage.local.get({"head-timeout":30*1e3,"head-delay":100}),a=e["raw-images"].shift();if(a){e.head.jobs+=1;try{const s=await g.response.segment(a.src);a.size=s.size,a.type=g.type(a,s),a.disposition=s.disposition;for(const c of["bmp","png","gif","webp","jpg"])if(type[c](s.segment)){const l=size[c](s.segment);if(l){Object.assign(a,l),a.meta.size="size.js";break}}if(!a.width)throw Error("size detection failed"+a.src)}catch(s){s.message==="STATUS_CODE_403"&&t({cmd:"alternative-image-may-work"}),await new Promise(c=>{const l=new Image;l.onload=()=>{a.width=l.naturalWidth,a.height=l.naturalHeight,a.type=g.type(a,{type:"image/unknown"}),a.meta.size="size.img.element",c()},l.onerror=()=>{a.meta.size="error",c()},l.src=a.src})}a.type.startsWith("image/")&&(e["processed-images"].push(a),e.events.image(a)),setTimeout(()=>{e.head.jobs-=1,e.events.raw(),e.head()},r["head-delay"])}},e.validate=async function(){if(e.validate.jobs>5||e.active===!1)return;const r=e.feeds[1].length?e.feeds[1].shift():e.feeds[2].length?e.feeds[2].shift():e.feeds[3].shift();let a=!1;if(r){e.validate.jobs+=1;try{const{meta:l,origin:i}=await e.meta(r);Object.assign(r,l),r.meta.type=i,r.type&&(r.type.startsWith("image/")||r.type.startsWith("application/")?e.addImage(r):r.type.startsWith("text/html")&&(e.document(r),a=!0))}catch(l){console.warn("cannot validate",r,l)}const s=()=>{e.validate.jobs-=1,e.events.validate(),e.validate()},c=await m.storage.local.get({"validate-delay":100});setTimeout(()=>s(),a?c["validate-delay"]:0)}},e.validate.jobs=0,e.document=function(r){e.active!==!1&&e.loopParams.deep>1&&r.meta.origin.startsWith("one")&&(e.docs.push(r.src),e.dig(),e.dig(),e.dig(),e.dig(),e.dig())},e.dig=async function(){if(e.dig.jobs>5||e.active===!1)return;const r=await m.storage.local.get({"dig-delay":100,"dig-timeout":30*1e3}),a=e.docs.shift();if(a){e.dig.jobs+=1;try{const s=await g.response.text(a);if(s){const l=new DOMParser().parseFromString(s,"text/html"),i=l.createElement("base");i.href=a,l.head.appendChild(i),e.inspect(l,new URL(a),"two",{bg:e.loopParams.deep===3,links:e.loopParams.deep===3,extract:e.loopParams.deep===3}),e.validate(),e.validate(),e.validate(),e.validate(),e.validate()}}catch{}setTimeout(()=>{e.dig.jobs-=1,e.events.document(),e.dig()},r["dig-delay"])}},e.dig.jobs=0,e.loop=async function(r,a){t=r,e.active&&(e.setActiveStatus(!1),await new Promise(s=>setTimeout(s,2e3))),e.setActiveStatus(!0),e.head.jobs=0,e.position=0,a&&(e.loopParams=a),t({cmd:"pageTitle",title:document.title}),e.inspect(document,location,"one",{bg:!0,links:!0,extract:!0}),e.validate(),e.validate(),e.validate(),e.validate(),e.validate()},e};let v,y;const Q=t=>{switch(t.cmd){case"initLoop":y=J(),y.loop(V,t.loopParams);break;case"stop":case"dl-done":y.setActiveStatus(!1);break}};function P(t){t.name.indexOf("bg_")>-1&&(v=t,v.onMessage.addListener(Q))}const V=t=>{v.postMessage(t)};function Y(){m.runtime.onConnect.hasListener(P)||m.runtime.onConnect.addListener(P)}function ee(){window.addEventListener("message",async function(t){if(!(!t.data.identifier||t.data.href!==location.href)&&t.data&&t.data.identifier==="imageDukeContentMainWorldBridge"){t.data.payload.toMainWorldHelper&&te(t.data.payload);const e=await chrome.runtime.sendMessage(t.data);if(!e)return;L(e)}})}function L(t){const e={identifier:"imageDukeContentMainWorldBridgeSendResponse",href:location.href,payload:t};window.postMessage(e,location.href)}function te(t){switch(t.cmd){case"i18nLoad":re(t.msgKeysNeeded);break}}function re(t){const e={};for(const r of t)e[r]=m.i18n.getMessage(r);L({cmd:"i18nLoadSendBack",i18nMsgs:e})}(function(){if(["images.html","show.html"].map(o=>[U,o].join("/")).map(o=>o.replace(/https?:\/\//,"")).some(o=>location.href.includes(o)))return;let n;function r(){window.postMessage({cmd:"CMD_FROM_CT_COLLECT_IMGS"},"*"),setTimeout(r,1e3*15)}m.runtime.onMessage.addListener(o=>{switch(o.method){case"getEnv":return Promise.resolve(c());case"getImages":return Promise.resolve(a());case"fetchImage":return A(o.url,o.referrer).then(f=>(R&&(f.blobUrl=URL.createObjectURL(f.blob),delete f.blob),f));case"revokeURL":return URL.revokeObjectURL(o.url);case"askAiScriptImgs":r();break}});function a(){const o=new Map;for(const{src:f,referrerPolicy:d,alt:p}of B()){const u=X(f),w={url:u,referrer:i(location.href,u,d||l()),alt:p},k=o.get(w.url);k&&s(k,w)>=0||o.set(u,w)}return[...o.values()]}function s(o,f){return d(o.url,f.url)||d(o.referrer,f.referrer)||d(o.alt,f.alt);function d(p,u){return p===u?0:p==null?-1:u==null?1:p<u?-1:p>u?1:0}}function c(){return{pageTitle:document.title,pageUrl:location.href,pageContentType:document.contentType}}function l(){return n===void 0&&(n=document.querySelector('meta[name="referrer"]')||null),n&&n.content||""}function i(o,f,d){return d==="no-referrer"||d==="no-referrer-when-downgrade"&&o.startsWith("https:")&&f.startsWith("http:")?"":o}Y(),ee(),window._config=W,window.bigImgParser=T,window.ParsedPItem=O})();
