import"./modulepreload-polyfill-B5Qt9EMX.js";import{b as E}from"./browser-polyfill-Bo2e-ahS.js";import{g as U}from"./_storage-DvOIWZ9r.js";import{r as V}from"./init-CM239Bla.js";import{P as H,V as z}from"./item-4mjj-1IM.js";import{d as D,p as N,Z as P,n as q}from"./iframeResizer.contentWindow-BYR6LlzI.js";import{g as O}from"./utils-DTD3pljs.js";import{o as G}from"./background-Dhtn4G4h.js";function $(e,u,f){function m(){if(!(l>=e.length)){var d=e[l];l++;var g=setTimeout(function(){m()},3e3);d?typeof d=="string"?new H({src:d},l,u.tab,u.frameId,function(y){T(y,f),l<e.length&&(clearTimeout(g),m())}):d.type=="VIDEO"?new z(d,l,u.tab,u.frameId,function(y){T(y,f),l<e.length&&(clearTimeout(g),m())}):new H(d,l,u.tab,u.frameId,function(y){T(y,f),l<e.length&&(clearTimeout(g),m())}):m()}}e=(e=e.filter(d=>typeof d=="string"&&d||d.src)).filter(function(d){return!!d});for(var l=0,s=0;s<10;s++)m()}function T(e,u){u({cmd:"addParsedPItem",parsedPItem:e})}async function F(e,u,f){const m=await U(V);if(!m)return;const l=m[e.batchId].reqTabs;l.length==1?e.requestHeaders[0].operation=="set"&&(e.requestHeaders[0].value=l[0].url):f({cmd:"showToast",title:"Warning",content:"Batch download mode, can not set fake referer for images."}),E.declarativeNetRequest.updateSessionRules({removeRuleIds:[u],addRules:[{id:u,priority:1,action:{type:"modifyHeaders",requestHeaders:e.requestHeaders,responseHeaders:e.responseHeaders},condition:{resourceTypes:["xmlhttprequest","image"],tabIds:[u]}}]})}async function K(e,u){const f=e.imageTabId,l={tab:await chrome.tabs.get(f),frameId:e.senderFrameId};$(e.list,l,u)}const h=typeof browser>"u"?chrome.i18n.getMessage.bind(chrome.i18n):browser.i18n.getMessage.bind(browser.i18n),B={主图:h("ui_Main_photo"),视频:h("ui_Video"),SKU图片:h("ui_SKU"),详情:h("ui_Detail"),详情Detail:h("ui_Detail"),LIVE:h("ui_LIVE"),图片:h("ui_Picture"),详情图:h("ui_Detail"),Main:h("ui_Main_photo"),Video:h("ui_Video"),SKU:h("ui_SKU"),Detail:h("ui_Detail"),Others:h("ui_Others")};function W(e){[...document.querySelectorAll("[data-i18n]")].forEach(o=>{const a=o.dataset.i18nValue||"textContent";o[a]=E.i18n.getMessage(o.dataset.i18n)});const u=new URLSearchParams(location.search),f=Number(u.get("tabid")),m=document.getElementById("entry"),l=document.getElementById("group"),s=document.querySelector("#body .cateims"),d=o=>{try{o.cmd="showToast",e.postMessage(o)}catch{const n=document.title;document.title=o.content,setTimeout(()=>document.title=n,750)}};function g(o){if(Math.abs(o)<1024)return o.toFixed(1)+" B";const n=["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];let i=-1;do o/=1024,++i;while(Math.abs(o)>=1024&&i<n.length-1);return o.toFixed(1)+" "+n[i]}function y(o,a){const n=document.importNode(l.content,!0);n.querySelector(".groupHolder div").setAttribute("data-group",a);const i=n.querySelector("h3");i.innerHTML=o,s.appendChild(n)}const v=[],_=[],b=[],w=async(o=[],a=[],n=[],i=!1)=>{if(i){s.innerHTML="";const t=document.querySelector('[data-etag="other"]');t.innerHTML="",v.length=0,_.length=0,b.forEach((r,c)=>{y(B[r],c)})}else a.length>0&&a.filter(t=>b.indexOf(t)===-1).forEach((t,r)=>{y(B[t],r),b.push(t)});if(n.length>0){const t=document.getElementById("video");n.filter(r=>_.indexOf(r.originalUrl)===-1).forEach(r=>{const c=document.importNode(t.content,!0),I=c.querySelector("video");I.src=r.originalUrl;const S=document.querySelector('[data-group="'+r.groupIndex+'"]');if(S)S.appendChild(c),S.parentElement.style.display="block";else{const p=document.querySelector('[data-etag="other"]');p.appendChild(c),p.parentElement.style.display="block"}_.push(r.originalUrl)})}o.length>0&&Object.values(o).filter(t=>v.indexOf(`${t.src}-${t.groupIndex}`)===-1).forEach(t=>{const r=document.importNode(m.content,!0),c=r.querySelector("img");c.onerror=()=>{const p=c.parentNode;p.parentNode.removeChild(p)},c.src=t.src,c.dataset.sourcePage=t.page,c.dataset.alt=t.alt,r.querySelector("label").info=t,c.alt=r.querySelector("input[type=text]").value=t.filename;const I=r.querySelector("a");let S=t.size?g(t.size):"";if(t.width&&t.height?(S+=" ("+t.width+"✕"+t.height+")",c.style.height=`${t.height}px`):c.onload=()=>{I.textContent+=" ("+c.naturalWidth+"✕"+c.naturalHeight+")",e.postMessage({cmd:"iframeResize",nowHeight:O()}),e.postMessage({cmd:"updateImgNaturalSize",size:{src:t.src,width:c.naturalWidth,height:c.naturalHeight}})},I.textContent=S,I.href=t.src,t.groupIndex>-1){const p=document.querySelector('[data-group="'+t.groupIndex+'"]');p&&(p.appendChild(r),v.push(`${t.src}-${t.groupIndex}`),p.parentElement.style.display="block")}else{const p=document.querySelector('[data-etag="other"]');p.appendChild(r),v.push(`${t.src}-${t.groupIndex}`),p.parentElement.style.display="block"}}),e.postMessage({cmd:"iframeResize",nowHeight:O()})};e.onMessage.addListener(o=>{const a=o.cmd;if(a==="fillImage"){const n=o.updatedImages,i=o.videos;w(n,[],i)}else if(a==="filterImage"){const n=o.updatedImages,i=o.videos;w(n,[],i,!0)}else if(a=="SET_GROUPS"){const n=o.groups;w([],n,[])}else if(a=="ADD_VIDEO"){const n=o.videos;w([],[],n)}else if(a==="initImgs")w(o.data[0],o.data[1],o.data[2]);else if(a==="select-all")[...document.querySelectorAll(".entry")].forEach(n=>n.querySelector("input[type=checkbox]").checked=!0),document.dispatchEvent(new Event("change"));else if(a==="select-none")[...document.querySelectorAll(".entry")].forEach(n=>n.querySelector("input[type=checkbox]").checked=!1),document.dispatchEvent(new Event("change"));else if(a==="copy"){e.postMessage({cmd:"stop"});const i=[...document.querySelectorAll(".entry :checked")].map(r=>{const c=r.closest("label"),I=c.info,p=c.querySelector("input[type=text]").value;return Object.assign(I,{filename:p,head:!0})}).map(r=>r.src),t=r=>{navigator.clipboard.writeText(r.join(`
`)).catch(c=>alert(c.message))};window.top===window?t(i):E.scripting.executeScript({target:{tabId:f},func:t,args:[i]}),d({title:"Notice",content:i.length+` link${i.length===1?"":"s"} copied to the clipboard`})}});let M;document.addEventListener("click",o=>{const{target:a}=o;if(a.type==="checkbox"&&o.shiftKey&&M){const n=[...document.querySelectorAll(".entry")],i=n.indexOf(a.closest(".entry")),t=n.indexOf(M.closest(".entry"));for(let r=Math.min(i,t)+1;r<Math.max(i,t);r+=1)n[r].querySelector("input[type=checkbox]").checked=!0}if(a.href&&a.href.startsWith("data:")&&navigator.userAgent.indexOf("Firefox")===-1&&(o.preventDefault(),fetch(a.href).then(n=>n.blob()).then(n=>{const i=URL.createObjectURL(n);a.href=i,a.click()})),a.className.indexOf("zoom")!==-1){const n=a.nextElementSibling,i={url:n.src,imgCaption:n.dataset.alt},t={url:n.dataset.sourcePage,id:f};G(i,t,!0)}M=a});var C=document.getElementById("modal"),L=document.getElementById("modal-close");L.addEventListener("click",function(){C.style.display="none"}),document.addEventListener("DOMContentLoaded",o=>{e.postMessage({cmd:"iframeInited"})})}function k(){return+new URL(location.href).searchParams.get("tabid")}function Z(){return new URL(location.href).searchParams.get("batchId")}const Y="iframe_"+Z(),x=E.tabs.connect(k(),{name:Y}),R=e=>{x.postMessage(e)};W(x);const A=(e,u)=>{if(!(!e.forIframe||u.tab.id!==k()))if(e.cmd==="save-images"){const f=[...document.querySelectorAll(".entry :checked")].map(s=>s.closest("label").info),m={};for(const s of f)m[s.frameId]=(m[s.frameId]||0)+1;const l=Object.keys(m).map(Number);for(const s of f){const d=l.indexOf(s.frameId),g=l.slice(0,d).reduce((y,v)=>y+m[v],0);s.order=g+s.position}f.sort((s,d)=>s.order-d.order);for(const s of f)s.filename=s.filename.replace("__ORDER__",s.order);e.images=f,e.zip?new P(x).perform(e).then(()=>D(x)):N(e,(s,d)=>{const g=e.filename.split("/");return g.pop(),g.push(d.filename),q({url:d.src,filename:g.join("/"),conflictAction:"uniquify",saveAs:!1})},x).then(()=>D(x))}else e.cmd==="updateRequestHeaders"?F(e,k(),R):e.cmd==="IFRAME_ADD_IMG_LIST"&&K(e,R)};E.runtime.onMessage.hasListener(A)||E.runtime.onMessage.addListener(A);
