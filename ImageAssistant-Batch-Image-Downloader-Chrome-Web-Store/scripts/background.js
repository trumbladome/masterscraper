/**
 * ImageAssistant
 * Project Home: http://www.pullywood.com/ImageAssistant/
 * Author: Joey
 * Copyright (C) 2013-2024 普利坞(Pullywood.com)
**/
importScripts("../libs/lodash/4.17.15-npm/lodash.js","../libs/JavaScript-MD5/2.14.0/md5.min.js","../libs/moment/2.24.0/moment.min.js","../libs/tldts/6.1.39/index.umd.min.js","../scripts/refactoring/db-configOps.js","../scripts/function.js","../scripts/mime.js");"use strict";if(typeof global==="undefined"){if(typeof window!=="undefined"){window.global=window}else{globalThis.global=globalThis}}global._o_acceptLanguages=["zh_CN","zh","en_US","en"];global._o_defaultRegexpUrlRule="";global._o_regexpUrlRules=[];global._w_larder=true;global._w_pun=null;global._o_regexpUrlMatchThrough=true;global._o_extract_serial_id=1;global._o_background_serial_id=1e11;global._w_attire={_w_pelt:99,_w_jade:98,_w_brink:97,_w_mire:96,_w_brute:95,_w_feint:94,_w_psalm:93,_w_lucre:92,_w_grouse:91,_w_sluice:90,_w_shoddy:10,_w_scrap:9,_w_slice:8,_w_planet:7,_w_revue:5,_w_minuet:2,_w_fervor:1};(async()=>{const localRule=await fetch("/defaultRegexpUrlRule.properties").then((resp=>resp.text()));_o_defaultRegexpUrlRule=localRule;await _o_loadRegexpUrlRules();await _w_trunk();const remoteRule=await fetch(_o_remoteRuleURL).then((resp=>resp.text()));await storage.set("_pullywood_RegexpUrlRule",remoteRule);_o_defaultRegexpUrlRule=localRule;await _o_loadRegexpUrlRules()})();chrome.i18n.getAcceptLanguages((function(data){_o_acceptLanguages=data}));function _w_realm(v1,v2){const v1Parts=v1.split(".").map(Number);const v2Parts=v2.split(".").map(Number);for(let i=0;i<Math.max(v1Parts.length,v2Parts.length);i++){const v1Part=v1Parts[i]||0;const v2Part=v2Parts[i]||0;if(v1Part<v2Part)return-1;if(v1Part>v2Part)return 1}return 0}if(!global.onInstalledListenerRegisted){chrome.runtime.onInstalled.addListener((async function(details){if(details.reason=="install"){await chrome.tabs.create({url:_o_resourceListURL})}else if(details.reason=="update"){const previousVersion=details.previousVersion;if(previousVersion){const versionActions={"1.70.7":async()=>{chrome.declarativeNetRequest.getDynamicRules((rules=>{const ruleIds=rules.map((rule=>rule.id));chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:ruleIds,addRules:[]})}))}};for(const version in versionActions){if(_w_realm(previousVersion,version)<0){await versionActions[version]()}}}}}));global.onInstalledListenerRegisted=true}!async function(){if(isNaN(parseInt(await dbConfigOps.readSetting("inspectConfig")))){await dbConfigOps.saveSetting("inspectConfig",1+2+4)}}();function _o_getAcceptLanguages(){return _o_acceptLanguages}global.maxRules=1e3;async function _w_tundra(rules){const refererRuleOps=dbConfigOps.refererRuleOps;let currentRules=await refererRuleOps.getAllRules();let updatedRuleMap={};for(let{url:url,referer:referer}of rules){let _w_dowry=tldts.getDomain(url);if(referer===null){await refererRuleOps.deleteRule(_w_dowry);continue}let updatedTime=Date.now();await refererRuleOps.saveRule(_w_dowry,referer,updatedTime);updatedRuleMap[_w_dowry]={domain:_w_dowry,referer:referer,updatedTime:updatedTime}}let ruleMap=new Map;for(let rule of currentRules){ruleMap.set(rule.domain,rule)}for(let[domain,rule]of Object.entries(updatedRuleMap)){ruleMap.set(domain,rule)}let allRules=Array.from(ruleMap.values());if(allRules.length>maxRules){allRules=_.orderBy(allRules,["updateTime"],["desc"]).slice(0,maxRules);let retainedDomains=new Set(allRules.map((r=>r.domain)));let obsoleteRules=currentRules.filter((r=>!retainedDomains.has(r.domain)));await dbConfigOps.deleteBatchData("rules",obsoleteRules.map((r=>r.domain)))}let currentDRules=await chrome.declarativeNetRequest.getDynamicRules();let currentDRuleIds=new Set(currentDRules.map((r=>r.id)));let currentDRuleIds_snapshot=new Set(currentDRuleIds);let newDRules=[];let existingDomainMap=new Map(currentDRules.map((rule=>[rule.condition.urlFilter,rule.id])));const _w_combat=new URL(chrome.runtime.getURL("/")).origin;for(let r of allRules){let urlFilter=`*://*.${r.domain}/*`;let id=existingDomainMap.get(urlFilter);if(!id){id=currentDRuleIds.size>0?Math.max(...currentDRuleIds)+1:1;while(currentDRuleIds.has(id)){id++}}let _w_nova;try{_w_nova=r.referer?new URL(r.referer).origin:_w_combat}catch(error){console.error("Invalid referer URL:",r.referer,error);_w_nova=_w_combat}newDRules.push({id:id,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"Referer",operation:"set",value:r.referer},{header:"Origin",operation:"set",value:_w_nova}]},condition:{urlFilter:urlFilter,resourceTypes:["xmlhttprequest"],initiatorDomains:[chrome.runtime.id]}});currentDRuleIds.add(id)}let rulesToRemove=Array.from(currentDRuleIds).filter((id=>!newDRules.some((r=>r.id===id))));let rulesToAdd=newDRules.filter((r=>!currentDRuleIds_snapshot.has(r.id)));if(rulesToRemove.length>0||rulesToAdd.length>0){chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:rulesToRemove,addRules:rulesToAdd},(()=>{if(chrome.runtime.lastError){console.error("Error updating dynamic rules:",chrome.runtime.lastError)}else{}}))}}async function _o_resetTabIdMapper(_o_tabId){if(typeof _o_tabId=="undefined"){console.trace("tabId is undefined.");return}let _o_tab=null;try{_o_tab=await chrome.tabs.get(_o_tabId)}catch(e){console.log(e)}if(!_o_tab){console.trace(`tab(${_o_tabId}) is not exist.`);return}let _w_grease={tabId:_o_tabId};_w_grease._w_imageMap={};_w_grease._w_tycoon=[];_w_grease._w_pageInfoMap={};_w_grease.extractorHash=_o_randomHex(32);_w_grease.url=_o_tab?_o_tab.url:"";_o_moment=moment();_w_grease.timeStamp={};_w_grease.timeStamp.YYYYMMDD=_o_moment.format("YYYY-MM-DD");_w_grease.timeStamp.HHmmss=_o_moment.format("HH-mm-ss");await dbConfigOps.saveTabIdMapper(_w_grease)}async function _o_initTabIdMapper(_o_tabId){let _w_spin=null;let _o_tabIdMapper=null;if(!_o_tabId)return null;try{_w_spin=await chrome.tabs.get(_o_tabId);_o_tabIdMapper=await dbConfigOps.getTabIdMapper(_o_tabId)}catch(e){}_w_spin&&!_o_tabIdMapper&&_o_resetTabIdMapper(_o_tabId);try{_o_tabIdMapper=await dbConfigOps.getTabIdMapper(_o_tabId)}catch(e){console.log("can not get tabIdMapper",_o_tabId);console.trace()}return _o_tabIdMapper}async function _o_registerSecondHashForTab(_o_tabId,_w_extractHash){let _w_grease=await dbConfigOps.getTabIdMapper(_o_tabId);if(_w_grease){_w_grease["extractorHash_2"]=_w_extractHash;await dbConfigOps.saveTabIdMapper(_w_grease);let _w_tactic=await _o_getTabImageMap(_o_tabId);let _o_imageMap={};Object.keys(_w_tactic).forEach((item=>_o_imageMap[item]=_w_tactic[item]));_o_tuiTiQuDeTupianNa(_o_imageMap,_w_extractHash)}}async function _o_getTabImageMap(_o_tabId){let _o_imageMap=null;if(await _o_initTabIdMapper(_o_tabId)){_o_imageMap=(await dbConfigOps.getTabIdMapper(_o_tabId))._w_imageMap}return _o_imageMap}async function _w_intern(_o_tabId){let _w_apron=null;if(await _o_initTabIdMapper(_o_tabId)){_w_apron=(await dbConfigOps.getTabIdMapper(_o_tabId))._w_tycoon}return _w_apron}async function _o_getTabByExtractorHash(_w_extractorHash){if(_w_extractorHash){try{return await dbConfigOps.getTabIdMapperByExtractorHash(_w_extractorHash)}catch(e){return null}}return null}async function _w_coda(_w_extractorHash){let _w_apron=null;let _o_tab=await _o_getTabByExtractorHash(_w_extractorHash);if(_o_tab)_w_apron=_o_tab._w_tycoon;return _w_apron}async function _w_faucet(_w_extractorHash){return await _o_getTabByExtractorHash(_w_extractorHash)}async function _o_getImageMapByExtractorHash(_w_extractorHash){let _o_imageMap=null;let _o_tab=await _o_getTabByExtractorHash(_w_extractorHash);if(_o_tab)_o_imageMap=_o_tab._w_imageMap;return _o_imageMap}async function _o_getTabPageInfoMap(_o_tabId){let _o_pageInfoMap=null;if(await _o_initTabIdMapper(_o_tabId)){_o_pageInfoMap=(await dbConfigOps.getTabIdMapper(_o_tabId))._w_pageInfoMap}return _o_pageInfoMap}async function _w_fume(_o_tabId,_o_pageInfoMap){if(await _o_initTabIdMapper(_o_tabId)){let _o_tabIdMapper=await dbConfigOps.getTabIdMapper(_o_tabId);_o_tabIdMapper._w_pageInfoMap=_o_pageInfoMap;await dbConfigOps.saveTabIdMapper(_o_tabIdMapper)}}async function _o_getPageInfoMapByExtractorHash(_w_extractorHash){let _o_pageInfoMap=null;let _o_tab=await _o_getTabByExtractorHash(_w_extractorHash);if(_o_tab)_o_pageInfoMap=_o_tab._w_pageInfoMap;return _o_pageInfoMap}async function _o_getTabExtractorHash(_o_tabId){let _o_extractorHash=null;try{if(await _o_initTabIdMapper(_o_tabId)){_o_extractorHash=(await dbConfigOps.getTabIdMapper(_o_tabId)).extractorHash}}catch(e){}return _o_extractorHash}async function _o_getTabExtractorHash_2(_o_tabId){let _o_extractorHash=null;if(!_o_tabId){return null}else if(await _o_initTabIdMapper(_o_tabId)){try{_o_extractorHash=(await dbConfigOps.getTabIdMapper(_o_tabId)).extractorHash_2}catch(e){}}return _o_extractorHash}async function _o_getTabIdWithExtractorHash(_w_extractorHash){let _o_tabId=null;let _o_tab=await _o_getTabByExtractorHash(_w_extractorHash);if(_o_tab)_o_tabId=_o_tab.tabId;return _o_tabId}global._o_request_monitor=function(){dbConfigOps.clearRequestStatus();dbConfigOps.clearTabUpdateStatus();let _o_request_sts_options={urls:["<all_urls>"]};let _o_request_sts_handle=async function(details){let _w_inner_log=async function(error,statusCode){let request=await dbConfigOps.getRequestStatus(details.requestId);let _w_timeCost=request?parseInt(details.timeStamp-request.timeStamp):-1;let _o_target_item=await dbConfigOps.getTabUpdateStatus(details.tabId);if(_o_target_item){if(typeof _o_target_item["lastRequest"]!="undefined"){_o_target_item["lastRequest"]=(new Date).getTime();_o_target_item["invalidRequestCount"]++}if(_o_target_item["requestLog"]){_o_target_item["requestLog"][details.url]={error:error,statusCode:statusCode,timeCost:_w_timeCost}}await dbConfigOps.saveTabUpdateStatus(details.tabId,_o_target_item)}await dbConfigOps.deleteRequestStatus(details.requestId)};if(details.error){_w_inner_log(details.error,null)}else if(details.statusCode){_w_inner_log(null,details.statusCode)}else{if(!/^https?:\/\/.*$/gi.test(details.url))return;await dbConfigOps.saveRequestStatus(details.requestId,{requestId:details.requestId,timeStamp:details.timeStamp,tabId:details.tabId,url:details.url,type:details.type})}};chrome.webRequest.onBeforeRequest.addListener(_o_request_sts_handle,_o_request_sts_options,[]);chrome.webRequest.onCompleted.addListener(_o_request_sts_handle,_o_request_sts_options);chrome.webRequest.onErrorOccurred.addListener(_o_request_sts_handle,_o_request_sts_options);let _w_requestNum=async function(tabIds){if(Number.isInteger(tabIds)){tabIds=[tabIds]}if(Array.isArray(tabIds)){let requests=await dbConfigOps.getAllRequestStatuses();return requests.map((function(item){return item.tabId})).filter((function(item){return tabIds.indexOf(item)>=0})).length}else{return(await dbConfigOps.getAllRequestStatuses()).length}};let _w_unRegisterTab=async function(tabId){await dbConfigOps.deleteTabUpdateStatus(tabId)};let _o_pushImageEventHandle=async function(tabId){let _o_target_item=await dbConfigOps.getTabUpdateStatus(tabId);if(_o_target_item){if(typeof _o_target_item["lastPushImage"]!="undefined"){_o_target_item["lastPushImage"]=(new Date).getTime();await dbConfigOps.saveTabUpdateStatus(tabId,_o_target_item)}}};let _o_pushFullScrollEventHandle=async function(tabId){let _o_target_item=await dbConfigOps.getTabUpdateStatus(tabId);if(_o_target_item){if(typeof _o_target_item["lastFullScroll"]!="undefined"){_o_target_item["lastFullScroll"]=(new Date).getTime();await dbConfigOps.saveTabUpdateStatus(tabId,_o_target_item)}}};let _o_notifyRemoveTab=async function(tabId){await _w_unRegisterTab(tabId);let requests=await dbConfigOps.getAllRequestStatuses();let filteredRequests=requests.filter((request=>request.tabId===tabId));for(let request of filteredRequests){await dbConfigOps.deleteRequestStatus(request.requestId)}};return{requestNum:_w_requestNum,registerTab:async function(tabId,item){await dbConfigOps.saveTabUpdateStatus(tabId,item)},getTabUpdateStatus:async function(tabId){let tabUpdateStatus=null;if(tabId){try{tabUpdateStatus=await dbConfigOps.getTabUpdateStatus(tabId)}catch(e){console.log(e)}}return tabUpdateStatus},unRegisterTab:_w_unRegisterTab,notifyPushImage:_o_pushImageEventHandle,notifyFullScroll:_o_pushFullScrollEventHandle,notifyRemoveTab:_o_notifyRemoveTab}}();async function _o_onCreatedListener(tab){if(chrome.runtime.lastError)return;await _o_initTabIdMapper(tab.id)}async function _w_yarn(details){if(details.frameId!==0)return;await _o_resetTabIdMapper(details.tabId);let _w_ledger=await dbConfigOps.getTabIdMapper(details.tabId);if(_w_ledger){let _w_newUrl=_o_extractUrlWithoutHash(details.url);_w_ledger.url=_w_newUrl;await dbConfigOps.saveTabIdMapper(_w_ledger)}}async function _o_onRemovedListener(_o_tabId){_o_request_monitor.notifyRemoveTab(_o_tabId);await dbConfigOps.deleteTabIdMapper(_o_tabId)}if(!global.tabsAndwebNavigationListenerRegisted){chrome.tabs.onCreated.addListener(_o_onCreatedListener);chrome.webNavigation.onBeforeNavigate.addListener(_w_yarn);chrome.tabs.onRemoved.addListener(_o_onRemovedListener);global.tabsAndwebNavigationListenerRegisted=true}(async function(){async function _o_updateTabsInfo(){const tabs=await chrome.tabs.query({});for(const tab of tabs){if(tab&&!dbConfigOps.getTabIdMapper(tab.id)){await _o_initTabIdMapper(tab.id)}}const tabIds=await dbConfigOps.getAllKeys("tabIdMapper");for(const tabId of tabIds){try{await chrome.tabs.get(tabId)}catch(e){try{await dbConfigOps.deleteTabIdMapper(tabId)}catch(e){}}}}setInterval(_o_updateTabsInfo,4e3);await _o_initHeadListener();await _o_loadRegexpUrlRules()})();async function _o_initHeadListener(){await chrome.webRequest.onHeadersReceived.addListener((async function(details){if(details.tabId<0){return}let _w_headers=details.responseHeaders;for(let i=0;i<_w_headers.length;++i){_w_headers[_w_headers[i].name.toLowerCase()]=_w_headers[i].value}let _w_contentType=_w_headers["content-type"];if(_w_contentType)_w_contentType=_w_contentType.toLowerCase();let _w_bucket=parseInt(_w_headers["content-length"]);if((details.type&&details.type=="image"&&!_w_contentType||_w_contentType&&_w_contentType.startsWith("image/"))&&(isNaN(_w_bucket)||_w_bucket>0)){let _w_item={};let _w_currentTab=null;try{_w_currentTab=await chrome.tabs.get(details.tabId)}catch(e){}if(_w_currentTab&&_w_currentTab.url.startsWith(chrome.runtime.getURL("/")))return;if(_w_currentTab){let _w_pageURL=new URL(_w_currentTab.url);_w_item.pageTitle=_w_currentTab.title;_w_item.pageURL=_w_pageURL.origin+_w_pageURL.pathname+_w_pageURL.search;_w_item.pageDomain=_w_pageURL.hostname;_w_item.pageHash=_w_pageURL.hash}let _w_itemURL=new URL(details.url);_w_item.url=_w_itemURL.origin+_w_itemURL.pathname+_w_itemURL.search;_w_item.domain=_w_itemURL.hostname;_w_item.contentType=details.type;_w_item.size=null;_w_item.resolution=null;_w_item.filename=null;let _w_lenStr=null;if(_w_headers["Content-Length"]){if(_w_headers["Content-Length"]>=1024*1024*1024){_w_lenStr=(_w_headers["Content-Length"]/1024/1024/1024).toFixed(2)+"GB"}else if(_w_headers["Content-Length"]>=1024*1024){_w_lenStr=(_w_headers["Content-Length"]/1024/1024).toFixed(2)+"MB"}else{_w_lenStr=(_w_headers["Content-Length"]/1024).toFixed(2)+"KB"}_w_item.size=_w_lenStr}_w_item.filename=_w_itemURL.pathname.substring(_w_itemURL.pathname.lastIndexOf("/")+1);let _w_extractedImage={};let _o_request_referer=_w_item.pageURL;let _w_extUrl=details.url;_w_extractedImage[_w_extUrl]={source:"_w_fervor",title:"",alt:"",serial:_o_background_serial_id++,referer:_o_request_referer};let _o_tabExtractorHash=await _o_getTabExtractorHash(details.tabId);await enqueueMessageAndHandle({type:"_o_pushExtractedImage",extractorHash:_o_tabExtractorHash,images:_w_extractedImage})}else if(details.type&&details.type=="media"||_w_contentType&&_w_contentType.indexOf("video/")>-1||_w_contentType&&_w_contentType.indexOf("audio/")>-1){}}),{urls:["<all_urls>"]},["responseHeaders","extraHeaders"])}async function _o_getPageTitle(_o_extractorHash,url){let _o_title=url;let _w_pageInfoMap=_o_getPageInfoMapByExtractorHash(_o_extractorHash);if(_w_pageInfoMap){url=_o_extractUrlWithoutHash(url);let _w_pageInfo=_w_pageInfoMap[url];if(_w_pageInfo&&_w_pageInfo.title&&_w_pageInfo.title.length>0){_o_title=_w_pageInfo.title}}return _o_title}async function _o_getExtTimeStamp(_w_extractorHash){let _o_momentTimeStamp={YYYYMMDD:"YYYY-MM-DD",HHmmss:"HH-mm-ss"};let _o_tab=await _o_getTabByExtractorHash(_w_extractorHash);if(_o_tab)_o_momentTimeStamp=_o_tab.timeStamp;return _o_momentTimeStamp}function _o_specialPageRefererConfig(details){let _w_withReferer=false;let _w_withUserAgent=false;let _w_headerRefererIdx=-1;let _w_newReferer=undefined;for(let i=0;i<details.requestHeaders.length;++i){if(details.requestHeaders[i].name==="Referer"){_w_withReferer=true;_w_headerRefererIdx=i}}Object.values(_o_tabIdMapper).forEach((function(tab){if(tab._w_refererMap&&tab._w_refererMap[details.url]&&tab._w_refererMap[details.url]!=_o_multiURLExtDefURL&&tab._w_refererMap[details.url]!=_o_SSL_multiURLExtDefURL){_w_newReferer=tab._w_refererMap[details.url]}}));if(_w_newReferer&&_w_withReferer){details.requestHeaders[_w_headerRefererIdx].value=_w_newReferer}else if(_w_newReferer){details.requestHeaders.push({name:"Referer",value:_w_newReferer})}return{requestHeaders:details.requestHeaders}}_o_getClientFinger();global.settingsHandlers={_o_dyLoadSize:{get:async()=>{let dyLoadSize=Number.parseInt(await dbConfigOps.readSetting("dyLoadSize"));if(!dyLoadSize){dyLoadSize=256;await global.settingsHandlers["_o_dyLoadSize"].set(dyLoadSize)}return dyLoadSize},set:async value=>{value=Number.parseInt(value);if(!value)value=256;else if(value<64)value=64;else if(value>2048)value=2048;await dbConfigOps.saveSetting("dyLoadSize",value)}},_o_extMaxLoad:{get:async()=>{let extMaxLoad=Number.parseInt(await dbConfigOps.readSetting("extMaxLoad"));if(!extMaxLoad){extMaxLoad=1024;await global.settingsHandlers["_o_extMaxLoad"].set(extMaxLoad)}return extMaxLoad},set:async value=>{value=Number.parseInt(value);if(!value)value=1024;else if(value<1024)value=1024;else if(value>4096)value=4096;await dbConfigOps.saveSetting("extMaxLoad",value)}},_w_lien:{get:async()=>{let inspectConfig=parseInt(await dbConfigOps.readSetting("inspectConfig"));if(isNaN(inspectConfig)){inspectConfig=1+2+4}return inspectConfig&1+2+4},set:async value=>{let config=parseInt(value);if(isNaN(config)){config=1+2+4}await dbConfigOps.saveSetting("inspectConfig",config&1+2+4)}},_w_clay:{get:_w_seine,set:_w_scarp},_w_glitch:{get:_w_dearth,set:_w_piazza},_o_regexpUrlRule:{get:_o_getRegexpUrlRule,set:_o_setRegexpUrlRule},_w_sap:{get:_o_huoquTupianOptions},_w_grove:{get:_o_getDefaultImageSizeOptions},_w_parka:{get:_o_getMenuStatus,set:_o_setMenuStatus},_w_mirage:{get:_o_getClientFinger},_o_extClickAct:{get:_o_getExtClickAct,set:_o_setExtClickAct},_w_leash:{get:async()=>{let width=Number.parseInt(await dbConfigOps.readSetting("defaultFunnelWidth"));let height=Number.parseInt(await dbConfigOps.readSetting("defaultFunnelHeight"));return{width:width||10,height:height||10}},set:async value=>{let width=Number.parseInt(value.width);let height=Number.parseInt(value.height);if(width>0){await dbConfigOps.saveSetting("defaultFunnelWidth",width)}if(height>0){await dbConfigOps.saveSetting("defaultFunnelHeight",height)}}}};async function genericSetSetting(key,value){await dbConfigOps.saveSetting(key,value)}async function genericGetSetting(key){return await dbConfigOps.readSetting(key)}async function enqueueMessageAndHandle(message){await dbConfigOps.enqueueMessage(message);if(!global._w_tumult){global._w_tumult=true;processQueue()}}if(!global.dozensOfMessageListenerRegisted){chrome.runtime.onMessage.addListener(((message,sender,sendResponse)=>{try{switch(message.type){case"saveSetting":(async()=>{let result;if(settingsHandlers[message.key]&&global.settingsHandlers[message.key].set){result=await global.settingsHandlers[message.key].set(message.value)}else{result=await genericSetSetting(message.key,message.value)}sendResponse({status:"success",result:result})})();return true;case"readSetting":(async()=>{let value;if(settingsHandlers[message.key]&&global.settingsHandlers[message.key].get){value=await global.settingsHandlers[message.key].get()}else{value=await genericGetSetting(message.key)}sendResponse({value:value})})();return true;case"_o_addImageSizeOption":(async()=>{await _o_addImageSizeOption(message.width,message.height);sendResponse({status:"success"})})();return true;case"_o_removeImageSizeOption":(async()=>{await _o_removeImageSizeOption(message.width,message.height);sendResponse({status:"success"})})();return true;case"_o_regexpUrlMatchRule":(async()=>{sendResponse({value:await _o_regexpUrlMatchRule(message._w_originUrl)})})();return true;case"_o_regexpUrlReplace":(async()=>{sendResponse({value:await _o_regexpUrlReplace(message._w_originUrl,message.deepth)})})();return true;case"_o_getExtTimeStamp":(async()=>{sendResponse({value:await _o_getExtTimeStamp(message._w_extractorHash)})})();return true;case"_o_guanbiTab":(async()=>{chrome.tabs.remove(sender.tab.id);sendResponse({status:"success"})})();return true;case"_w_breach":(async()=>{await _w_breach(message.errorInformation);sendResponse({status:"success"})})();return true;case"_o_extractScriptInject":(async()=>{try{await _o_extractScriptInject(message._o_extractorHash,message._o_fetchLevel);sendResponse({status:"_o_extractScriptInject executed."})}catch(e){sendResponse({status:"_o_extractScriptInject executed with exception."})}})();return true;case"_w_polish":(async()=>{try{await _o_zhuruJSYongHash(message._o_tabId,message._o_fetchLevel,`${message._o_extHash}${await _o_randomFingerChar()}`);sendResponse({status:"_w_polish executed."})}catch(e){sendResponse({status:"_w_polish executed with exception."})}})();return true;case"_o_getImageMapByExtractorHash":(async()=>{const _w_ledger=await _w_faucet(message._o_extractorHash);const _o_imageMap=_w_ledger?_w_ledger._w_imageMap:null;const _w_apron=_w_ledger?_w_ledger._w_tycoon:null;sendResponse({value:{_w_apron:_w_apron,_o_imageMap:_o_imageMap}})})();return true;case"_o_getPageInfoMapByExtractorHash":(async()=>{sendResponse({value:await _o_getPageInfoMapByExtractorHash(message._o_extractorHash)})})();return true;case"_o_registerSecondHashForTab":(async()=>{sendResponse({value:await _o_registerSecondHashForTab(message._o_tabId,message._w_extractHash)})})();return true;case"_o_bianjiImage":(async()=>{await _o_bianjiImage(message._o_url,message._o_referer,message._o_tabId);sendResponse({status:"success"})})();return true;case"_o_sendAsWatermark":(async()=>{await _o_sendAsWatermark(message._o_url,message._o_referer,message._o_tabId);sendResponse({status:"success"})})();return true;case"_o_pushExtractedImage":case"_o_gengxiYeMXinxi":(async()=>{enqueueMessageAndHandle(message);sendResponse({status:"success"})})();return true;case"_o_notifyGunDong":(async()=>{await _o_request_monitor.notifyFullScroll(sender.tab.id);sendResponse({status:"success"})})();return true;case"_o_qingQiuWeiYiID":(async()=>{sendResponse({value:await _o_generateExtractId()})})();return true;case"_o_chuli3rdXinxi":(async()=>{await _o_chuli3rdXinxi(message.url,message.action,sender.tab.id,message.createNewTab);sendResponse({status:"success"})})();return true;case"_o_extractImageFromTab":(async()=>{const tabId=message.tabId?message.tabId:sender.tab.id;await _o_extractImageFromTab(tabId,message.fetchLevel);sendResponse({status:"success"})})();return true;case"_o_biaojiMuLu":(async()=>{await dbConfigOps.saveSetting("folderMark",message.folderMark);sendResponse({status:"success"})})();return true;case"_w_sleigh":(async()=>{const _pwdbwqw_tabId=message.tabId?message.tabId:sender.tab.id;sendResponse({value:await _o_request_monitor.requestNum(_pwdbwqw_tabId)})})();return true;case"_o_extractImageFromSelectedPage":(async()=>{await _o_extractImageFromSelectedPage(message.level);sendResponse({status:"success"})})();return true;case"_o_multiUrlExtract":(async()=>{await _o_multiUrlExtract();sendResponse({status:"success"})})();return true;case"_o_getTabExtractorHash":(async()=>{sendResponse({value:await _o_getTabExtractorHash(message._o_tabId)})})();return true;case"_w_cipher":(async()=>{sendResponse({value:await _w_cipher(message._w_suffix)})})();return true;case"_w_brood":(async()=>{await _w_brood(message._o_tabId,message._w_timeout,message.checkVisible);sendResponse({status:`${message.type} executed.`})})();return true;case"_o_resetTabIdMapper":(async()=>{await _o_resetTabIdMapper(message._o_tabId);sendResponse({status:`${message.type} executed.`})})();return true;case"_w_hamper":(async()=>{await _o_request_monitor.registerTab(message._o_tabInfo.tabId,message._o_tabInfo);sendResponse({status:`${message.type} executed.`})})();return true;case"_w_bark":(async()=>{let tabUpdateStatus=await _o_request_monitor.getTabUpdateStatus(message.tabId);if(tabUpdateStatus)tabUpdateStatus["requestNum"]=await _o_request_monitor.requestNum(message.tabid);sendResponse({value:tabUpdateStatus})})();return true;default:break}}catch(error){}}));global.dozensOfMessageListenerRegisted=true}async function _o_multiUrlExtract(_o_extTab,_o_closePage){!_o_closePage&&(_o_closePage=false);let _o_doMultExt=async function(_o_tab){_o_executeFunWhenTabNotPending(_o_tab.id,(function(observedTab){let _w_originalUrl=observedTab.url;let _w_msgChannel=_o_randomChar(32);let _w_imageExtractorUrl="multiUrlExtractor.html?msgChannel="+_w_msgChannel;if(_o_isAccessibleUrl(_w_originalUrl)){_w_imageExtractorUrl+="&originalUrl="+encodeURIComponent(_w_originalUrl)}chrome.tabs.create({url:_w_imageExtractorUrl,active:true},(async function(newTab){if(_o_isAccessibleUrl(observedTab.url)){await _o_charactisticExtScriptInject(observedTab.id,newTab.id,_w_msgChannel,_o_closePage)}}))}))};if(_o_extTab){_o_doMultExt(_o_extTab)}else{const tabArray=await chrome.tabs.query({active:true,currentWindow:true});if(!tabArray||tabArray.length===0)return;let _w_selectedTab=tabArray[0];_o_doMultExt(_w_selectedTab)}}async function _o_extractImageFromSelectedPage(_o_fetchLevel){const tabArray=await chrome.tabs.query({active:true,currentWindow:true});if(!tabArray||tabArray.length==0)return;let _w_selectedTab=tabArray[0];await _o_extractImageFromTab(_w_selectedTab.id,_o_fetchLevel)}function _o_extractImageFromURL(url,_o_fetchLevel){chrome.tabs.create({url:url,active:false},(function(tab){chrome.tabs.onUpdated.addListener((function updatedFun(tabId,changeInfo,updatedTab){if(tabId==tab.id&&changeInfo.url){chrome.tabs.onUpdated.removeListener(updatedFun);_o_extractImageFromTab(tabId,_o_fetchLevel)}}))}))}function _o_multiExtractImageFromURL(url){chrome.tabs.create({url:url,active:true},(function(tab){chrome.tabs.onUpdated.addListener((function updatedFun(tabId,changeInfo,updatedTab){if(tabId==tab.id&&changeInfo.url){chrome.tabs.onUpdated.removeListener(updatedFun);_o_multiUrlExtract(tab,true)}}))}))}async function _o_extractImageFromTab(_o_tabId,_o_fetchLevel){await _o_tiQuTupianaHaha(_o_tabId,_o_fetchLevel,true)}async function _o_tiQuTupianaHaha(_o_tabId,_o_fetchLevel,_o_activeView){let tab=null;try{tab=await chrome.tabs.get(_o_tabId)}catch(e){console.log(e)}if(tab&&_o_isAccessibleUrl(tab.url)||_o_isMultiExtUrl(tab.url)){let _w_timer=setTimeout((function(){chrome.tabs.create({index:tab.index+1,url:"imageExtractor.html?tabId="+tab.id+"&fetchLevel="+_o_fetchLevel,active:_o_activeView?true:false})}),512);const _w_tabId=await awaitWithTimeout(_o_selectExtractor(await _o_getTabExtractorHash(tab.id)),null,2e3);if(_w_tabId){clearTimeout(_w_timer);chrome.tabs.update(_w_tabId,{active:true},(function(tab){chrome.windows.update(tab.windowId,{focused:true,drawAttention:false})}))}}else{chrome.notifications.create("",{type:"basic",iconUrl:"./images/icon512.png",title:_MSG_("bg_warning_ntfy_title"),message:_MSG_("bg_warning_ntfy_msg")})}}async function _o_extractScriptInject(_o_extractorHash,_o_fetchLevel){let _o_tabId=await _o_getTabIdWithExtractorHash(_o_extractorHash);await _o_zhuruJSYongHash(_o_tabId,_o_fetchLevel,`${_o_extractorHash}${await _o_randomFingerChar()}`)}async function _o_zhuruJSYongHash(_o_tabId,_o_fetchLevel,_o_extHash){await _o_executeScripts(_o_tabId,[{file:"libs/jquery/3.4.1/jquery-3.4.1.min.js",allFrames:true},{file:"libs/DOMPurify/2.0.8/purify.min.js",allFrames:true},{file:"scripts/function.js",allFrames:true},{file:"scripts/mime.js",allFrames:true},{file:"scripts/script.js",allFrames:true}]);chrome.webNavigation.getAllFrames({tabId:_o_tabId},(function(frames){if(frames&&frames.length){frames.forEach((frame=>{if(typeof frame.frameId==="number"){chrome.tabs.sendMessage(_o_tabId,{type:"_o_extractImage",_o_fetchLevel:_o_fetchLevel,_o_extHash:_o_extHash},{frameId:frame.frameId},(response=>{}))}else{}}))}}))}async function _o_charactisticExtScriptInject(_o_pageTabId,_o_multiExtTabId,_o_msgChannel,_o_closePage){await _o_executeScripts(_o_pageTabId,[{file:"libs/jquery/3.4.1/jquery-3.4.1.min.js",allFrames:false},{file:"scripts/function.js",allFrames:false},{file:"scripts/mime.js",allFrames:false},{file:"scripts/characteristicUrlExtract.js",allFrames:false}]);chrome.webNavigation.getAllFrames({tabId:_o_pageTabId},(function(frames){if(frames&&frames.length){frames.forEach((frame=>{if(frame.parentFrameId===-1){chrome.tabs.sendMessage(_o_pageTabId,{type:"_o_characteristicExtract",_o_spliterSplit:"_o_spliterSplit",_o_msgChannel:_o_msgChannel,_o_closePage:_o_closePage},{frameId:frame.frameId},(response=>{}))}}))}}))}async function _o_chuli3rdXinxi(_w_url,_w_action,_w_originalTabId,_w_createNewTab){let _w_execFun=function(execTab){if(!_w_action||_w_action.trim()=="")return;chrome.tabs.onUpdated.addListener((async function updatedFun(tabId,changeInfo){if(tabId==execTab.id&&changeInfo.url){chrome.tabs.onUpdated.removeListener(updatedFun);await _o_executeScripts(tabId,[{file:"libs/jquery/3.4.1/jquery-3.4.1.min.js",allFrames:true},{file:"scripts/function.js",allFrames:true},{file:"scripts/scriptForthirdPartPage.js",allFrames:true}]);chrome.webNavigation.getAllFrames({tabId:_o_tabId},(function(frames){if(frames&&frames.length){frames.forEach((frame=>{chrome.tabs.sendMessage(_o_tabId,{type:_w_action},{frameId:frame.frameId},(response=>{}))}))}}))}}))};if(_w_createNewTab){chrome.tabs.create({url:_w_url,active:true},_w_execFun)}else{chrome.tabs.update(_w_originalTabId,{url:_w_url,active:true},_w_execFun)}}async function _o_regexpUrlMatchRule(url){let _w_rules=[];for(let idx in _o_regexpUrlRules){let _w_urlRegexp=_o_regexpUrlRules[idx]["urlRegexp"];if(_w_urlRegexp.test(url)){_w_rules.push(_o_regexpUrlRules[idx]["urlRuleStr"]);if(!_o_regexpUrlMatchThrough)break}}return _w_rules}async function _o_regexpUrlReplace(url,deepth){let _w_urls={};if(!_w_larder){return Object.keys(_w_urls)}else if(!Number.isInteger(deepth)){deepth=4}else if(deepth<=0){return Object.keys(_w_urls)}else{deepth--}for(let idx in _o_regexpUrlRules){let _w_urlRegexp=_o_regexpUrlRules[idx]["urlRegexp"];let _w_urlReplace=_o_regexpUrlRules[idx]["urlReplace"];if(_w_urlRegexp.test(url)){let _w_replaced_url=url.replace(_w_urlRegexp,_w_urlReplace);if(_w_replaced_url!=url){_w_urls[_w_replaced_url]=true;let _w_subReplaceResult=await _o_regexpUrlReplace(_w_replaced_url,deepth);_w_subReplaceResult.forEach((function(result_url){_w_urls[result_url]=true}));if(!_o_regexpUrlMatchThrough)break}}}return Object.keys(_w_urls)}async function _o_gengxiYeMXinxiWithHash(_o_pageInfo,_o_extractorHash){let _w_tabId=await _o_getTabIdWithExtractorHash(_o_extractorHash);let _o_extractorHash_2=await _o_getTabExtractorHash_2(_w_tabId);if(_o_extractorHash_2){await _o_gengxiYeMXinxi(_o_pageInfo,await _o_getTabIdWithExtractorHash(_o_extractorHash_2))}await _o_gengxiYeMXinxi(_o_pageInfo,await _o_getTabIdWithExtractorHash(_o_extractorHash))}async function _o_gengxiYeMXinxi(_o_pageInfo,_o_tabId){if(!_o_tabId){return}let _w_tabPageInfoMap=await _o_getTabPageInfoMap(_o_tabId);let _w_pageUrl=_o_extractUrlWithoutHash(_o_pageInfo["url"]);_o_pageInfo["url"]=_w_pageUrl;let _w_pageInfo=_w_tabPageInfoMap[_w_pageUrl];if(_w_pageInfo==null){_w_tabPageInfoMap[_w_pageUrl]=_o_pageInfo}else{for(let key in _o_pageInfo){_w_pageInfo[key]==null?_w_pageInfo[key]=_o_pageInfo[key]:_o_pageInfo[key]==null?"":_o_pageInfo[key].length>_w_pageInfo[key].length?_w_pageInfo[key]=_o_pageInfo[key]:""}}await _w_fume(_o_tabId,_w_tabPageInfoMap)}async function processQueue(){let queueItem=await dbConfigOps.dequeueMessage();if(!queueItem){global._w_tumult=false;return}const{key:key,data:data}=queueItem;try{switch(data.messageContent.type){case"_o_pushExtractedImage":await _o_tuiTiQuDeTupianNa(data.messageContent.images,data.messageContent.extractorHash);break;case"_o_gengxiYeMXinxi":await _o_gengxiYeMXinxiWithHash(data.messageContent.pageInfo,data.messageContent.extractorHash);break}}catch(error){}finally{await processQueue()}}async function _o_tuiTiQuDeTupianNa(_o_imageMap,_o_extractorHash){let _w_tabId=await _o_getTabIdWithExtractorHash(_o_extractorHash);let _o_extractorHash_2=await _o_getTabExtractorHash_2(_w_tabId);if(_o_extractorHash_2){await _o_pushExtractedImage(_o_imageMap,await _o_getTabIdWithExtractorHash(_o_extractorHash_2))}await _o_pushExtractedImage(_o_imageMap,await _o_getTabIdWithExtractorHash(_o_extractorHash))}function _w_oracle(_o_imageMap){Object.keys(_o_imageMap).forEach((itemUrl=>{if(/^https?:\/\/.*/i.test(itemUrl)||/^data:.*/i.test(itemUrl))return;if(itemUrl.startsWith("//")){let protocol="https:";let referer=_o_imageMap[itemUrl]?_o_imageMap[itemUrl].referer:null;if(referer&&/^(https?:)\/\/.*/i.test(referer)){protocol=/^(https?:)\/\/.*/i.exec(referer)[1]}let newItemUrl=protocol+itemUrl;if(!_o_imageMap[newItemUrl]){_o_imageMap[newItemUrl]=_o_imageMap[itemUrl];delete _o_imageMap[itemUrl]}}}));return _o_imageMap}async function _o_pushExtractedImage(_o_imageMap,_o_tabId){_w_oracle(_o_imageMap);if(!_o_tabId){return}if(_o_request_monitor){_o_request_monitor.notifyPushImage(_o_tabId)}let _w_tabIsServiceSite=_o_isServiceSite(await chrome.tabs.get(_o_tabId).url);let _w_saveExtItem=async function(item,_w_newImageItem,_w_updateItemMap){let _w_grease=await dbConfigOps.getTabIdMapper(_o_tabId);if(_o_isExcludeURL(item)){}else if(!_w_grease._w_imageMap[item]){_w_grease._w_imageMap[item]=_w_newImageItem;_w_grease._w_tycoon.push(item)}else{let _w_updateSets=0;if(_w_newImageItem.title&&_w_newImageItem.title.length>0&&_w_grease._w_imageMap[item].title!=_w_newImageItem.title){_w_grease._w_imageMap[item].title=_w_newImageItem.title;_w_updateSets|=1}if(_w_newImageItem.alt&&_w_newImageItem.alt.length>0&&_w_grease._w_imageMap[item].alt!=_w_newImageItem.alt){_w_grease._w_imageMap[item].alt=_w_newImageItem.alt;_w_updateSets|=2}let _w_fluke=_w_attire[_w_grease._w_imageMap[item].source];let _w_foible=_w_attire[_w_newImageItem.source];if(_w_newImageItem.referer&&_w_newImageItem.referer.length>0&&_w_grease._w_imageMap[item].referer!=_w_newImageItem.referer){if(!_w_grease._w_imageMap[item].referer||_w_foible>_w_fluke){_w_grease._w_imageMap[item].referer=_w_newImageItem.referer;_w_updateSets|=4}}if(_w_newImageItem.serial&&(_w_newImageItem.serial<_w_grease._w_imageMap[item].serial&&_w_foible>_w_attire["_w_minuet"]||_w_fluke<=_w_attire["_w_minuet"])){_w_grease._w_imageMap[item].serial=_w_newImageItem.serial;_w_updateSets|=8;if(_w_fluke<=_w_attire["_w_minuet"]){_w_grease._w_imageMap[item].source=_w_newImageItem.source;_w_updateSets|=32}}if(_w_updateSets>0)_w_updateItemMap[_w_grease._w_tycoon.indexOf(item)]=_w_updateSets}await dbConfigOps.saveTabIdMapper(_w_grease)};let _w_updateItemMap={};let _w_refererMap={};for(let item in _o_imageMap){try{let _w_newImageItem=_o_imageMap[item];item=_o_formatURL(item);_w_newImageItem.referer=_o_formatURL(_w_newImageItem.referer);let _w_dowry=tldts.getDomain(item);if(_w_dowry&&!_w_refererMap[_w_dowry]&&_w_newImageItem.referer){_w_refererMap[_w_dowry]=_w_newImageItem.referer}if(_w_tabIsServiceSite)item=_o_RestoreUrlFromServiceSite(item);try{let _w_replaced_result=await _o_regexpUrlReplace(item);for(let ridx in _w_replaced_result){await _w_saveExtItem(_w_replaced_result[ridx],_w_newImageItem,_w_updateItemMap)}}catch(exception){}await _w_saveExtItem(item,_w_newImageItem,_w_updateItemMap)}catch(exception){}}let _w_snare=Object.entries(_w_refererMap).map((([url,referer])=>({url:url,referer:referer})));_w_tundra(_w_snare);try{await chrome.runtime.sendMessage(_o_getExtensionId(),{type:"_o_updateTupian",extractorHash:await _o_getTabExtractorHash(_o_tabId)})}catch(error){}if(Object.keys(_w_updateItemMap).length>0){chrome.runtime.sendMessage(_o_getExtensionId(),{type:"_o_updateTupianItem",extractorHash:await _o_getTabExtractorHash(_o_tabId),ItemIdxMap:_w_updateItemMap})}}async function _o_executeScripts(_o_tabId,_o_injectDetailsArray,_o_callback){for(const injectDetails of _o_injectDetailsArray){if(injectDetails.file){await chrome.scripting.executeScript({target:{tabId:_o_tabId,allFrames:injectDetails.allFrames},files:[injectDetails.file]})}else if(injectDetails.func&&injectDetails.args){await chrome.scripting.executeScript({target:{tabId:_o_tabId,allFrames:injectDetails.allFrames},func:injectDetails.func,args:injectDetails.args})}}if(typeof _o_callback==="function"){await _o_callback()}}function _o_injectStyles(_o_tabId,_o_injectDetailsArray,_o_callback){function createCallback(_o_tabId,_o_injectDetails,_o_innerCallback){return function(){chrome.tabs.insertCSS(_o_tabId,_o_injectDetails,_o_innerCallback)}}while(_o_injectDetailsArray.length>0){_o_callback=createCallback(_o_tabId,_o_injectDetailsArray.pop(),_o_callback)}if(_o_callback!==null){_o_callback()}}if(!global.commandsListenerRegisted){chrome.commands.onCommand.addListener((function(command){if(command=="command_extract_images"){_o_extractImageFromSelectedPage(0)}else if(command=="command_multi_extract_images"){_o_multiUrlExtract()}}));global.commandsListenerRegisted=true}async function _o_huoquTupianOptions(){let _o_image_size=await dbConfigOps.readSetting("image_size");if(!_o_image_size)_o_image_size=_o_getDefaultImageSizeOptions();return _o_image_size}async function _o_getDefaultImageSizeOptions(){return _o_sizeItemExt(_o_image_size_default.slice(0))}async function _o_resetImageSizeOptions(){let _o_image_size=await _o_getDefaultImageSizeOptions();await dbConfigOps.saveSetting("image_size",_o_image_size)}async function _w_dearth(){let _w_poll=await dbConfigOps.readSetting("convert_format_when_download");if(_w_poll=="jpg"){return"jpg"}else if(_w_poll=="png"){return"png"}else{await _w_piazza("png");return"png"}}async function _w_piazza(format){if(format=="jpg")await dbConfigOps.saveSetting("convert_format_when_download","jpg");else await dbConfigOps.saveSetting("convert_format_when_download","png")}global._w_thread=(()=>{const default_config={};_w_pullet.forEach((suffix=>default_config[suffix]=false));return default_config})();async function _w_cipher(_w_suffix){if(!_w_suffix)return false;_w_suffix=_w_suffix.replace(/\./gi,"");let _w_result=await _w_seine();if(_w_suffix==await _w_dearth()){return true}else if(_w_result[_w_suffix]==true){return true}else if(typeof _w_result[_w_suffix]=="undefined"&&_w_result["_"]){return true}else{return false}}async function _w_seine(){let _w_result={..._w_thread};const _w_robe=await dbConfigOps.readSetting("convert_format_when_downloading");if(_w_robe){try{Object.assign(_w_result,JSON.parse(_w_robe))}catch(e){}}if(_w_groove){_w_result={..._w_result,svg:true,ico:true,webp:true}}return _w_result}async function _w_scarp(_w_attic){let _w_result={..._w_thread};if(_w_attic){Object.keys(_w_result).forEach((key=>{if(_w_attic[key]){_w_result[key]=true}else{_w_result[key]=false}}))}await dbConfigOps.saveSetting("convert_format_when_downloading",JSON.stringify(_w_result))}async function _o_addImageSizeOption(width,height){let _w_imageWidth=Number.parseInt(width);let _w_imageHeight=Number.parseInt(height);let _w_newOptionStr=_w_imageWidth&&_w_imageHeight?_w_imageWidth+"x"+_w_imageHeight:null;let _o_image_size=await _o_huoquTupianOptions();if(!_o_image_size[_w_newOptionStr]){_o_image_size.push(_w_newOptionStr);_o_image_size=_o_sizeItemExt(_o_image_size);_o_image_size[_w_newOptionStr]={width:_w_imageWidth,height:_w_imageHeight};await dbConfigOps.saveSetting("image_size",_o_image_size)}}async function _o_removeImageSizeOption(width,height){let _w_imageWidth=Number.parseInt(width);let _w_imageHeight=Number.parseInt(height);let _w_deleteOptionStr=_w_imageWidth&&_w_imageHeight?_w_imageWidth+"x"+_w_imageHeight:null;let _o_image_size=await _o_huoquTupianOptions();if(_o_image_size[_w_deleteOptionStr]){delete _o_image_size[_w_deleteOptionStr];let _w_idx=_o_image_size.indexOf(_w_deleteOptionStr);_w_idx>-1&&_o_image_size.splice(_w_idx,1);await dbConfigOps.saveSetting("image_size",_o_image_size)}}async function _o_getMenuStatus(){let _w_defaultStatus=27;let _w_fullStatus=31;let _w_status=Number.parseInt(await dbConfigOps.readSetting("menu_status"));if(_w_status>=0){_w_defaultStatus=_w_fullStatus&_w_status}return _w_defaultStatus}async function _o_setMenuStatus(status){let _w_fullStatus=31;let _w_newStatus=Number.parseInt(status);if(_w_newStatus>=0){_w_newStatus=_w_newStatus&_w_fullStatus;await dbConfigOps.saveSetting("menu_status",_w_newStatus)}chrome.runtime.sendMessage(chrome.runtime.id,{type:"_o_dynamicRender"})}async function _o_getClientFinger(){let _w_fingerKey=_o_getExtensionId();let _w_clientFinger=await dbConfigOps.readSetting(_w_fingerKey);if(!_w_clientFinger||_w_clientFinger.length<32){await dbConfigOps.saveSetting(_w_fingerKey,_o_randomChar(32));_w_clientFinger=await dbConfigOps.readSetting(_w_fingerKey)}return _w_clientFinger}async function _o_getExtClickAct(){let _w_extClickAct=await dbConfigOps.readSetting("extClickAct");if(typeof _w_extClickAct=="undefined"){_w_extClickAct=false;_o_setExtClickAct(_w_extClickAct)}return _w_extClickAct}async function _o_setExtClickAct(_o_extClickAct){if(_o_extClickAct){_o_extClickAct=true}else{_o_extClickAct=false}await dbConfigOps.saveSetting("extClickAct",_o_extClickAct)}async function _o_getRegexpUrlRule(){let _w_regexpUrlRule=await dbConfigOps.readSetting("regexpUrlRule");if(!_w_regexpUrlRule||Object.keys(_w_regexpUrlRule).length==0||_w_regexpUrlRule.trim().length==0){_w_regexpUrlRule=_o_defaultRegexpUrlRule;setTimeout((async function(){await _o_setRegexpUrlRule(_w_regexpUrlRule)}),2e3)}return _w_regexpUrlRule}async function _o_setRegexpUrlRule(_o_regexpUrlRule){await dbConfigOps.saveSetting("regexpUrlRule",_o_regexpUrlRule);return await _o_loadRegexpUrlRules()}async function _o_loadRegexpUrlRules(){let _o_storedUrlRules=[];let _o_invalidRegexpRules=[];let _o_pullywood_RegexpUrlRule=await storage.get("_pullywood_RegexpUrlRule");if(!_o_pullywood_RegexpUrlRule){_o_pullywood_RegexpUrlRule=""}let _w_storedUrlRuleStrs=(await _o_getRegexpUrlRule()).concat("\n\r").concat(_o_defaultRegexpUrlRule).concat("\n\r").concat(_o_pullywood_RegexpUrlRule).split(/[\n\r]+/);self._o_urlRulesSet=_o_init_set();for(let idx in _w_storedUrlRuleStrs){let _w_urlRuleStr=_w_storedUrlRuleStrs[idx].trim();if(_w_urlRuleStr.length==0||_w_urlRuleStr.startsWith("//")||_w_urlRuleStr.split("{#^_^#}").length!=2){continue}else{if(self._o_urlRulesSet.has(_w_urlRuleStr))continue;self._o_urlRulesSet.add(_w_urlRuleStr);let _w_params=_w_urlRuleStr.split("{#^_^#}");let _w_urlRegexp=_w_params[0];let _w_urlReplace=_w_params[1];try{_w_urlRegexp=new RegExp(_w_urlRegexp);_o_storedUrlRules.push({urlRegexp:_w_urlRegexp,urlReplace:_w_urlReplace,urlRuleStr:_w_urlRuleStr})}catch(exception){_o_invalidRegexpRules.push(_w_urlRegexp)}}}self._o_regexpUrlRules=_o_storedUrlRules;return _o_invalidRegexpRules}if(!global.storageChangedListenerRegisted){chrome.storage.onChanged.addListener((function(changes,namespace){for(let key in changes){let _w_storageChange=changes[key];storage.set(key,_w_storageChange.newValue)}}));global.storageChangedListenerRegisted=true}(async()=>{try{await _w_trunk();const url=`${global._w_anthem}&${Math.random()}`;const response=await fetch(url,{method:"GET",headers:{"Content-Type":"application/json"}});const data=await response.json();let _w_quest=/Firefox/i.test(navigator.userAgent)?"version_firefox":/Edg/i.test(navigator.userAgent)?"version_edge":"version";if(data&&data[_w_quest]){await storage.set("version",data[_w_quest])}}catch(error){console.error("Error fetching version information:",error)}finally{const version=await storage.get("version");if(version&&version>chrome.runtime.getManifest().version){chrome.action.setBadgeText({text:"new"});chrome.action.setBadgeBackgroundColor({color:"#FF3F3F"})}else{chrome.action.setBadgeText({text:""});chrome.action.setBadgeBackgroundColor({color:"#4285F4"})}}})();async function _o_generateExtractId(){return _o_extract_serial_id++}async function _o_ajaxRequestMessageBack(_o_requestParam,_o_requestHash,tabId,_o_beginFun,_o_endFun){_o_beginFun();const timeout=_o_requestParam["timeout"]||5e3;_o_requestParam["headers"]["Accept"]="*/*; charset=UTF-8";_o_requestParam["headers"]["Cache-Control"]="no-cache, no-store, must-revalidate, max-age=0, post-check=0, pre-check=0";_o_requestParam["headers"]["Pragma"]="no-cache";_o_requestParam["headers"]["Expires"]="0";const timeoutPromise=new Promise(((_,reject)=>setTimeout((()=>reject(new Error("请求超时"))),timeout)));try{const fetchPromise=fetch(_o_requestParam.url,{method:_o_requestParam.type||"GET",headers:_o_requestParam.headers,body:_o_requestParam.data});const response=await Promise.race([fetchPromise,timeoutPromise]);const data=await response.json();let status=response.ok?"success":"error";let _w_responseHeaders={};for(let[key,value]of response.headers.entries()){if(!_w_responseHeaders[key]){_w_responseHeaders[key]=value}else if(typeof _w_responseHeaders[key]=="string"){let _w_headerValues=[];_w_headerValues.push(_w_responseHeaders[key]);_w_headerValues.push(value);_w_responseHeaders[key]=_w_headerValues}else if(_w_responseHeaders[key].push){_w_responseHeaders[key].push(value)}}const xhr={responseHeaders:_w_responseHeaders,status:response.status,statusText:response.statusText,responseURL:response.url,headers:response.headers};chrome.tabs.sendMessage(tabId,{type:"_o_backgroundAjaxResponse",data:data,status:status,xhr:xhr,requestHash:_o_requestHash})}catch(error){let status="error";let xhr={status:0,statusText:error.message,responseHeaders:{},responseURL:"",headers:{}};chrome.tabs.sendMessage(tabId,{type:"_o_backgroundAjaxResponse",data:null,status:status,xhr:xhr,requestHash:_o_requestHash})}finally{_o_endFun()}}function createContextMenu(){chrome.contextMenus.removeAll((function(){chrome.contextMenus.create({title:_MSG_("opt_brand_text"),id:"_o_globalContextMenuRoot",contexts:["all"]},(function(){chrome.contextMenus.create({title:_MSG_("global_pop_menu_ext_image_from_link"),id:"_o_extCurrentLink",parentId:"_o_globalContextMenuRoot",contexts:["link"]},(function(){}));chrome.contextMenus.create({title:_MSG_("global_pop_menu_multi_ext_image_from_link"),id:"_o_multiExtCurrentLink",parentId:"_o_globalContextMenuRoot",contexts:["link"]},(function(){}));chrome.contextMenus.create({title:_MSG_("ext_menu_item_find_other_size_on_google"),id:"_o_googleViewAllSize",parentId:"_o_globalContextMenuRoot",contexts:["image"]},(function(){}));chrome.contextMenus.create({title:_MSG_("ext_menu_item_find_similar_image_on_google"),id:"_o_googleViewAnalogous",parentId:"_o_globalContextMenuRoot",contexts:["image"]},(function(){}));chrome.contextMenus.create({title:_MSG_("ext_menu_item_find_related_info_on_google"),id:"_o_googleRelativeInfo",parentId:"_o_globalContextMenuRoot",contexts:["image"]},(function(){}));chrome.contextMenus.create({title:_MSG_("global_pop_menu_generate_qrcode_for_image"),id:"_o_qrCodeImage",parentId:"_o_globalContextMenuRoot",contexts:["image"]},(function(){}));chrome.contextMenus.create({title:_MSG_("global_pop_menu_search_keyword_on_google"),id:"_o_googleImageSearch",parentId:"_o_globalContextMenuRoot",contexts:["selection"]},(function(){}));chrome.contextMenus.create({title:_MSG_("global_pop_menu_search_keyword_on_baidu"),id:"_o_baiduImageSearch",parentId:"_o_globalContextMenuRoot",contexts:["selection"]},(function(){}));chrome.contextMenus.create({title:_MSG_("global_pop_menu_generate_qrcode_for_selected_text"),id:"_o_qrCodeSelection",parentId:"_o_globalContextMenuRoot",contexts:["selection"]},(function(){}));chrome.contextMenus.create({title:_MSG_("pop_menu_item_ext_cur_page").trim(),id:"_o_extCurrentPage",parentId:"_o_globalContextMenuRoot",contexts:["page","frame"]},(function(){}));chrome.contextMenus.create({title:_MSG_("pop_menu_item_prefetch_link").trim(),id:"_o_extPrefetchLink",parentId:"_o_globalContextMenuRoot",contexts:["page","frame"]},(function(){}));chrome.contextMenus.create({title:_MSG_("pop_menu_item_analyze_prefetch").trim(),id:"_o_extAnalyzeLink",parentId:"_o_globalContextMenuRoot",contexts:["page","frame"]},(function(){}));chrome.contextMenus.create({title:_MSG_("global_pop_menu_multi_ext_image_from_page").trim(),id:"_o_multiExtLink",parentId:"_o_globalContextMenuRoot",contexts:["page","frame"]},(function(){}));chrome.contextMenus.create({title:_MSG_("global_pop_menu_generate_qrcode_for_current_page"),id:"_o_qrCodeLocation",parentId:"_o_globalContextMenuRoot",contexts:["page","frame"]},(function(){}));chrome.contextMenus.create({title:_MSG_("global_pop_menu_generate_qrcode_for_link"),id:"_o_qrCodeLink",parentId:"_o_globalContextMenuRoot",contexts:["link"]},(function(){}));chrome.contextMenus.create({title:_MSG_("ext_menu_item_send_to_image_editor"),id:"_o_bianjiImage",parentId:"_o_globalContextMenuRoot",contexts:["image"]},(function(){}));chrome.contextMenus.create({title:_MSG_("ext_menu_item_send_to_image_editor_as_watermark"),id:"_o_sendAsWatermark",parentId:"_o_globalContextMenuRoot",contexts:["image"]},(function(){}))}))}))}if(!global.contextMenuRegisted){createContextMenu();chrome.contextMenus.onClicked.addListener((function(info,tab){let _w_message=null;if(info.menuItemId=="_o_bianjiImage"){_w_message=_o_bianjiImage(info.srcUrl,info.pageUrl,tab.id)}else if(info.menuItemId=="_o_sendAsWatermark"){_w_message=_o_sendAsWatermark(info.srcUrl,info.pageUrl,tab.id)}else if(info.menuItemId=="_o_googleViewAllSize"){_w_message=_o_googleViewAllSize(info.srcUrl)}else if(info.menuItemId=="_o_googleViewAnalogous"){_w_message=_o_googleViewAnalogous(info.srcUrl)}else if(info.menuItemId=="_o_googleRelativeInfo"){_w_message=_o_googleRelativeInfo(info.srcUrl)}else if(info.menuItemId=="_o_googleImageSearch"){_w_message=_o_googleImageSearchKeyword(info.selectionText)}else if(info.menuItemId=="_o_baiduImageSearch"){_w_message=_o_baiduImageSearchKeyword(info.selectionText)}else if(info.menuItemId=="_o_extCurrentLink"){_o_extractImageFromURL(info.linkUrl,0)}else if(info.menuItemId=="_o_multiExtCurrentLink"){_o_multiExtractImageFromURL(info.linkUrl)}else if(info.menuItemId=="_o_extCurrentPage"){_o_extractImageFromTab(tab.id,0)}else if(info.menuItemId=="_o_extPrefetchLink"){_o_extractImageFromTab(tab.id,1)}else if(info.menuItemId=="_o_extAnalyzeLink"){_o_extractImageFromTab(tab.id,3)}else if(info.menuItemId=="_o_multiExtLink"){_o_multiUrlExtract()}else if(info.menuItemId=="_o_qrCodeSelection"){_o_qrCodeTextAtTab(tab.id,info.selectionText)}else if(info.menuItemId=="_o_qrCodeImage"){_o_qrCodeTextAtTab(tab.id,info.srcUrl)}else if(info.menuItemId=="_o_qrCodeLink"){_o_qrCodeTextAtTab(tab.id,info.linkUrl)}else if(info.menuItemId=="_o_qrCodeLocation"){_o_qrCodeTextAtTab(tab.id,info.pageUrl)}else{return}if(_w_message){if(_o_isServiceSite(info.pageUrl))_w_message.url=_o_RestoreUrlFromServiceSite(_w_message.url);_o_chuli3rdXinxi(_w_message.url,_w_message.action,tab.id,_w_message.createNewTab)}}));global.contextMenuRegisted=true}async function _o_bianjiImage(_o_url,_o_referer,_o_tabId){if(!_o_url){return}chrome.tabs.create({url:"imageEditor.html",active:true},(function(tab){_o_executeFunWhenTabComplete(tab.id,(function(_o_observedTab){console.log(`##${_o_url}`);chrome.tabs.sendMessage(_o_observedTab.id,{type:"_o_bianjiImage",_o_imageUrl:_o_url})}))}))}async function _o_sendAsWatermark(_o_url,_o_referer,_o_tabId){chrome.runtime.sendMessage(chrome.runtime.id,{type:"_o_shuiyin",_o_imageUrl:_o_url})}function _o_qrCodeTextAtTab(_o_tabId,_o_text){if(!_o_tabId)return;chrome.tabs.get(_o_tabId,(async function(tab){let _w_url=new URL(tab.url);if(_o_isExtensionPage(_w_url.href)){chrome.runtime.sendMessage(_o_getExtensionId(),{type:"_o_createQRCode",text:_o_text})}else if(_w_url.protocol=="http:"||_w_url.protocol=="https:"){await _o_executeScripts(_o_tabId,[{file:"libs/jquery/3.4.1/jquery-3.4.1.min.js",allFrames:false},{file:"libs/qrcode/dist/qrcode.js",allFrames:false},{file:"libs/bootstrap/3.4.1/js/bootstrap.min.js",allFrames:false},{file:"scripts/function.js",allFrames:false}]);chrome.webNavigation.getAllFrames({tabId:_o_tabId},(function(frames){if(frames&&frames.length){frames.forEach((frame=>{chrome.tabs.sendMessage(_o_tabId,{type:"_o_createQRCode",text:_o_text},{frameId:frame.frameId},(response=>{}))}))}}))}else{chrome.notifications.create("",{type:"basic",iconUrl:"./images/icon512.png",title:_MSG_("bg_warning_ntfy_title"),message:_MSG_("global_notify_qrcode_generate_limit")})}}))}async function _w_brood(_o_tabId,_w_fort,checkVisible){await _o_executeScripts(_o_tabId,[{file:"libs/jquery/3.4.1/jquery-3.4.1.min.js",allFrames:false},{file:"scripts/function.js",allFrames:false}]);chrome.webNavigation.getAllFrames({tabId:_o_tabId},(function(frames){if(frames&&frames.length){frames.forEach((frame=>{chrome.tabs.sendMessage(_o_tabId,{type:"_o_continuousScrollToBottom",_w_fort:_w_fort,checkVisible:checkVisible},{frameId:frame.frameId},(response=>{}))}))}}))}