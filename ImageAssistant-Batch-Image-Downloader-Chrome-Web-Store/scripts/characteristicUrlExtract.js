/**
 * ImageAssistant
 * Project Home: http://www.pullywood.com/ImageAssistant/
 * Author: Joey
 * Copyright (C) 2013-2024 普利坞(Pullywood.com)
**/
"use strict";function _o_numberSplit(_w_sortedUrls){let _w_splitedUrls=[];for(let idx in _w_sortedUrls){let _w_url=_w_sortedUrls[idx];if("string"!=typeof _w_url||!_w_url.startsWith("http"))continue;let _w_urlFragements=_w_url.split(/([0-9]+)/);_w_splitedUrls.push(_w_urlFragements)}return _w_splitedUrls}function _o_spliterSplit(_w_sortedUrls){let _w_splitedUrls=[];for(let idx in _w_sortedUrls){let _w_url=_w_sortedUrls[idx];if("string"!=typeof _w_url||!_w_url.startsWith("http"))continue;let _w_urlFragements=_w_url.split(/([^0-9a-zA-Z%]+|\d+(?=[\/_\?#]))/);let _w_urlFragements_=_w_url.split(/([^0-9a-zA-Z%\-_]+)/);_w_splitedUrls.push(_w_urlFragements);if(JSON.stringify(_w_urlFragements)!=JSON.stringify(_w_urlFragements_)){_w_splitedUrls.push(_w_urlFragements_)}}return _w_splitedUrls}async function _o_characteristicExtract(_w_splitFun,_w_msgChannel,_w_closePage){let _w_links=[...document.links];let frames=window.frames;for(let i=0;i<frames.length;++i){try{_w_links=_w_links.concat([...frames[i].document.links])}catch(e){}}let _w_sortedUrls=[];let _w_linkUrlMapper={};let _w_windowLoc=window.location.href;if(_w_windowLoc.indexOf("#")>0)_w_windowLoc=_w_windowLoc.substring(0,_w_windowLoc.indexOf("#"));for(let idx in _w_links){let _w_link=_w_links[idx];if(_w_link.protocol&&(_w_link.protocol=="http:"||_w_link.protocol=="https:")){let _w_href=_w_link.href.trim();if(_w_href.indexOf("#")>0)_w_href=_w_href.substring(0,_w_href.indexOf("#"));if(_w_sortedUrls.indexOf(_w_href)<0){_w_sortedUrls.push(_w_href);_w_linkUrlMapper[_w_href]=_w_link}else if(_w_link.text.trim().length>_w_linkUrlMapper[_w_href].text.trim().length){_w_linkUrlMapper[_w_href]=_w_link}}}if(_w_sortedUrls.indexOf(_w_windowLoc)<0){_w_sortedUrls.push(_w_windowLoc)}_w_linkUrlMapper[_w_windowLoc]=$("<a />",{href:_w_windowLoc,title:document.title,text:document.title})[0];let _w_splitedUrls=_w_splitFun(_w_sortedUrls);let _w_relativeUrls={};for(let i=0;i<_w_splitedUrls.length;++i){for(let j=i+1;j<_w_splitedUrls.length;++j){let _w_originItem=_w_splitedUrls[i];let _w_compareItem=_w_splitedUrls[j];if(_w_originItem.length!=_w_compareItem.length)continue;let _w_diffCount=0;let _w_fragementLength=_w_originItem.length;let _w_joinedStrPattern="";let _w_joinedStrBeforeDiff="";let _w_joinedStrAfterDiff="";let _w_diffIndex=0;let _w_diffList=[];for(let cnt=0;cnt<_w_fragementLength;++cnt){if(_w_originItem[cnt]!=_w_compareItem[cnt]){if(_w_diffCount!=0){_w_diffCount=Number.MAX_SAFE_INTEGER;break}_w_joinedStrBeforeDiff=_w_joinedStrPattern;_w_joinedStrPattern="";_w_diffIndex=cnt;_w_diffList.push(_w_originItem[cnt]);_w_diffList.push(_w_compareItem[cnt]);_w_diffCount++}else{_w_joinedStrPattern+=_w_originItem[cnt]}}_w_joinedStrAfterDiff=_w_joinedStrPattern;_w_joinedStrPattern=_w_joinedStrBeforeDiff+"*"+_w_joinedStrAfterDiff;if(_w_diffCount!=1){continue}let _w_joinFun=function(a,b){return a+b};let _w_urlList=[_w_originItem.reduce(_w_joinFun),_w_compareItem.reduce(_w_joinFun)];let _w_container=_w_relativeUrls[_w_joinedStrPattern];if(_w_container==null){_w_container={};_w_container["joinedStrBeforeDiff"]=_w_joinedStrBeforeDiff;_w_container["joinedStrAfterDiff"]=_w_joinedStrAfterDiff;_w_container["joinedStrPattern"]=_w_joinedStrPattern;_w_container["diffIndex"]=_w_diffIndex;_w_container["diffIsNumeric"]=true;_w_container["diffBreakCount"]=0;_w_container["diffList"]=_w_diffList;_w_container["urlList"]=_w_urlList;_w_container["containCurrentPageUrl"]=false;_w_container["currentPageUrl"]=_w_windowLoc;_w_relativeUrls[_w_joinedStrPattern]=_w_container}else{for(let idx in _w_diffList){if(_w_container["diffList"].indexOf(_w_diffList[idx])<0){_w_container["diffList"].push(_w_diffList[idx])}}for(let idx in _w_urlList){if(_w_container["urlList"].indexOf(_w_urlList[idx])<0){_w_container["urlList"].push(_w_urlList[idx])}}}if(_w_windowLoc==_w_urlList[0]||_w_windowLoc==_w_urlList[1]){_w_container["containCurrentPageUrl"]=true}}}let _w_relativeCollections=[];for(let pattern in _w_relativeUrls){_w_relativeCollections.push(_w_relativeUrls[pattern])}for(let idx in _w_relativeCollections){let _w_relativeCollection=_w_relativeCollections[idx];_w_relativeCollection["diffList"].sort((function(a,b){if(jQuery.isNumeric(a)&&jQuery.isNumeric(b)){return parseInt(a)-parseInt(b)}else{return a-b}}));let _w_breakCount=0;let _w_maxBreakCount=5;let _w_diffList=_w_relativeCollection["diffList"];for(let idx=0;idx<_w_diffList.length-1;++idx){if(idx==0&&_w_diffList[idx]==""){continue}else if(!jQuery.isNumeric(_w_diffList[idx])||!jQuery.isNumeric(_w_diffList[idx+1])){_w_breakCount=Number.MAX_VALUE;_w_relativeCollection["diffIsNumeric"]=false}else if(_w_diffList[idx+1]-_w_diffList[idx]>1){_w_breakCount+=1}}_w_relativeCollection["diffBreakCount"]=_w_breakCount;if(_w_breakCount>_w_maxBreakCount){_w_relativeCollection["fillList"]=_w_relativeCollection["diffList"]}else if(_w_diffList[_w_diffList.length-1]-_w_diffList.length>1024){_w_relativeCollection["fillList"]=_w_relativeCollection["diffList"]}else{let _w_fillLength=_w_diffList[0].toString()[0]=="0"&&_w_diffList[0].toString().length>1?_w_diffList[0].toString().length:1;_w_relativeCollection["fillList"]=[];for(let i=0;i<=_w_diffList[_w_diffList.length-1];++i){_w_relativeCollection["fillList"].push(_o_numberToFixedLengthStr(i,_w_fillLength))}}let _w_joinedStrBeforeDiff=_w_relativeCollection["joinedStrBeforeDiff"];let _w_joinedStrAfterDiff=_w_relativeCollection["joinedStrAfterDiff"];_w_relativeCollection["urlList"]=[];_w_relativeCollection["urlText"]={};_w_diffList=_w_relativeCollection["diffList"];for(let itemIdx in _w_diffList){let _w_diffItem=_w_diffList[itemIdx];let _w_url=_w_joinedStrBeforeDiff+_w_diffItem+_w_joinedStrAfterDiff;let _w_linkText=_w_linkUrlMapper[_w_url]?_w_linkUrlMapper[_w_url].text:"无文字链接["+_w_diffItem+"]";_w_linkText=_w_linkText.trim().length>0?_w_linkText.trim():_w_url;_w_relativeCollection["urlList"].push(_w_url);_w_relativeCollection["urlText"][_w_url]=_w_linkText}_w_relativeCollection["fillUrlList"]=[];_w_relativeCollection["fillUrlText"]={};let _w_fillList=_w_relativeCollection["fillList"];let _w_filledWithSpecialUrl=false;for(let itemIdx in _w_fillList){let _w_fillItem=_w_fillList[itemIdx];let _w_url=_w_joinedStrBeforeDiff+_w_fillItem+_w_joinedStrAfterDiff;let _w_linkText=_w_linkUrlMapper[_w_url]?_w_linkUrlMapper[_w_url].text:"智能填充链接["+_w_fillItem+"]";_w_linkText=_w_linkText.trim().length>0?_w_linkText.trim():_w_url;let _w_joinedStrBeforeDiffChar=_w_joinedStrBeforeDiff.substr(-1);if(!_w_filledWithSpecialUrl&&(_w_joinedStrBeforeDiffChar=="-"||_w_joinedStrBeforeDiffChar=="_"||_w_joinedStrBeforeDiffChar=="/")&&(_w_joinedStrAfterDiff.length==0||_w_joinedStrAfterDiff[0]==".")&&(_w_fillItem==0||_w_fillItem==1)){let _w_url_;if(_w_joinedStrBeforeDiffChar=="/"){_w_url_=_w_joinedStrBeforeDiff}else{_w_url_=_w_joinedStrBeforeDiff.slice(0,-1)+_w_joinedStrAfterDiff}let _w_linkText_=_w_linkUrlMapper[_w_url_]?_w_linkUrlMapper[_w_url_].text:"智能填充链接[ ]";_w_relativeCollection["fillUrlList"].push(_w_url_);_w_relativeCollection["fillUrlText"][_w_url_]=_w_linkText_;_w_filledWithSpecialUrl=true;if(_w_relativeCollection["currentPageUrl"]==_w_url_){_w_relativeCollection["containCurrentPageUrl"]=true;_w_relativeCollection["urlList"].push(_w_url_);_w_relativeCollection["urlText"][_w_url_]=_w_linkText_}}_w_relativeCollection["fillUrlList"].push(_w_url);_w_relativeCollection["fillUrlText"][_w_url]=_w_linkText}}_w_relativeCollections.sort((function(a,b){let _w_result=0;if(a["containCurrentPageUrl"]&&!b["containCurrentPageUrl"]){_w_result=-1}else if(!a["containCurrentPageUrl"]&&b["containCurrentPageUrl"]){_w_result=1}if(_w_result==0){if(a["diffIsNumeric"]&&!b["diffIsNumeric"]){_w_result=-1}else if(!a["diffIsNumeric"]&&b["diffIsNumeric"]){_w_result=1}}if(_w_result==0){_w_result=a["diffBreakCount"]-b["diffBreakCount"]}if(_w_result==0){if(a["diffList"]&&b["diffList"]){_w_result=b["diffList"].length-a["diffList"].length}else{_w_result=a-b}}if(_w_result==0&&a.diffIndex!=null&&b.diffIndex!=null){_w_result=a.diffIndex-b.diffIndex}return _w_result}));let _w_linkPairs={};Object.entries(_w_linkUrlMapper).forEach((arr=>{_w_linkPairs[arr[0]]=arr[1].text}));let _w_sendLinks=function(){chrome.runtime.sendMessage(chrome.runtime.id,{type:"_o_tezhengExt",collections:_w_relativeCollections,links:_w_linkPairs,currentPageUrl:_w_windowLoc,currentPageTitle:document.title,channel:_w_msgChannel})};setTimeout((()=>{_w_sendLinks();_w_closePage&&_o_sendMsgToCloseTab()}),500)}if(!global.characteristicExtractMessageHandlerRegisted){chrome.runtime.onMessage.addListener(((message,sender,sendResponse)=>{try{switch(message.type){case"_o_characteristicExtract":(async()=>{await _o_characteristicExtract(window[message._o_spliterSplit],message._o_msgChannel,message._o_closePage);sendResponse({status:`${message.type} Executed`})})();return true}}catch(error){console.log(message);console.error(error)}}));global.characteristicExtractMessageHandlerRegisted=true}