/**
 * ImageAssistant
 * Project Home: http://www.pullywood.com/ImageAssistant/
 * Author: Joey
 * Copyright (C) 2013-2024 普利坞(Pullywood.com)
**/
"use strict";if(typeof global==="undefined"){if(typeof window!=="undefined"){window.global=window}else{globalThis.global=globalThis}}global._o_image=null;global._o_filename="";global._o_reader=null;global._o_canvas=null;global._o_ctx=null;global._o_font_list=[];global._o_currentTabId=null;global._o_watermarkConfigure=null;global._o_watermarkReader=null;global._o_shuiyin=null;global._o_watermarkQrCodeImage=null;global._o_img_load_analyzer=_o_createImageLoadTimeoutSiteAnalyzer(8e3,2);chrome.tabs.getCurrent((function(tab){global._o_currentTabId=tab.id;$(initEditor)}));global._o_watermarkParam={timeout:512,lastExeTime:new Date,timer:null,updateStatics:false,delayAgain:true};global._o_clearDownloadHistoryParam={timeout:2048,lastExeTime:new Date,timer:null,updateStatics:false,delayAgain:true};async function _o_loadImageToMakeWatermark(_w_imageUrl,_w_referer){let _w_filename="";if(!_w_imageUrl.startsWith("data:image")){_w_filename=_w_imageUrl.substring(_w_imageUrl.lastIndexOf("/")+1)}else{_w_filename="ia_"+_o_randomChar(16)+".png"}await _o_makeWatermark(_w_imageUrl,_w_filename,false,false)}function _o_loadWaterMarkImage(_w_imageUrl,_w_referer){if(!_w_imageUrl.startsWith("data:image")){$("#watermarkImageUrl").prop("value",_w_imageUrl).attr("data-referer",_w_referer)}chrome.tabs.update(_o_currentTabId,{active:true},(function(tab){chrome.windows.update(tab.windowId,{focused:true,drawAttention:false},(function(window){}))}));_o_makeImageWatermark(_w_imageUrl,false)}async function _o_makeWatermark(_w_imageUrl,_w_filename,_w_updateWM,_w_downloadNow){if(!_o_image)_o_image=new Image;if(_w_updateWM){await _o_watermark(_o_image,_w_filename,_w_downloadNow)}else{await new Promise(((resolve,reject)=>{_o_image.onload=function(){if(!_w_updateWM){$("#scaleRate").prop("value",1);$("#scWidth").prop("value",_o_image.width);$("#scWidth").attr("max",_o_image.width);$("#scHeight").prop("value",_o_image.height);$("#scHeight").attr("max",_o_image.height);window._o_filename=_w_filename}_o_watermark(this,_w_filename,_w_downloadNow);resolve()};_o_image.onerror=function(){reject(new Error("Image failed to load."))};_o_img_load_analyzer.setImgSrc(_o_image,_w_imageUrl,true)}))}}function _o_makeImageWatermark(_w_watermarkImageUrl,_w_updateWM){if(!_o_shuiyin)_o_shuiyin=new Image;if(_w_updateWM){_o_updateWatermark()}else{_o_shuiyin.onload=function(){if(!_w_updateWM){$("#wmImageCutUp").prop("value",null);$("#wmImageCutRight").prop("value",null);$("#wmImageCutDown").prop("value",null);$("#wmImageCutLeft").prop("value",null);$("#watermarkScaleRate").prop("value",1);$("#wmScWidth").attr("max",_o_shuiyin.width).prop("value",_o_shuiyin.width);$("#wmScHeight").attr("max",_o_shuiyin.height).prop("value",_o_shuiyin.height);$("#brToAlpha").prop("checked",false);$("#brToAlphaReverse").prop("checked",false).prop("disabled",true);$("#pixelAlphaRateRange").prop("value",1).prop("disabled",true);if(_w_watermarkImageUrl==global._o_watermarkConfigure.watermarkImageUrl){$("#wmImageCutUp").prop("value",global._o_watermarkConfigure.imageCutUp);$("#wmImageCutRight").prop("value",global._o_watermarkConfigure.imageCutRight);$("#wmImageCutDown").prop("value",global._o_watermarkConfigure.imageCutDown);$("#wmImageCutLeft").prop("value",global._o_watermarkConfigure.imageCutLeft);$("#watermarkScaleRate").prop("value",global._o_watermarkConfigure.watermarkImageWidth/_o_shuiyin.watermarkImageHeight);$("#wmScWidth").prop("value",global._o_watermarkConfigure.watermarkImageWidth);$("#wmScHeight").prop("value",global._o_watermarkConfigure.watermarkImageHeight);$("#brToAlpha").prop("checked",global._o_watermarkConfigure.brToAlpha);$("#brToAlphaReverse").prop("checked",global._o_watermarkConfigure.brToAlphaReverse).prop("disabled",global._o_watermarkConfigure.brToAlpha?false:true);$("#pixelAlphaRateRange").prop("value",global._o_watermarkConfigure.pixelAlphaRateRange).prop("disabled",window._o_watermarkConfigure.brToAlpha?false:true)}}_o_updateWatermark()};_o_img_load_analyzer.setImgSrc(_o_shuiyin,_w_watermarkImageUrl,true)}}function _o_makeQrCodeWatermark(){let _w_qrCodeFgColor=$("#qrCodeFgColor").prop("value");let _w_qrCodeBgColor=$("#qrCodeBgColor").prop("value");let _w_qrCodeBgRGB=_o_hexToRgb(_w_qrCodeBgColor);let _w_qrCodeAlpha=parseInt($("#qrCodeAlpha").prop("value"))/100;_w_qrCodeBgColor="RGBA("+_w_qrCodeBgRGB.r+", "+_w_qrCodeBgRGB.g+", "+_w_qrCodeBgRGB.b+", "+_w_qrCodeAlpha+")";let _w_qrCodeSize=$("#qrCodeSize").prop("value");let _w_qrCodeText=$("#qrCodeText").prop("value");window._o_watermarkQrCodeImage=_o_Qrcd(_w_qrCodeText,_w_qrCodeSize,_w_qrCodeFgColor,_w_qrCodeBgColor);setTimeout(_o_updateWatermark,256)}function _o_persistWatermarkConfigure(){if(!window._o_watermarkConfigure)window._o_watermarkConfigure={};let _w_watermarkConfigure=window._o_watermarkConfigure;_w_watermarkConfigure.textWatermark=$(".typeMenuItem.textWatermark").is(".active");_w_watermarkConfigure.imageWatermark=$(".typeMenuItem.imageWatermark").is(".active");_w_watermarkConfigure.qrCodeWatermark=$(".typeMenuItem.qrCodeWatermark").is(".active");_w_watermarkConfigure.font=$("select#fontSelecter option:selected").prop("value");_w_watermarkConfigure.fontSize=parseInt($("#fontSize").prop("value"));_w_watermarkConfigure.fontColor=$("#fontColor").prop("value");_w_watermarkConfigure.fontAlpha=parseInt($("#fontAlpha").prop("value"));_w_watermarkConfigure.borderFont=$("#borderFont:checkbox").is(":checked");_w_watermarkConfigure.text=$("#watermarkText").prop("value");_w_watermarkConfigure.imageAlpha=parseInt($("#imageAlpha").prop("value"));if(_o_shuiyin&&_o_isAccessibleUrl(_o_shuiyin.src)){_w_watermarkConfigure.watermarkImageUrl=$("#watermarkImageUrl").prop("value");_w_watermarkConfigure.watermarkImageReferer=$("#watermarkImageReferer").attr("data-referer");_w_watermarkConfigure.imageCutUp=$("#wmImageCutUp").prop("value");_w_watermarkConfigure.imageCutRight=$("#wmImageCutRight").prop("value");_w_watermarkConfigure.imageCutDown=$("#wmImageCutDown").prop("value");_w_watermarkConfigure.imageCutLeft=$("#wmImageCutLeft").prop("value");_w_watermarkConfigure.watermarkImageWidth=$("#wmScWidth").prop("value");_w_watermarkConfigure.watermarkImageHeight=$("#wmScHeight").prop("value");_w_watermarkConfigure.brToAlpha=$("#brToAlpha").prop("checked");_w_watermarkConfigure.brToAlphaReverse=$("#brToAlphaReverse").prop("checked");_w_watermarkConfigure.pixelAlphaRateRange=$("#pixelAlphaRateRange").prop("value")}_w_watermarkConfigure.qrCodeFgolor=$("#qrCodeFgColor").prop("value");_w_watermarkConfigure.qrCodeBgolor=$("#qrCodeBgColor").prop("value");_w_watermarkConfigure.qrCodeSize=$("#qrCodeSize").prop("value");_w_watermarkConfigure.qrCodeAlpha=parseInt($("#qrCodeAlpha").prop("value"));_w_watermarkConfigure.qrCodeBorder=parseInt($("#qrCodeBorder").prop("value"));_w_watermarkConfigure.qrCodeText=$("#qrCodeText").prop("value");_w_watermarkConfigure.tileWatermark=$(".presentationMenuItem.tileWatermark").is(".active");_w_watermarkConfigure.locationWatermark=$(".presentationMenuItem.locationWatermark").is(".active");_w_watermarkConfigure.offsetX=parseInt($("#offsetX").prop("value"));_w_watermarkConfigure.offsetY=parseInt($("#offsetY").prop("value"));_w_watermarkConfigure.marginX=parseInt($("#marginX").prop("value"));_w_watermarkConfigure.marginY=parseInt($("#marginY").prop("value"));_w_watermarkConfigure.rotate=parseInt($("#rotation").prop("value"));_w_watermarkConfigure.alignX=parseInt($("#alignX").prop("value"));_w_watermarkConfigure.alignY=parseInt($("#alignY").prop("value"));_w_watermarkConfigure.middleAlignX=$("#middleAlignX").is(":checked");_w_watermarkConfigure.middleAlignY=$("#middleAlignY").is(":checked");localStorage["watermarkConfigure"]=JSON.stringify(_w_watermarkConfigure);window._o_watermarkConfigure=_w_watermarkConfigure}function _o_loadWatermarkConfigure(){let _w_watermarkConfigure=localStorage["watermarkConfigure"];if(_w_watermarkConfigure&&_w_watermarkConfigure.length>0){_w_watermarkConfigure=JSON.parse(_w_watermarkConfigure);$("select#fontSelecter option[value='"+_w_watermarkConfigure.font+"']").attr("selected",true);$("#fontSizeRange,#fontSize").prop("value",_w_watermarkConfigure.fontSize);$("#fontColor").prop("value",_w_watermarkConfigure.fontColor);$("#fontAlphaRange,#fontAlpha").prop("value",_w_watermarkConfigure.fontAlpha);$("#borderFont:checkbox").prop("checked",_w_watermarkConfigure.borderFont);$("#middleAlignX").prop("checked",_w_watermarkConfigure.middleAlignX);$("#middleAlignY").prop("checked",_w_watermarkConfigure.middleAlignY);$("#watermarkText").prop("value",_w_watermarkConfigure.text);$("#imageAlphaRange,#imageAlpha").prop("value",_w_watermarkConfigure.imageAlpha);if(_w_watermarkConfigure.watermarkImageUrl&&_o_isAccessibleUrl(_w_watermarkConfigure.watermarkImageUrl)){$("#watermarkImageUrl").prop("value",_w_watermarkConfigure.watermarkImageUrl);$("#watermarkImageReferer").attr("data-referer",_w_watermarkConfigure.watermarkImageReferer);$("#wmImageCutUp").prop("value",_w_watermarkConfigure.imageCutUp);$("#wmImageCutRight").prop("value",_w_watermarkConfigure.imageCutRight);$("#wmImageCutDown").prop("value",_w_watermarkConfigure.imageCutDown);$("#wmImageCutLeft").prop("value",_w_watermarkConfigure.imageCutLeft);$("#wmScWidth").prop("value",_w_watermarkConfigure.watermarkImageWidth);$("#wmScHeight").prop("value",_w_watermarkConfigure.watermarkImageHeight);$("#brToAlpha").prop("checked",_w_watermarkConfigure.brToAlpha);$("#brToAlphaReverse").prop("checked",_w_watermarkConfigure.brToAlphaReverse).prop("disabled",_w_watermarkConfigure.brToAlpha?false:true);$("#pixelAlphaRateRange").prop("value",_w_watermarkConfigure.pixelAlphaRateRange).prop("disabled",_w_watermarkConfigure.brToAlpha?false:true)}$("#qrCodeFgColor").prop("value",_w_watermarkConfigure.qrCodeFgolor);$("#qrCodeBgColor").prop("value",_w_watermarkConfigure.qrCodeBgolor);$("#qrCodeSizeRange,#qrCodeSize").prop("value",_w_watermarkConfigure.qrCodeSize);$("#qrCodeAlphaRange,#qrCodeAlpha").prop("value",_w_watermarkConfigure.qrCodeAlpha);$("#qrCodeBorderRange,#qrCodeBorder").prop("value",_w_watermarkConfigure.qrCodeBorder);$("#qrCodeText").prop("value",_w_watermarkConfigure.qrCodeText);$("#offsetXRange,#offsetX").prop("value",_w_watermarkConfigure.offsetX);$("#offsetYRange,#offsetY").prop("value",_w_watermarkConfigure.offsetY);$("#marginXRange,#marginX").prop("value",_w_watermarkConfigure.marginX);$("#marginYRange,#marginY").prop("value",_w_watermarkConfigure.marginY);$("#rotationRange,#rotation").prop("value",_w_watermarkConfigure.rotate);$("#alignXRange,#alignX").prop("value",_w_watermarkConfigure.alignX);$("#alignYRange,#alignY").prop("value",_w_watermarkConfigure.alignY);if(_w_watermarkConfigure.watermarkImageUrl&&_w_watermarkConfigure.watermarkImageUrl.length>0){_o_makeImageWatermark(_w_watermarkConfigure.watermarkImageUrl,false)}if(_w_watermarkConfigure.textWatermark){$(".typeMenuItem.textWatermark").trigger("click")}else if(_w_watermarkConfigure.imageWatermark){$(".typeMenuItem.imageWatermark").trigger("click")}else if(_w_watermarkConfigure.qrCodeWatermark){$(".typeMenuItem.qrCodeWatermark").trigger("click")}if(_w_watermarkConfigure.tileWatermark){$(".presentationMenuItem.tileWatermark").trigger("click")}else if(_w_watermarkConfigure.locationWatermark){$(".presentationMenuItem.locationWatermark").trigger("click")}window._o_watermarkConfigure=_w_watermarkConfigure}else{_o_resetWatermarkConfigure()}}function _o_resetWatermarkConfigure(){let _w_watermarkConfigure={textWatermark:true,imageWatermark:false,qrCodeWatermark:false,font:"微软雅黑",fontSize:32,fontColor:"#000000",fontAlpha:50,borderFont:false,text:_MSG_("editor_watermark_text"),imageAlpha:50,watermarkImageUrl:"https://www.pullywood.com/ImageAssistant/images/logo.png",watermarkImageReferer:"https://www.pullywood.com/",imageCutUp:null,imageCutRight:null,imageCutDown:null,imageCutLeft:null,watermarkImageWidth:128,watermarkImageHeight:128,brToAlpha:true,brToAlphaReverse:false,pixelAlphaRateRange:1,qrCodeFgolor:"#008000",qrCodeBgolor:"#ffffff",qrCodeSize:128,qrCodeAlpha:32,qrCodeBorder:10,qrCodeText:"https://www.pullywood.com/ImageAssistant/",tileWatermark:true,locationWatermark:false,offsetX:0,offsetY:0,marginX:32,marginY:32,rotate:-30,alignX:-20,alignY:-20,middleAlignX:false,middleAlignY:false};localStorage["watermarkConfigure"]=JSON.stringify(_w_watermarkConfigure);_o_loadWatermarkConfigure()}function _o_updateWatermark(){if(!_o_image)return;_o_throttle(window._o_watermarkParam,(async function(){await _o_makeWatermark(_o_image.src,_o_filename,true,false)}),false);_o_persistWatermarkConfigure()}function _o_updateImageWatermark(){if(!_o_shuiyin||!_o_image)return;_o_throttle(window._o_watermarkParam,(function(){_o_makeImageWatermark(_o_image.src,true)}),false);_o_persistWatermarkConfigure()}chrome.runtime.onMessage.addListener((async function(message,sender,callback){message&&message.type=="_o_bianjiImage"&&await _o_loadImageToMakeWatermark(message._o_imageUrl,message._o_referer);message&&message.type=="_o_shuiyin"&&_o_loadWaterMarkImage(message._o_imageUrl,message._o_referer)}));function initEditor(){$("#header_link_container").append($("<a />",{class:"navbar-brand",text:_MSG_("opt_brand_text")}).prepend($("<img />",{src:"./images/icon128.png",id:"brand_text"})));$("#navbar").append($("<ul />",{class:"nav navbar-nav navbar-right"}).append($("<li />").append($("<a />",{id:"_pullywood_home_",target:"_pullywood_",href:"https://www.pullywood.com/",text:_MSG_("opt_navbar_item_pwd_home")}).prepend($("<span />",{class:"glyphicon glyphicon-home"})))).append($("<li />").append($("<a />",{target:"_ImageAssistant_Plus_",href:"https://www.pullywood.com/ImageAssistant_Plus/",text:_MSG_("pop_menu_item_ext_favorite")}).prepend($("<span />",{class:"fab fa-app-store"})))));$("#imageLoader,#multipleImageInput").attr("accept","image/"+"*");document.onpaste=function(event){let _w_blob=event.clipboardData.items[0].getAsFile();if(!_w_blob.type||!_w_blob.type.startsWith("image"))return;let _o_reader=new FileReader;_o_reader.onload=async function(event){await _o_makeWatermark(event.target.result,_o_randomHex(16),false,false)};_o_reader.readAsDataURL(_w_blob)};chrome.fontSettings&&chrome.fontSettings.getFontList((function populateFontList(fontArr){fontArr.sort().reverse();for(let key in fontArr){let _w_fontName=fontArr[key].displayName;_w_fontName=_w_fontName.replace(/^\s\s*/,"").replace(/\s\s*$/,"");if(_w_fontName.match(/[_\-\s]Italic$/)||_w_fontName.match(/[_\-\s](Demi)?[Bb]old$/)||_w_fontName.match(/[_\-\s]Medium$/)||_w_fontName.match(/[_\-\s](Ultra)?[Ll]ight$/)||_w_fontName.match(/[_\-\s]Condensed$/))_o_font_list.push(_w_fontName);else{_o_font_list.push(_w_fontName)}}let $_w_fontSelect=$("#fontSelecter");for(let i=0;i<_o_font_list.length;++i){let _w_fontName=_o_font_list[i];$_w_fontSelect.append($("<option />",{value:_w_fontName,text:_w_fontName,style:"font-family:"+_w_fontName+";",selected:window._o_watermarkConfigure&&window._o_watermarkConfigure.font&&window._o_watermarkConfigure.font==_w_fontName}))}}));$(window).on("resize",_o_updateWatermark);$("#imageLoader").on("change",(function(funEvent){let _w_files=$(this).get(0).files;if(_w_files.length==0)return;let _w_file=_w_files[0];let $_w_this=$(this);if(!_o_reader)_o_reader=new FileReader;_o_reader.onload=async function(event){await _o_makeWatermark(event.target.result,_w_file.name,false,false);$_w_this.val("")};_o_reader.readAsDataURL(_w_file)}));$("#scaleRate,#scWidth,#scHeight").on("change",(function(){let _w_scaleRate=parseFloat($("#scaleRate").prop("value"));let _w_scWidth=parseInt($("#scWidth").prop("value"));let _w_scHeight=parseInt($("#scHeight").prop("value"));let _w_maxWidth=parseInt($("#scWidth").prop("max"));let _w_maxHeight=parseInt($("#scHeight").prop("max"));if($(this).is("#scaleRate")){_w_scWidth=Math.round(_w_maxWidth*_w_scaleRate);_w_scHeight=Math.round(_w_maxHeight*_w_scaleRate)}else if($(this).is("#scWidth")){_w_scaleRate=_w_scWidth/_w_maxWidth;_w_scHeight=Math.round(_w_maxHeight*_w_scaleRate)}else if($(this).is("#scHeight")){_w_scaleRate=_w_scHeight/_w_maxHeight;_w_scWidth=Math.round(_w_maxWidth*_w_scaleRate)}else{return}$("#scaleRate").prop("value",_w_scaleRate);$("#scWidth").prop("value",_w_scWidth);$("#scHeight").prop("value",_w_scHeight);_o_updateWatermark()}));$(".typeMenuItem").on("click",(function(){$(".typeMenuItem").removeClass("active");$(this).addClass("active");$(".typeMenuTab").hide();if($(this).is(".textWatermark")){$(".typeMenuTab.textWatermark").show();_o_updateWatermark()}else if($(this).is(".imageWatermark")){$(".typeMenuTab.imageWatermark").show();_o_updateImageWatermark()}else if($(this).is(".qrCodeWatermark")){$(".typeMenuTab.qrCodeWatermark").show();_o_makeQrCodeWatermark()}}));$("#fontSelecter").on("change",(function(){_o_updateWatermark()}));$("#fontSizeRange,#fontSize").on("change",(function(){if($(this).is("#fontSizeRange")){$("#fontSize").prop("value",$(this).prop("value"))}else if($(this).is("#fontSize")){$("#fontSizeRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#fontColor").on("input",(function(){_o_updateWatermark()}));$("#fontAlphaRange,#fontAlpha").on("change",(function(){if($(this).is("#fontAlphaRange")){$("#fontAlpha").prop("value",$(this).prop("value"))}else if($(this).is("#fontAlpha")){$("#fontAlphaRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#borderFont").on("change",(function(){_o_updateWatermark()}));$("#watermarkText").on("change",(function(){_o_updateWatermark()}));$("#watermarkImage").on("change",(function(funEvent){let _w_files=$(this).get(0).files;if(_w_files.length==0)return;let _w_file=_w_files[0];let $_w_this=$(this);if(!_o_watermarkReader)_o_watermarkReader=new FileReader;_o_watermarkReader.onload=function(event){_o_makeImageWatermark(event.target.result,false)};_o_watermarkReader.readAsDataURL(_w_file)}));$("#wmImageCutUp,#wmImageCutRight,#wmImageCutDown,#wmImageCutLeft").on("change",(function(){if(_o_shuiyin==null)return;let _w_wmImageCutUp=parseInt($("#wmImageCutUp").prop("value"));_w_wmImageCutUp=_w_wmImageCutUp?_w_wmImageCutUp:0;let _w_wmImageCutRight=parseInt($("#wmImageCutRight").prop("value"));_w_wmImageCutRight=_w_wmImageCutRight?_w_wmImageCutRight:0;let _w_wmImageCutDown=parseInt($("#wmImageCutDown").prop("value"));_w_wmImageCutDown=_w_wmImageCutDown?_w_wmImageCutDown:0;let _w_wmImageCutLeft=parseInt($("#wmImageCutLeft").prop("value"));_w_wmImageCutLeft=_w_wmImageCutLeft?_w_wmImageCutLeft:0;let _w_maxWidth=_o_shuiyin.width-_w_wmImageCutLeft-_w_wmImageCutRight;let _w_maxHeight=_o_shuiyin.height-_w_wmImageCutUp-_w_wmImageCutDown;$("#wmScWidth").prop("max",_w_maxWidth);$("#wmScHeight").prop("max",_w_maxHeight);$("#watermarkScaleRate").trigger("change");_o_updateWatermark()}));$("#watermarkScaleRate,#wmScWidth,#wmScHeight").on("change",(function(){if(_o_shuiyin==null)return;let _w_watermarkScaleRate=parseFloat($("#watermarkScaleRate").prop("value"));let _w_wmScWidth=parseInt($("#wmScWidth").prop("value"));let _w_wmScHeight=parseInt($("#wmScHeight").prop("value"));let _w_maxWidth=parseInt($("#wmScWidth").prop("max"));let _w_maxHeight=parseInt($("#wmScHeight").prop("max"));if($(this).is("#watermarkScaleRate")){_w_wmScWidth=Math.round(_w_maxWidth*_w_watermarkScaleRate);_w_wmScHeight=Math.round(_w_maxHeight*_w_watermarkScaleRate)}else if($(this).is("#wmScWidth")){_w_watermarkScaleRate=_w_wmScWidth/_w_maxWidth;_w_wmScHeight=Math.round(_w_maxHeight*_w_watermarkScaleRate)}else if($(this).is("#wmScHeight")){_w_watermarkScaleRate=_w_wmScHeight/_w_maxHeight;_w_wmScWidth=Math.round(_w_maxWidth*_w_watermarkScaleRate)}else{return}$("#watermarkScaleRate").prop("value",_w_watermarkScaleRate);$("#wmScWidth").prop("value",_w_wmScWidth);$("#wmScHeight").prop("value",_w_wmScHeight);_o_updateImageWatermark()}));$("#brToAlpha,#brToAlphaReverse").on("change",(function(){if($("#brToAlpha").is(":checked")){$("#brToAlphaReverse,#pixelAlphaRateRange").attr("disabled",false)}else{$("#brToAlphaReverse,#pixelAlphaRateRange").attr("disabled",true)}_o_updateWatermark()}));$("#pixelAlphaRateRange").on("change",(function(){_o_updateWatermark()}));$("#imageAlphaRange,#imageAlpha").on("change",(function(){if($(this).is("#imageAlphaRange")){$("#imageAlpha").prop("value",$(this).prop("value"))}else if($(this).is("#imageAlpha")){$("#imageAlphaRange").prop("value",$(this).prop("value"))}else{return}_o_updateImageWatermark()}));$("#qrCodeFgColor").on("input",(function(){_o_makeQrCodeWatermark()}));$("#qrCodeBgColor").on("input",(function(){_o_makeQrCodeWatermark()}));$("#qrCodeSizeRange,#qrCodeSize").on("change",(function(){if($(this).is("#qrCodeSizeRange")){$("#qrCodeSize").prop("value",$(this).prop("value"))}else if($(this).is("#qrCodeSize")){$("#qrCodeSizeRange").prop("value",$(this).prop("value"))}else{return}_o_makeQrCodeWatermark()}));$("#qrCodeAlphaRange,#qrCodeAlpha").on("change",(function(){if($(this).is("#qrCodeAlphaRange")){$("#qrCodeAlpha").prop("value",$(this).prop("value"))}else if($(this).is("#qrCodeAlpha")){$("#qrCodeAlphaRange").prop("value",$(this).prop("value"))}else{return}_o_makeQrCodeWatermark()}));$("#qrCodeBorderRange,#qrCodeBorder").on("change",(function(){if($(this).is("#qrCodeBorderRange")){$("#qrCodeBorder").prop("value",$(this).prop("value"))}else if($(this).is("#qrCodeBorder")){$("#qrCodeBorderRange").prop("value",$(this).prop("value"))}else{return}_o_makeQrCodeWatermark()}));$("#qrCodeText").on("input",(function(){_o_makeQrCodeWatermark()}));$(".presentationMenuItem").on("click",(function(){$(".presentationMenuItem").removeClass("active");$(this).addClass("active");$(".presentationMenuTab").hide();if($(this).is(".tileWatermark")){$(".presentationMenuTab.tileWatermark").show()}else if($(this).is(".locationWatermark")){$(".presentationMenuTab.locationWatermark").show()}_o_updateWatermark()}));$("#offsetXRange,#offsetX").on("change",(function(){if($(this).is("#offsetXRange")){$("#offsetX").prop("value",$(this).prop("value"))}else if($(this).is("#offsetX")){$("#offsetXRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#offsetYRange,#offsetY").on("change",(function(){if($(this).is("#offsetYRange")){$("#offsetY").prop("value",$(this).prop("value"))}else if($(this).is("#offsetY")){$("#offsetYRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#marginXRange,#marginX").on("change",(function(){if($(this).is("#marginXRange")){$("#marginX").prop("value",$(this).prop("value"))}else if($(this).is("#marginX")){$("#marginXRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#marginYRange,#marginY").on("change",(function(){if($(this).is("#marginYRange")){$("#marginY").prop("value",$(this).prop("value"))}else if($(this).is("#marginY")){$("#marginYRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#rotationRange,#rotation").on("change",(function(){if($(this).is("#rotationRange")){$("#rotation").prop("value",$(this).prop("value"))}else if($(this).is("#rotation")){$("#rotationRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#alignXRange,#alignX").on("change",(function(){if($(this).is("#alignXRange")){$("#alignX").prop("value",$(this).prop("value"))}else if($(this).is("#alignX")){$("#alignXRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#alignYRange,#alignY").on("change",(function(){if($(this).is("#alignYRange")){$("#alignY").prop("value",$(this).prop("value"))}else if($(this).is("#alignY")){$("#alignYRange").prop("value",$(this).prop("value"))}else{return}_o_updateWatermark()}));$("#middleAlignX").on("change",(function(){if($(this).is(":checked")){$("#alignXRange,#alignX").attr("disabled",true)}else{$("#alignXRange,#alignX").attr("disabled",false)}_o_updateWatermark()}));$("#middleAlignY").on("change",(function(){if($(this).is(":checked")){$("#alignYRange,#alignY").attr("disabled",true)}else{$("#alignYRange,#alignY").attr("disabled",false)}_o_updateWatermark()}));$("#downloadCanvasImage").on("click",(async function(){await _o_makeWatermark(_o_image.src,_o_filename,false,true)}));$("#batchImage").on("click",(function(){$("#multipleImageInput").get(0).click()}));$("#openDownloadFolderBtn").on("click",_o_showDefaultFolder);$("#multipleImageInput").on("change",(function(){let _w_files=$(this).get(0).files;let $_w_this=$(this);let _w_keys=Object.keys(_w_files);let _w_itemNumber=_w_keys.length;$(window).off("resize",_o_updateWatermark);let _w_documentTitle=document.title;(function makeWM(){if(_w_keys.length==0){document.title=_MSG_("editor_watermark_batch_status")+_MSG_("editor_watermark_batch_status_finished");setTimeout((function(){document.title=_w_documentTitle}),2e3);$(window).on("resize",_o_updateWatermark);_o_updateWatermark();$_w_this.val("")}else{document.title=_MSG_("editor_watermark_batch_status")+(_w_itemNumber-_w_keys.length)+"/"+_w_itemNumber;let _w_file=_w_files[_w_keys.shift()];if(!_o_reader)_o_reader=new FileReader;_o_reader.onload=async function(event){let _w_stm=(new Date).getTime();await _o_makeWatermark(event.target.result,_w_file.name,false,true);let _w_etm=(new Date).getTime();let _w_tmCost=_w_etm-_w_stm;let _w_nextDelay=_w_tmCost>256?_w_tmCost*2:256;(function ctAction(){chrome.downloads.search({urlRegex:"^data:image/.*$",state:"in_progress"},(function(data){if(data.length>2){setTimeout(ctAction,_w_nextDelay)}else{makeWM()}}))})()};_o_reader.readAsDataURL(_w_file)}})()}));$("#resetConfigure").on("click",(function(){_o_resetWatermarkConfigure();_o_updateWatermark()}));document.title=_MSG_("editor_i18n_1000");$("#editor_i18n_1001").html(_MSG_("editor_i18n_1001"));$("#editor_i18n_1002").html(_MSG_("editor_i18n_1002"));$("#editor_i18n_1003").html(_MSG_("editor_i18n_1003"));$("#editor_i18n_1004").html(_MSG_("editor_i18n_1004"));$("#editor_i18n_1005").html(_MSG_("editor_i18n_1005"));$("#editor_i18n_1006").html(_MSG_("editor_i18n_1006"));$("#editor_i18n_1007").html(_MSG_("editor_i18n_1007"));$("#editor_i18n_1008").html(_MSG_("editor_i18n_1008"));$("#editor_i18n_1009").html(_MSG_("editor_i18n_1009"));$("#editor_i18n_1010").html(_MSG_("editor_i18n_1010"));$("#editor_i18n_1011").html(_MSG_("editor_i18n_1011"));$("#editor_i18n_1012").html(_MSG_("editor_i18n_1012"));$("#editor_i18n_1013").html(_MSG_("editor_i18n_1013"));$("#editor_i18n_1014").html(_MSG_("editor_i18n_1014"));$("#editor_i18n_1015").html(_MSG_("editor_i18n_1015"));$("#wmImageCutUp").attr("placeHolder",_MSG_("editor_i18n_1016"));$("#wmImageCutRight").attr("placeHolder",_MSG_("editor_i18n_1017"));$("#wmImageCutDown").attr("placeHolder",_MSG_("editor_i18n_1018"));$("#wmImageCutLeft").attr("placeHolder",_MSG_("editor_i18n_1019"));$("#editor_i18n_1020").html(_MSG_("editor_i18n_1020"));$("#editor_i18n_1021").html(_MSG_("editor_i18n_1021"));$("#editor_i18n_1022").html(_MSG_("editor_i18n_1022"));$("#editor_i18n_1023").html(_MSG_("editor_i18n_1023"));$("#editor_i18n_1024").html(_MSG_("editor_i18n_1024"));$("#editor_i18n_1025").html(_MSG_("editor_i18n_1025"));$("#editor_i18n_1026").html(_MSG_("editor_i18n_1026"));$("#editor_i18n_1027").html(_MSG_("editor_i18n_1027"));$("#editor_i18n_1028").html(_MSG_("editor_i18n_1028"));$("#editor_i18n_1029").html(_MSG_("editor_i18n_1029"));$("#editor_i18n_1030").html(_MSG_("editor_i18n_1030"));$("#editor_i18n_1031").html(_MSG_("editor_i18n_1031"));$("#editor_i18n_1032").html(_MSG_("editor_i18n_1032"));$("#editor_i18n_1033").html(_MSG_("editor_i18n_1033"));$("#editor_i18n_1034").html(_MSG_("editor_i18n_1034"));$("#editor_i18n_1035").html(_MSG_("editor_i18n_1035"));$("#editor_i18n_1036").html(_MSG_("editor_i18n_1036"));$("#editor_i18n_1037").html(_MSG_("editor_i18n_1037"));$("#editor_i18n_1038").html(_MSG_("editor_i18n_1038"));$("#editor_i18n_1039").html(_MSG_("editor_i18n_1039"));$("#editor_i18n_1040").html(_MSG_("editor_i18n_1040"));$("#editor_i18n_1041").html(_MSG_("editor_i18n_1041"));$("#editor_i18n_1042").html(_MSG_("editor_i18n_1042"));$("#editor_i18n_1043").html(_MSG_("editor_i18n_1043"));$("#editor_i18n_1044").html(_MSG_("editor_i18n_1044"));$("#editor_i18n_1045").html(_MSG_("editor_i18n_1045"));$("#editor_i18n_1046").html(_MSG_("editor_i18n_1046"));$("#editor_i18n_1047").html(_MSG_("editor_i18n_1047"));_o_loadWatermarkConfigure()}async function _o_watermark(_w_image,_w_filename,_w_downloadNow){if(!_o_canvas)_o_canvas=$("#canvas").get(0);let $_w_canvas_container=$(_o_canvas).parent();_o_canvas.width=$("#scWidth").prop("value");_o_canvas.height=$("#scHeight").prop("value");let _w_maxWidth=_o_canvas.parentElement.offsetWidth;if(_o_canvas.width<=_w_maxWidth){_o_canvas.style.width=_o_canvas.width+"px";_o_canvas.style.height=_o_canvas.height+"px";$("#displayRate").html(_MSG_("editor_watermark_image_show_rate")+"100%")}else{_o_canvas.style.width=_w_maxWidth+"px";_o_canvas.style.height=_w_maxWidth/_o_canvas.width*_o_canvas.height+"px";$("#displayRate").html(_MSG_("editor_watermark_image_show_rate")+(_w_maxWidth/_o_canvas.width*100).toFixed(1)+"%")}if(!_o_ctx)_o_ctx=_o_canvas.getContext("2d");_o_ctx.drawImage(_w_image,0,0,_o_canvas.width,_o_canvas.height);let _w_drawTextWatermark=function(_w_doDrawWatermark){let _w_text=$("#watermarkText").prop("value");if(_w_text.length==0)return;let _w_fontSize=parseInt($("#fontSize").prop("value"));let _w_colorObj=_o_hexToRgb($("#fontColor").prop("value"));let _w_fontAlpha=parseInt($("#fontAlpha").prop("value"))/100;let _w_rgba="rgba("+_w_colorObj.r+", "+_w_colorObj.g+", "+_w_colorObj.b+", "+_w_fontAlpha+")";_o_ctx.font=_w_fontSize+"px "+$("select#fontSelecter option:selected").prop("value");_o_ctx.strokeStyle=_w_rgba;_o_ctx.fillStyle=_w_rgba;let _w_wmRect={};_w_wmRect.width=_o_ctx.measureText(_w_text).width;_w_wmRect.height=_w_fontSize;_w_doDrawWatermark(_w_wmRect,(function(x,y){if($("#borderFont:checkbox").is(":checked")){_o_ctx.strokeText(_w_text,x,y+_w_wmRect.height)}else{_o_ctx.fillText(_w_text,x,y+_w_wmRect.height)}}))};let _o_final_watermarkImage=null;let _w_drawImageWatermark=function(_w_doDrawWatermark){if(_o_shuiyin==null)return;if(_o_final_watermarkImage==null){let _w_wmImageCutUp=parseInt($("#wmImageCutUp").prop("value"));_w_wmImageCutUp=_w_wmImageCutUp?_w_wmImageCutUp:0;let _w_wmImageCutRight=parseInt($("#wmImageCutRight").prop("value"));_w_wmImageCutRight=_w_wmImageCutRight?_w_wmImageCutRight:0;let _w_wmImageCutDown=parseInt($("#wmImageCutDown").prop("value"));_w_wmImageCutDown=_w_wmImageCutDown?_w_wmImageCutDown:0;let _w_wmImageCutLeft=parseInt($("#wmImageCutLeft").prop("value"));_w_wmImageCutLeft=_w_wmImageCutLeft?_w_wmImageCutLeft:0;let _w_wmImageWidth=_o_shuiyin.width-_w_wmImageCutLeft-_w_wmImageCutRight;let _w_wmImageHeight=_o_shuiyin.height-_w_wmImageCutUp-_w_wmImageCutDown;let _o_wmEditCanvas=document.createElement("canvas");_o_wmEditCanvas.width=_w_wmImageWidth;_o_wmEditCanvas.height=_w_wmImageHeight;let _w__tmp_ctx=_o_wmEditCanvas.getContext("2d");_w__tmp_ctx.drawImage(_o_shuiyin,_w_wmImageCutLeft,_w_wmImageCutUp,_w_wmImageWidth,_w_wmImageHeight,0,0,_w_wmImageWidth,_w_wmImageHeight);if($("#brToAlpha").is(":checked")){let _w_reverseAlpha=$("#brToAlphaReverse").is(":checked");let _w_pixelAlphaRate=parseFloat($("#pixelAlphaRateRange").prop("value"));let _w_pixels=_w__tmp_ctx.getImageData(0,0,_o_wmEditCanvas.width,_o_wmEditCanvas.height);let _w_pixelsDataLength=_w_pixels.data.length;for(let i=0;i<_w_pixelsDataLength;i+=4){let _w_brightness=.299*_w_pixels.data[i]+.587*_w_pixels.data[i+1]+.114*_w_pixels.data[i+2];let _w_alpha=_w_brightness;if(_w_reverseAlpha){_w_alpha=255-_w_alpha}_w_alpha=_w_alpha*_w_pixelAlphaRate;if(_w_pixels.data[i+3]>0)_w_pixels.data[i+3]=_w_alpha}_w__tmp_ctx.putImageData(_w_pixels,0,0)}_o_final_watermarkImage=_o_wmEditCanvas}let _w_iwWidth=parseInt($("#wmScWidth").prop("value"));let _w_iwHeight=parseInt($("#wmScHeight").prop("value"));let _w_iwAlpha=parseInt($("#imageAlpha").prop("value"))/100;let _w_wmRect={};_w_wmRect.width=_w_iwWidth;_w_wmRect.height=_w_iwHeight;_w_doDrawWatermark(_w_wmRect,(function(x,y){_o_ctx.save();_o_ctx.globalAlpha=_w_iwAlpha;_o_ctx.drawImage(_o_final_watermarkImage,0,0,_o_final_watermarkImage.width,_o_final_watermarkImage.height,x,y,_w_iwWidth,_w_iwHeight);_o_ctx.restore()}))};let _w_drawQrCodeWatermark=function(_w_doDrawWatermark){if(window._o_watermarkQrCodeImage==null)return;let _w_iwWidth=window._o_watermarkQrCodeImage.width;let _w_iwHeight=window._o_watermarkQrCodeImage.height;let _w_qrCodeBgColor=$("#qrCodeBgColor").prop("value");let _w_qrCodeBgRGB=_o_hexToRgb(_w_qrCodeBgColor);let _w_qrCodeAlpha=parseInt($("#qrCodeAlpha").prop("value"))/100;_w_qrCodeBgColor="RGBA("+_w_qrCodeBgRGB.r+", "+_w_qrCodeBgRGB.g+", "+_w_qrCodeBgRGB.b+", "+_w_qrCodeAlpha+")";let _w_qrImageBorder=parseInt($("#qrCodeBorderRange").prop("value"));let _w_wmRect={};_w_wmRect.width=_w_iwWidth+2*_w_qrImageBorder;_w_wmRect.height=_w_iwHeight+2*_w_qrImageBorder;_w_doDrawWatermark(_w_wmRect,(function(x,y){let _w_fillStyle=_o_ctx.fillStyle;_o_ctx.fillStyle=_w_qrCodeBgColor;_o_ctx.fillRect(x,y,_w_iwWidth+2*_w_qrImageBorder,_w_iwHeight+2*_w_qrImageBorder);_o_ctx.fillStyle=_w_fillStyle;_o_ctx.drawImage(window._o_watermarkQrCodeImage,0,0,window._o_watermarkQrCodeImage.width,window._o_watermarkQrCodeImage.height,x+_w_qrImageBorder,y+_w_qrImageBorder,_w_iwWidth,_w_iwHeight)}))};let _w_drawWaterMark=function(_w_doDrawWatermark){if($(".typeMenuItem.textWatermark").is(".active")){_w_drawTextWatermark(_w_doDrawWatermark)}else if($(".typeMenuItem.imageWatermark").is(".active")){_w_drawImageWatermark(_w_doDrawWatermark)}else if($(".typeMenuItem.qrCodeWatermark").is(".active")){_w_drawQrCodeWatermark(_w_doDrawWatermark)}};let _w_drawTileWatermark=function(){let _w_margin={};_w_margin.width=parseInt($("#marginX").prop("value"));_w_margin.height=parseInt($("#marginY").prop("value"));let _w_rotate=parseInt($("#rotation").prop("value"));let _w_offset={};_w_offset.x=parseInt($("#offsetX").prop("value"));_w_offset.y=parseInt($("#offsetY").prop("value"));let _w_diagonalLength=Math.sqrt(Math.pow(_o_canvas.width+Math.abs(_w_offset.x),2)+Math.pow(_o_canvas.height+Math.abs(_w_offset.y),2));let _w_doDrawWatermark=function(_w_wmRect,_w_drawFun){_w_wmRect.width+=_w_margin.width;_w_wmRect.height+=_w_margin.height;_o_ctx.rotate(_w_rotate*Math.PI/180);for(let x=0;x<_w_diagonalLength;x+=_w_wmRect.width){for(let y=0;y<_w_diagonalLength;y+=_w_wmRect.height){_w_drawFun(x+_w_margin.width+_w_offset.x,y+_w_offset.y)}}for(let x=0;x<_w_diagonalLength;x+=_w_wmRect.width){for(let y=-_w_wmRect.height;y>-_w_diagonalLength;y-=_w_wmRect.height){_w_drawFun(x+_w_margin.width+_w_offset.x,y+_w_offset.y)}}for(let x=-_w_wmRect.width;x>-_w_diagonalLength;x-=_w_wmRect.width){for(let y=-_w_wmRect.height;y>-_w_diagonalLength;y-=_w_wmRect.height){_w_drawFun(x+_w_margin.width+_w_offset.x,y+_w_offset.y)}}for(let x=-_w_wmRect.width;x>-_w_diagonalLength;x-=_w_wmRect.width){for(let y=0;y<_w_diagonalLength;y+=_w_wmRect.height){_w_drawFun(x+_w_margin.width+_w_offset.x,y+_w_offset.y)}}};_w_drawWaterMark(_w_doDrawWatermark)};let _w_drawLocationWatermark=function(){let _w_alignX=parseInt($("#alignX").prop("value"));let _w_alignY=parseInt($("#alignY").prop("value"));let _w_middleAlignX=$("#middleAlignX").is(":checked");let _w_middleAlignY=$("#middleAlignY").is(":checked");let _w_doDrawWatermark=function(_w_wmRect,_w_drawFun){let _w_startPoint={x:0,y:0};if(_w_middleAlignX){_w_startPoint.x=Math.round(_o_canvas.width/2-_w_wmRect.width/2)}else if(_w_alignX>0){_w_startPoint.x=_w_alignX}else if(_w_alignX<0){_w_startPoint.x=_o_canvas.width-_w_wmRect.width+_w_alignX+1}if(_w_middleAlignY){_w_startPoint.y=Math.round(_o_canvas.height/2-_w_wmRect.height/2)}else if(_w_alignY>0){_w_startPoint.y=_w_alignY}else if(_w_alignY<0){_w_startPoint.y=_o_canvas.height-_w_wmRect.height+_w_alignY+1}_w_drawFun(_w_startPoint.x,_w_startPoint.y)};_w_drawWaterMark(_w_doDrawWatermark)};if($(".presentationMenuItem.tileWatermark").is(".active")){_w_drawTileWatermark()}else if($(".presentationMenuItem.locationWatermark").is(".active")){_w_drawLocationWatermark()}_w_filename="watermark_"+_w_filename;_w_filename=_w_filename.replace(/^(.*?)(\.[\w]{3,4})?$/,"$1.png");let _w_downloadImage=function(){blobUtil.canvasToBlob(_o_canvas).then((function(blob){chrome.downloads.download({url:blobUtil.createObjectURL(blob),filename:_o_downloadPathEscape(_MSG_("editor_watermark_image_fold_path")+"/"+_w_filename),saveAs:false,conflictAction:"uniquify"})}))};if(_w_downloadNow){_w_downloadImage()}let _w_canvasStyleWidth=parseInt(_o_canvas.style.width.replace("px",""));let _w_canvasStyleHeight=parseInt(_o_canvas.style.height.replace("px",""));$(_o_canvas).parent().off("mouseover mouseout mousemove");if(_w_canvasStyleWidth<_o_canvas.width){let _w_mouseMoveFun=function(event){let _w_canvas_container=$(_o_canvas).parent().get(0);let _w_ccOffsetTop=_w_canvas_container.offsetTop;let _w_ccOffsetLeft=_w_canvas_container.offsetLeft;let _w_offsetX=event.pageX-_w_ccOffsetLeft;let _w_offsetY=event.pageY-_w_ccOffsetTop;let _w_offsetLeft=-(_o_canvas.width-_w_canvasStyleWidth)*_w_offsetX/_w_canvasStyleWidth;let _w_offsetTop=-(_o_canvas.height-_w_canvasStyleHeight)*_w_offsetY/_w_canvasStyleHeight;$(_o_canvas).css("margin-top",_w_offsetTop);$(_o_canvas).css("margin-left",_w_offsetLeft)};$(_o_canvas).parent().on("mouseover",(function(event){$(_o_canvas).css("width",_o_canvas.width);$(_o_canvas).css("height",_o_canvas.height);$(this).off("mousemove").on("mousemove",_w_mouseMoveFun)})).on("mouseout",(function(){$(_o_canvas).css("width",_w_canvasStyleWidth);$(_o_canvas).css("height",_w_canvasStyleHeight);$(_o_canvas).css("margin","0px auto");$(this).off("mousemove",_w_mouseMoveFun)}))}}