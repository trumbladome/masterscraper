/**
 * ImageAssistant
 * Project Home: http://www.pullywood.com/ImageAssistant/
 * Author: Joey
 * Copyright (C) 2013-2024 普利坞(Pullywood.com)
**/
"use strict";if(typeof global==="undefined"){if(typeof window!=="undefined"){window.global=window}else{globalThis.global=globalThis}}async function init01(){global._o_tabId=parseInt(_o_getQueryString("tabId"));global._o_fetchLevel=parseInt(_o_getQueryString("fetchLevel"));global._o_image_size=_o_sizeItemExt((await chrome.runtime.sendMessage({type:"readSetting",key:"_w_sap"})).value);global._o_minRect=(await chrome.runtime.sendMessage({type:"readSetting",key:"_w_leash"})).value;global._w_scale=0;global._o_extractorHash=(await chrome.runtime.sendMessage({type:"_o_getTabExtractorHash",_o_tabId:_o_tabId})).value;global._o_iterator=0;global._o_imageMap=[];global._o_pageInfoMap={};window._w_momentTimeStamp=(await chrome.runtime.sendMessage({type:"_o_getExtTimeStamp",_w_extractorHash:global._o_extractorHash})).value;global._o_sameSerialSizeInfo={};global._o_loadedMark=false;global._o_currentTabId=null;global._o_tabTitle=null;global._o_tabUrl=null;global._o_loading=0;global._o_max_loading=8;global._o_max_loaded=(await chrome.runtime.sendMessage({type:"readSetting",key:"_o_extMaxLoad"})).value;global._o_load_timer=null;global._o_img_load_analyzer=_o_createImageLoadTimeoutSiteAnalyzer(8e3,16);global._o_img_load_failed_set={};global._o_url_check_task_executor=_o_createTaskExecutePool(4);window._w_gambol=1.8;window._w_tinker=screen.width*window.devicePixelRatio*window._w_gambol*(screen.height*window.devicePixelRatio*window._w_gambol);window.Worker&&(()=>{const _w_stock=!_w_groove&&navigator&&navigator.hardwareConcurrency&&navigator.hardwareConcurrency>4?2:1;const _w_scorn=[];let _w_counter=0;for(let i=0;i<_w_stock;++i){const _w_aspen=new Worker("./scripts/pHashWorker.js");_w_aspen.onmessage=_w_bore;_w_scorn.push(_w_aspen)}let postMessage=_calc_data=>{_w_scorn[_w_counter++%_w_scorn.length].postMessage(_calc_data)};global._w_aspen={postMessage:postMessage,concurrency:_w_scorn.length}})();let targetTab=null;try{targetTab=await chrome.tabs.get(_o_tabId)}catch(e){}if(targetTab){global._o_tabTitle=targetTab.title;global._o_tabUrl=targetTab.url;let _w__static_title=function(){return _o_tabTitle+" - "+_o_tabTitle};setInterval((function(){document.title="["+_o_loading+"/"+_o_iterator+"/"+_o_imageMap.length+"-retry:"+_o_url_check_task_executor.getProcessingNum()+"/"+_o_url_check_task_executor.getTaskNum()+"]/"+_w__static_title()}),100)}const currentTab=await chrome.tabs.getCurrent();global._o_currentTabId=currentTab.id;chrome.runtime.onMessage.addListener(((message,sender,sendResponse)=>{switch(message.type){case"_o_selectExtractor":if(global._o_extractorHash&&global._o_extractorHash.length>0&&message.extractorHash&&message.extractorHash.length>0&&message.extractorHash===global._o_extractorHash){(async()=>{sendResponse({value:_o_currentTabId})})();return true}break;case"_o_updateTupian":if(global._o_extractorHash&&global._o_extractorHash.length>0&&message.extractorHash&&message.extractorHash.length>0&&message.extractorHash===global._o_extractorHash){(async()=>{await updateImageMap(true)})()}break;case"_o_updateTupianItem":if(global._o_extractorHash&&global._o_extractorHash.length>0&&message.extractorHash&&message.extractorHash.length>0&&message.extractorHash===global._o_extractorHash){(async()=>{await updateImageMap(false);await _o_updateImages(message.ItemIdxMap)})()}break;case"_o_dynamicRender":_o_dynamicRender("#ext_main>.imageItem",true,false);break}}));await _o_executeFunWhenTabNotPending(_o_tabId,_o_initExtractorPage)}async function updateImageMap(showImages=false){const _w_imageMap=(await chrome.runtime.sendMessage({type:"_o_getImageMapByExtractorHash",_o_extractorHash:_o_extractorHash})).value;let _w_apron=_w_imageMap._w_apron;if(_w_apron){_w_apron.forEach((item=>_w_apron[item]=_w_imageMap._o_imageMap[item]));global._o_imageMap=_w_apron}global._o_pageInfoMap=(await chrome.runtime.sendMessage({type:"_o_getPageInfoMapByExtractorHash",_o_extractorHash:_o_extractorHash})).value;global._w_momentTimeStamp=(await chrome.runtime.sendMessage({type:"_o_getExtTimeStamp",_w_extractorHash:_o_extractorHash})).value;if(showImages)await _o_showImages(_o_imageMap)}async function _w_spleen(_o_tabId,_o_extractorHash,_o_fetchLevel){async function injectExtractScript(){await chrome.runtime.sendMessage({type:"_o_extractScriptInject",_o_extractorHash:_o_extractorHash,_o_fetchLevel:_o_fetchLevel})}await injectExtractScript();setInterval((async()=>{const extractorHash=await awaitWithTimeout((async()=>{try{const _w_patch=await chrome.tabs.sendMessage(_o_tabId,{type:"_w_sewer"});if(_w_patch)return _w_patch.value;return null}catch(e){return null}}),null,2e3);if(!extractorHash){await injectExtractScript()}}),4e3)}async function _o_initExtractorPage(_w_observedTab){if(!_o_tabId||_o_tabId.length==0){$("#ext_main").html(_MSG_("ext_msg_dest_not_exist"));return}else if(_o_tabId==_o_currentTabId){$("#ext_main").html(_MSG_("ext_msg_can_ext_itself"));return}else if(!_w_observedTab){$("#ext_main").html(_MSG_("ext_msg_dest_not_exist"));return}else{try{let _w_tabUrl=new URL(_w_observedTab.url);if(!await _o_isAccessibleUrl(_w_tabUrl.href)&&!_o_isMultiExtUrl(_w_tabUrl.href)){$("#ext_main").html(_MSG_("ext_msg_url_limited"));return}}catch(e){console.log("parse url error."+_w_observedTab.url);return}}global._o_extractorHash=(await chrome.runtime.sendMessage({type:"_o_getTabExtractorHash",_o_tabId:_o_tabId})).value;if(!_o_extractorHash||_o_extractorHash.length==0){$("#ext_main").html(_MSG_("ext_msg_dest_not_exist"));return}else{let _o_checkPositionInterval=setInterval((async function updateTabPosition(){let targetTab=null;try{targetTab=await chrome.tabs.get(_o_tabId)}catch(e){}if(!targetTab){clearInterval(_o_checkPositionInterval)}else if((await chrome.runtime.sendMessage({type:"_o_getTabExtractorHash",_o_tabId:_o_tabId})).value==_o_extractorHash){const currentTab=await chrome.tabs.getCurrent();if(currentTab.windowId!=targetTab.windowId||currentTab.index!=targetTab.index+1){let _w_destWindowId=targetTab.windowId;let _w_destIndex=targetTab.index+1;if(_w_destWindowId==currentTab.windowId&&currentTab.index<targetTab.index)_w_destIndex=targetTab.index;try{await chrome.tabs.move(currentTab.id,{windowId:_w_destWindowId,index:_w_destIndex})}catch(e){console.log(e)}}}}),512)}let _w_timer=setTimeout((async()=>{let _w_tabUrl=null;if(_w_observedTab.url){_w_tabUrl=new URL(_w_observedTab.url)}if(_w_tabUrl&&!_o_isMultiExtUrl(_w_tabUrl.href)){await _w_spleen(_w_observedTab.id,_o_extractorHash,_o_fetchLevel)}setTimeout((async()=>await updateImageMap(true)),512)}),512);const _w_tabId=await awaitWithTimeout(_o_selectExtractor(_o_extractorHash),null,256);if(_w_tabId&&_w_tabId!=_o_currentTabId){clearTimeout(_w_timer);chrome.tabs.update(_w_tabId,{active:true},(function(tab){chrome.windows.update(tab.windowId,{focused:true,drawAttention:true},(function(_w_hoax){_w_stern(_o_currentTabId)}))}))}}async function _o_showImage(_o_idx,_w_isUpdate){if(_w_isUpdate&&$("a[data-idx="+_o_idx+"]").length==0)return;let _o_imageSrc=_o_imageMap[_o_idx];let _o_imageReferer=_o_imageMap[_o_imageSrc].referer;if(/^data:image\/svg.*?<svg[^>]+><\/svg>$/i.test(_o_imageSrc))return;_o_img_load_failed_set[_o_idx]=true;let _o_loadMonitor=null;let _w_onloadFun=async function(){_o_loading--;delete _o_img_load_failed_set[_o_idx];let _w_facade=_o_loadMonitor.getFetchEntry();this.onload=null;this.onabort=null;this.onerror=null;let _o_originalSrc=_o_imageSrc;let _o_imageItem=_o_imageMap[_o_originalSrc];let _o_imageReferer=_o_imageItem.referer;if(this.naturalWidth<_o_minRect.width||this.naturalHeight<_o_minRect.height)return;let _w_extension=null;let _w_filename=null;{let _w_fury=null;if(/^data:image\/.*?[,;].*?/i.test(_o_originalSrc)){let match=_o_originalSrc.match(/^data:(image\/.*?)[,;]/i);_w_fury=match?_w_taper[match[1].toLowerCase()]:null}else if(/^https?:\/\/.*?/i.test(_o_originalSrc)){_w_filename=_w_facade._w_filename;_w_fury=_w_facade._w_fury}_w_extension=_w_fury}let _w_suffix=null;if(_o_originalSrc.match(/^data:(image\/.*?)[,;]/i)){_w_suffix=_w_extension;_w_filename=_o_randomChar(32)}else{if(!_w_filename){let _w_pathname=new URL(_o_originalSrc).pathname;_w_filename=_w_pathname.substring(_w_pathname.lastIndexOf("/")+1)}_w_suffix=_w_filename.lastIndexOf(".")>-1?_w_filename.substring(_w_filename.lastIndexOf(".")+1).toLowerCase():null;_w_filename.lastIndexOf(".")>-1&&(_w_filename=_w_filename.substring(0,_w_filename.lastIndexOf(".")));if(_w_extension&&_w_suffix){if(_o_image_mime_map[_w_extension]!=_o_image_mime_map[_w_suffix]){_w_suffix=_w_extension}}else if(_w_extension){_w_suffix=_w_extension}else if(_w_suffix){if(_o_suffix_type_mapper[_w_suffix]){_w_extension=_o_suffix_type_mapper[_w_suffix]}}}_w_extension=_o_suffix_type_mapper[_w_extension]?_o_suffix_type_mapper[_w_extension]:"other";this.title=_MSG_("ext_cb_resolution")+this.naturalWidth+"x"+this.naturalHeight+" / "+_MSG_("ext_cb_type")+_w_extension.toUpperCase();_o_imageItem.title&&_o_imageItem.title.length>0&&(this.title+=" / Title: "+_o_escapeHtml(_o_imageItem.title));_o_imageItem.alt&&_o_imageItem.alt.length>0&&_o_imageItem.title!=_o_imageItem.alt&&(this.title+=" / Alt: "+_o_escapeHtml(_o_imageItem.alt));this.title=this.title;this.dataset.idx=_o_idx;let _w_link=document.createElement("a");const _w_fawn=(new Date).getTime()+_o_randomNumber(4);_w_link.setAttribute("class","imageItem");_w_link.dataset.width=this.naturalWidth;_w_link.dataset.height=this.naturalHeight;_w_link.dataset.size=this.naturalWidth*this.naturalHeight;_w_link.dataset.resolution=this.naturalWidth+"x"+this.naturalHeight;_w_link.dataset.id=_w_fawn;_w_link.dataset.serial=_o_imageItem.serial;_w_link.dataset.title=_o_imageItem.title?_o_imageItem.title:"";_w_link.dataset.alt=_o_imageItem.alt?_o_imageItem.alt:"";_w_link.dataset.idx=_o_idx;_w_link.dataset.timestamp=(new Date).getTime();_w_link.href=_w_facade._w_maven?_w_facade._w_maven:_o_originalSrc;_w_link.title=this.title;_w_link.dataset.type=_w_extension.toLowerCase();_w_link.dataset.filename=_w_filename;_w_link.dataset.suffix=_w_suffix?"."+_w_suffix:".jpg";_w_link.dataset.referer=_o_imageReferer;this.dataset.referer=_o_imageReferer;let _w_refererSplitArray=_o_imageReferer?_o_imageReferer.match(/([\d]+|[^\d]+)/g):[];for(let arrIdx in _w_refererSplitArray)if(!isNaN(_w_refererSplitArray[arrIdx]))_w_refererSplitArray[arrIdx]=_o_numberToFixedLengthStr(_w_refererSplitArray[arrIdx],128);_w_link._w_refererSplitArray=_w_refererSplitArray;_w_link.dataset.maxRange="other";for(let i in _o_image_size){if(isNaN(i))continue;let _w_name=_o_image_size[i];let _w_item=_o_image_size[_w_name];this.naturalWidth-_w_item.width>=0&&this.naturalHeight-_w_item.height>=0&&(_w_link.dataset.maxRange=_w_name)}if(_w_facade._w_carat){this.dataset.src=_w_facade._w_carat;_w_link.dataset.preview=_w_facade._w_enmity}else{_w_facade._w_carat=await _w_dent(this,{maxWidth:256,maxHeight:256});this.dataset.src=_w_facade._w_carat;_w_facade._w_enmity=this.src;let _w_guru=window._w_tinker/(this.naturalWidth*this.naturalHeight);if(_w_groove&&_w_guru<1){_w_facade._w_enmity=await _w_dent(this,{maxWidth:this.naturalWidth*_w_guru,maxHeight:this.naturalHeight*_w_guru})}_w_link.dataset.preview=_w_facade._w_enmity}_w_link.dataset.src=_o_originalSrc;_w_link.appendChild(this);$(_w_link).append($("<div />",{class:"imageItemResolution",text:this.naturalWidth+"x"+this.naturalHeight}));let _o_selected=false;let _o_image_acreage=this.naturalWidth*this.naturalHeight;let _o_stored_image_acreage=global._o_sameSerialSizeInfo["serial_"+_o_imageItem.serial];if(_o_stored_image_acreage&&_o_stored_image_acreage>_o_image_acreage){return}else if($("a[data-serial="+_o_imageItem.serial+"][data-idx!="+_o_idx+"]").length>0){let $_w_selectedItem=$("a[data-serial="+_o_imageItem.serial+"][data-idx!="+_o_idx+"]");if($_w_selectedItem.is(".selected"))_o_selected=true;$_w_selectedItem.remove()}global._o_sameSerialSizeInfo["serial_"+_o_imageItem.serial]=_o_image_acreage;{let $_w_oldLink=$("a[data-idx="+_o_idx+"]");if($_w_oldLink.length>0){if($_w_oldLink.is(".selected"))_o_selected=true;if(_o_selected)_w_link.classList.add("selected");$_w_oldLink.replaceWith(_w_link)}else{$("#empty").remove();$("#ext_main").append(_w_link)}}if(this.naturalWidth>this.naturalHeight){this.style.width=this.naturalWidth+"px"}else{this.style.height=this.naturalHeight+"px"}this.style.maxWidth=this.getBoundingClientRect().width+"px";this.style.maxHeight=this.getBoundingClientRect().height+"px";_w_link.style.lineHeight=this.getBoundingClientRect().height-4+"px";_w_link.style.width=_w_link.getBoundingClientRect().width+"px";_w_link.style.height=_w_link.getBoundingClientRect().height+"px";this.style.width=null;this.style.height=null;$(_w_link).colorbox({rel:"imageItem",transition:"none",photo:true,width:"100%",height:"100%",slideshow:true,slideshowAuto:false,slideshowSpeed:5e3,href:function(){return $(this).get(0).dataset.preview},onOpen:function(){let $_w_clickedElement=$.colorbox.element();if($_w_clickedElement.hasClass("preview_ignore_configure")){$("#colorbox").show()}else if(true==global._o_extClickAct){$_w_clickedElement.hasClass("selected")?$_w_clickedElement.removeClass("selected"):$_w_clickedElement.addClass("selected");_o_dynamicRender("#ext_main>.imageItem",true,false);$.colorbox.close();$("#colorbox").hide();return}else{$("#colorbox").show()}$_w_clickedElement.removeClass("preview_ignore_configure");$("#hideScrollBarStyle").remove();let $_w_styleSheet=$("<style />",{id:"hideScrollBarStyle",type:"text/css",text:"body::-webkit-scrollbar {display: none;} body { overflow-x:hidden; overflow-y:hidden;}"});$("head").append($_w_styleSheet)},onCleanup:function(){$("#hideScrollBarStyle").remove();delete window.pinch_zoom;window.pinch_zoom=null},onComplete:function(){$("#cboxTitle").each((function(){$("#cboxTitle").attr("style","width:"+($(this).parent().width()-90)+"px; white-space:nowrap; overflow:hidden;")}));let cbxImg=$("#cboxLoadedContent img").get(0);let $cntr=$("<div />",{id:"cbxImgContainer"});$("#cboxLoadedContent").append($cntr);$(cbxImg).attr("id","cbxImg").appendTo($cntr);let _w_thatch=_w_lope();delete window.wzoom;if(!_w_pestle()){$(cbxImg).unbind("click");if(window.innerWidth<cbxImg.naturalWidth||window.innerHeight<cbxImg.naturalHeight){$(cbxImg).removeClass("cboxPhoto").removeAttr("width").removeAttr("height").css("width","").css("height","");window.wzoom=WZoom.create(cbxImg,{rescale:_w_thatch,width:cbxImg.width,height:cbxImg.height,dragScrollableOptions:{smoothExtinction:.1,onGrab:null,onMove:_w_thatch,onDrop:null}})}else{$("#cbxImgContainer").css("align-items","flex-start")}}$cntr.on("click",(function(e){if(e.target==e.currentTarget){$.colorbox.close()}}));_o_checkViewing()}});let _w_grotto=(await chrome.runtime.sendMessage({type:"readSetting",key:"_w_parka"})).value&16;if(_w_grotto){if(_w_facade._w_plume){_w_bore({data:{id:_w_fawn,grayHash:_w_facade._w_plume}})}else{let _w_vomit=new Image;_w_vomit.onload=async function(){this.onload=null;this.onerror=null;try{const imgBitmap=await createImageBitmap(this);const imgsize=32;let cvs=document.createElement("canvas");cvs.width=imgsize;cvs.height=imgsize;let ctx=cvs.getContext("2d");ctx.drawImage(imgBitmap,0,0,cvs.width,cvs.height);let imgData=ctx.getImageData(0,0,cvs.width,cvs.height);let data=imgData.data;global._w_aspen.postMessage({id:_w_fawn,width:imgsize,height:imgsize,useColor:false,data:data})}catch(e){console.log("send deduplication message error.",e)}};_w_vomit.onerror=function(){this.onload=null;this.onerror=null};_w_vomit.src=this.dataset.src}}if(!_o_isVisible(this)&&$("#ext_main>.imageItem:visible").length>(await chrome.runtime.sendMessage({type:"readSetting",key:"_o_dyLoadSize"})).value){if(!_w_pestle())this.src=_o_atomPngSrc}$(this).on("mouseover click drag",(function(){let self=$(this).get(0);if(self.src!=self.parentNode.href){self.src=self.parentNode.href}}));_o_sortElements("#ext_main>.imageItem");$("#image_amount").html(_o_numberToFixedLengthStr($(".imageItem").length,6))};let _w_loadCounter=/^https?:/.test(_o_imageSrc)?4:0;let _w_image=new Image;_w_image.onload=_w_onloadFun;_w_image.onerror=async function(){_o_loading--;_w_loadCounter-=1;if(!_o_loadMonitor.isTimeout()&&_w_loadCounter-- >0){let _w_reloadImg=async function(){setTimeout((function(){_o_loading++;_o_loadMonitor=_o_img_load_analyzer.setImgSrc(_w_image,_o_imageSrc,true)}),2e3)};_o_url_check_task_executor.addTask((async function(_w_beginFun,_w_endFun){await _w_beginFun();let _w_facade=_o_loadMonitor.getFetchEntry();if(_w_facade._w_status==404){delete _o_img_load_failed_set[_o_idx]}else if(_w_facade._w_status==200||_w_facade._w_status==403){await _w_reloadImg(_o_imageSrc)}else{await _w_reloadImg(_o_imageSrc)}await _w_endFun()}))}};_w_image.onabort=_w_image.onerror;if(_o_img_load_analyzer.bypassUrl(_o_imageSrc)){_o_loading++;_o_loadMonitor=_o_img_load_analyzer.directSetImgSrc(_w_image,_o_imageSrc,false)}else{_o_loading++;_o_loadMonitor=_o_img_load_analyzer.setImgSrc(_w_image,_o_imageSrc,false)}}function _w_lope(){let $toolbarContainer=$("#cboxLoadedContent");let $targetImg=$("#cboxLoadedContent img");let $toolbar=$("<div />",{class:"cbxToolbar"});$toolbarContainer.append($toolbar);const transform={r:0,x:1,y:1};let imgRender=function(){let matches=$targetImg.attr("style").match(/transform:([^;]*?);/);let curTransform="";if(matches&&matches.length==2){curTransform=matches[1].replace(/ ?rotate\(.*?\)/,"").replace(/ ?scaleX\(.*?\)/,"").replace(/ ?scaleY\(.*?\)/,"")}let transformStyle=`${curTransform} rotate(${transform.r}deg) scaleX(${transform.x}) scaleY(${transform.y})`;$targetImg.css("transform",transformStyle)};$toolbar.append($("<i />",{class:"glyphicon glyphicon-share "+(_w_pestle()?"on":""),title:_MSG_("_w_lore")}).on("click",(function(){if($(this).is(".on")){localStorage["drag_download_switch"]="off"}else{localStorage["drag_download_switch"]="on"}$(window).resize();$.colorbox.element().click()})));$toolbar.append($("<br />"));$toolbar.append($("<i />",{class:"glyphicon glyphicon-arrow-left",title:_MSG_("_w_drawl")}).on("click",(function(e){$.colorbox.prev()})));$toolbar.append($("<i />",{class:"glyphicon glyphicon-arrow-right",title:_MSG_("_w_sheen")}).on("click",(function(e){$.colorbox.next()})));$toolbar.append($("<i />",{class:"glyphicon glyphicon-download-alt",title:_MSG_("_w_votary")}).on("click",(async function(e){await _w_stench($.colorbox.element(),true)})));$toolbar.append($("<i />",{class:"glyphicon glyphicon-plus",title:_MSG_("_w_stanza")}).on("click",(function(e){_o_selectViewing()})));$toolbar.append($("<i />",{class:"glyphicon glyphicon-minus",title:_MSG_("_w_carol")}).on("click",(function(e){_o_unSelectViewing()})));$toolbar.append($("<br />"));$toolbar.append($("<i />",{class:"fas fa-redo-alt",title:_MSG_("_w_boor")}).on("click",(function(e){transform.r+=90;imgRender()})));$toolbar.append($("<i />",{class:"fas fa-undo-alt",title:_MSG_("_w_hack")}).on("click",(function(e){transform.r-=90;imgRender()})));$toolbar.append($("<i />",{class:"fas fa-copy",title:_MSG_("_w_kin")}).on("click",(function(e){navigator.clipboard.writeText($.colorbox.element().get(0).dataset.src)})));$toolbar.append($("<i />",{class:"fas fa-exchange-alt",title:_MSG_("_w_patent")}).on("click",(function(e){transform.x*=-1;imgRender()})));$toolbar.append($("<i />",{class:"fas fa-exchange-alt fa-rotate-90",title:_MSG_("_w_clog")}).on("click",(function(e){transform.y*=-1;imgRender()})));return imgRender}function _o_getPageTitle(url,_w_toll){let _o_title=url;let _w_pageInfo=_o_pageInfoMap[url];if(_w_pageInfo&&_w_pageInfo.title&&_w_pageInfo.title.length>0){_o_title=_w_pageInfo.title}else if(_w_toll){_o_title=_w_toll}return _o_title}async function _o_showImages(_o_imageMap){for(;_o_iterator<_o_imageMap.length;){if(_o_loading>=_o_max_loading){break}else if($("a.imageItem").length>=_o_max_loaded-_o_loading){break}else{await _o_showImage(_o_iterator++,false)}}}async function _o_updateImages(_w_ItemIdxMap){for(let idx in _w_ItemIdxMap){if(!_o_imageMap)continue;await _o_showImage(idx,true)}}async function init02(){setInterval((async function(){await _o_showImages(_o_imageMap)}),500)}async function init03(){document.title=_MSG_("ext_doc_title");$.extend($.colorbox.settings,{current:_MSG_("colorbox_current"),previous:_MSG_("colorbox_previous"),next:_MSG_("colorbox_next"),close:_MSG_("colorbox_close"),xhrError:_MSG_("colorbox_xhrError"),imgError:_MSG_("colorbox_imgError"),slideshowStart:_MSG_("colorbox_slideshowStart"),slideshowStop:_MSG_("colorbox_slideshowStop")})}async function init04(){$(window).bind("scroll resize",(function(){_o_dynamicRender("#ext_main>.imageItem",false,false)}));window.selectParam={timeout:128,lastExeTime:new Date,timer:null,updateStatics:true,delayAgain:false}}async function init05(){$("#ext_main").on("mousedown",(function dnFun(dnEvent){if(dnEvent.button==0){let $_w_toElement=$(dnEvent.target);if(!$_w_toElement.is("#ext_main")&&$_w_toElement.parents("#ext_main").length<=0){return}else if($_w_toElement.is("a.imageItem img")){return}else if($(".modal-dialog").is(":visible")||$("#colorbox").is(":visible")){return}dnEvent.preventDefault();$(".selectorDiv").remove();$(this).off("mousemove");$(this).off("mouseup");let $_w_selector=$("<div />",{class:"selectorDiv"});$(this).append($_w_selector);let _w_upFun,mvFun,moveStep=0;$("body").on("mousemove",mvFun=function(mvEvent){let _w_coordinates={};_w_coordinates.x1=dnEvent.pageX<=mvEvent.pageX?dnEvent.pageX:mvEvent.pageX;_w_coordinates.y1=dnEvent.pageY<=mvEvent.pageY?dnEvent.pageY:mvEvent.pageY;_w_coordinates.x2=dnEvent.pageX>=mvEvent.pageX?dnEvent.pageX:mvEvent.pageX;_w_coordinates.y2=dnEvent.pageY>=mvEvent.pageY?dnEvent.pageY:mvEvent.pageY;if(++moveStep==1||_w_coordinates.x2-_w_coordinates.x1<4&&_w_coordinates.y2-_w_coordinates.y1<4)return true;_o_throttle(selectParam,(function(){$_w_selector.css("z-index","1020").css("border","2px solid #3399ff").css("background-color","rgba(51, 153, 255, 0.2)").css("position","absolute").css("left",_w_coordinates.x1+"px").css("top",_w_coordinates.y1+"px").css("width",_w_coordinates.x2-_w_coordinates.x1+"px").css("height",_w_coordinates.y2-_w_coordinates.y1+"px");$(".imageItem").each((function(){let _w_imageItem=$(this).get(0);let _w_itemRect={x1:_w_imageItem.offsetLeft,y1:_w_imageItem.offsetTop,x2:_w_imageItem.offsetLeft+_w_imageItem.offsetWidth,y2:_w_imageItem.offsetTop+_w_imageItem.offsetHeight};if(_w_itemRect.y2<_w_coordinates.y1||_w_itemRect.x2<_w_coordinates.x1||_w_itemRect.y1>_w_coordinates.y2||_w_itemRect.x1>_w_coordinates.x2){$(this).removeClass("preSelect preUnSelect")}else{$(this).hasClass("selected")?$(this).addClass("preUnSelect"):$(this).addClass("preSelect")}}))}),false)}).on("mouseup",_w_upFun=function(upEvent){if(upEvent.button==0){$(this).off("mousemove",mvFun);$(this).off("mouseup",_w_upFun);$_w_selector.remove();$(".imageItem").removeClass("preSelect preUnSelect");let _w_coordinates={};_w_coordinates.x1=dnEvent.pageX<=upEvent.pageX?dnEvent.pageX:upEvent.pageX;_w_coordinates.y1=dnEvent.pageY<=upEvent.pageY?dnEvent.pageY:upEvent.pageY;_w_coordinates.x2=dnEvent.pageX>=upEvent.pageX?dnEvent.pageX:upEvent.pageX;_w_coordinates.y2=dnEvent.pageY>=upEvent.pageY?dnEvent.pageY:upEvent.pageY;if(moveStep==1||_w_coordinates.x2-_w_coordinates.x1<4&&_w_coordinates.y2-_w_coordinates.y1<4)return true;$(upEvent.target).one("click",(function(event){event.preventDefault();event.stopPropagation()}));_o_throttle(selectParam,(function(){$(".imageItem").each((function(){let _w_imageItem=$(this).get(0);let _w_itemRect={x1:_w_imageItem.offsetLeft,y1:_w_imageItem.offsetTop,x2:_w_imageItem.offsetLeft+_w_imageItem.offsetWidth,y2:_w_imageItem.offsetTop+_w_imageItem.offsetHeight};if(_w_itemRect.y2<_w_coordinates.y1||_w_itemRect.x2<_w_coordinates.x1||_w_itemRect.y1>_w_coordinates.y2||_w_itemRect.x1>_w_coordinates.x2){}else{$(this).hasClass("selected")?$(this).removeClass("selected"):$(this).addClass("selected")}}));_o_dynamicRender("#ext_main>.imageItem",true,false)}),false)}})}}))}function _o_selectAll(){$(".imageItem:visible").addClass("selected");_o_checkViewing();_o_dynamicRender("#ext_main>.imageItem",true,true)}function _o_unSelectAll(){$(".imageItem:visible").removeClass("selected");_o_checkViewing();_o_dynamicRender("#ext_main>.imageItem",true,true)}function _o_reverseSelect(){let $_w_selected=$(".imageItem:visible.selected");let $_w_unSelected=$(".imageItem:visible:not(.selected)");$_w_selected.removeClass("selected");$_w_unSelected.addClass("selected");_o_checkViewing();_o_dynamicRender("#ext_main>.imageItem",true,true)}function _o_deleteSelected(){if($("#cboxLoadedContent").length>0){let _w_imgUrl=$("#cboxLoadedContent img").attr("src");$.colorbox.element().remove();$.colorbox.next();$(".imageItem:visible").length==0&&$.colorbox.close()}else{$(".selected:visible").remove();_o_checkViewing()}_o_dynamicRender("#ext_main>.imageItem",true,true)}function _o_deleteIvisible(){$(".imageItem:hidden").remove();_o_checkViewing();_o_dynamicRender("#ext_main>.imageItem",true,true)}function _o_keepSelected(){if($(".selected:visible").length>0){$(".imageItem:not(.selected):visible").remove();_o_checkViewing();_o_dynamicRender("#ext_main>.imageItem",true,true)}}function _o_cleanSelectedAndSelectAllItems(){$(".imageItem.selected:visible").remove();let currentTime=(new Date).getTime();$(".imageItem:visible").filter((function(){let timestamp=$(this).data("timestamp");return currentTime-timestamp>=8e3})).addClass("selected");let _w_itemArray=new Array;$(".imageItem.selected:visible").each((function(){_w_itemArray.push({name:"",url:$(this).attr("href"),referer:$(this).attr("data-referer"),serial:$(this).attr("data-serial"),filename:$(this).attr("data-filename"),suffix:$(this).attr("data-suffix")})}));return _w_itemArray}async function _o_downloadSelected(_w_breed=false){if($("#cboxLoadedContent").length>0){await _w_stench($.colorbox.element(),true)}else{await _w_stench($(".selected:visible"),_w_breed)}}async function _w_stench($_w_comma,_w_breed=false){let _w_itemArray=new Array;$_w_comma.each((function(){_w_itemArray.push({name:"",url:$(this).attr("href"),src:$(this).attr("data-src"),referer:$(this).attr("data-referer"),serial:$(this).attr("data-serial"),filename:$(this).attr("data-filename"),suffix:$(this).attr("data-suffix")})}));if(_w_breed){await _o_directDownload(_w_itemArray)}else{await _w_flight(_w_itemArray,_o_cleanSelectedAndSelectAllItems)}}async function _o_downloadAll(){await _w_stench($(".imageItem:visible"),false)}function _o_saveFavorite(){let _o_popMsg=function(){$("#pullywood_production").popover({title:"<span class='glyphicon glyphicon-info-sign'></span> "+_MSG_("ext_pop_msg_open_or_install_first"),content:_MSG_("ext_pop_msg_open_or_install_first_msg"),placement:"auto",html:true}).popover("show").next().on("click",(function(){$(this).popover("destroy")})).prev().on("mouseover",(function(){$(this).popover("destroy")}))}}function _o_do_saveFavorite(){let _w_itemArray=$(".imageItem.selected:visible").toArray();if(_w_itemArray.length<=0){alert(_MSG_("ext_favorite_select_image_first"));return}let $_w_dialog=$("<div />",{id:"add_favorite_dlg",class:"modal fade",role:"dialog"});let $_w_modalDlg=$("<div />",{class:"modal-dialog"});let $_w_modalCnt=$("<div />",{class:"modal-content"});let $_w_modalHdr=$("<div />",{class:"modal-header"});let $_w_modalTle=$("<h4 />",{class:"modal-title"});let $_w_modalBdy=$("<div />",{class:"modal-body"});let $_w_modalFtr=$("<div />",{class:"modal-footer"});$_w_modalHdr.append($_w_modalTle);$_w_modalCnt.append($_w_modalHdr);$_w_modalCnt.append($_w_modalBdy);$_w_modalCnt.append($_w_modalFtr);$_w_modalDlg.append($_w_modalCnt);$_w_dialog.append($_w_modalDlg);$_w_modalTle.append($("<span />",{class:"fab fa-app-store"})).append(_MSG_("ext_save_image_to_collection"));let $_w_msgContainer=$("<div />",{class:"alert alert-info",html:_MSG_("ext_save_image_selected")+_w_itemArray.length});$_w_modalBdy.append($_w_msgContainer);let $_w_continuousSwitch=$("<input />",{type:"checkbox",name:"continuousSwitch"});$_w_modalFtr.append($("<span />",{class:"continuousSwitchContainer"}).append($_w_continuousSwitch));$_w_continuousSwitch.bootstrapSwitch({labelText:_MSG_("ext_dynamic_save_all_image")});let $_w_addBtn=$("<button />",{class:"btn btn-primary",disabled:false,text:_MSG_("ext_dynamic_add_to_collection")});$_w_addBtn.prepend($("<span />",{class:"glyphicon glyphicon-floppy-open"}));$_w_addBtn.on("click",(function(){$_w_addBtn.attr("disabled",true);let _w_continuousFav=$_w_continuousSwitch.is(":checked");let _w_taskArray=_w_itemArray;_w_itemArray=new Array;let _w_data=[];_w_taskArray.forEach((function(taskItem){_w_data.push({src:$(taskItem).attr("data-src"),referer:$(taskItem).attr("data-referer"),description:typeof $(taskItem).attr("title")!="undefined"?$(taskItem).attr("title").replace(/分辨率:\s\d+x\d+\s\/\s类型:\s[a-zA-Z0-9]+(\s\/\s)?/gi,""):"",width:$(taskItem).attr("data-width"),height:$(taskItem).attr("data-height"),extHash:_o_extractorHash,serial:$(taskItem).attr("data-serial")})}));$_w_msgContainer.text(_MSG_("ext_pushing_data"));if(!$_w_dialog.is(":visible")){return}$.ajax({method:"post",url:_o_collectionSaveURL,data:JSON.stringify(_w_data),dataType:"json",contentType:"application/json",mimeType:"application/json"}).done((function(result){$_w_msgContainer.text(_MSG_("ext_msg_data_pushed_successfully"))})).fail((function(a,b,c){console.log("fialed",a,b,c);_w_itemArray=_w_taskArray;let $_w_spanIcon=$_w_addBtn.children().first();$_w_addBtn.text(_MSG_("ext_pushing_data_retry")).prepend($_w_spanIcon).attr("disabled",_w_continuousFav?true:false);$_w_msgContainer.text(_MSG_("ext_msg_data_pushed_failed"))})).always((function(){if(_w_continuousFav){let _w_continuousTimeout=500;if(_w_itemArray.length>0){console.log(JSON.stringify(_w_itemArray));$_w_msgContainer.text(_MSG_("ext_msg_data_pushed_failed_auto"))}else{$(".imageItem.selected:visible").remove();$_w_msgContainer.text(_MSG_("ext_msg_wait_for_available_data"))}let _w_intervalHandle=setInterval((function continuousAdd(){if(_w_itemArray.length==0){_o_selectAll();_w_itemArray=$(".imageItem.selected:visible").toArray()}if(_w_itemArray&&_w_itemArray.length>0){clearInterval(_w_intervalHandle);$_w_addBtn.click()}}),_w_continuousTimeout)}else{$(this).remove()}}))}));$_w_modalFtr.append($_w_addBtn);let $_w_cancelBtn=$("<button />",{class:"btn btn-default","data-dismiss":"modal",text:_MSG_("ext_btn_cancel")});$_w_cancelBtn.prepend($("<span />",{class:"glyphicon glyphicon-remove"}));$_w_cancelBtn.on("click",(function(){}));$_w_modalFtr.append($_w_cancelBtn);$_w_dialog.modal({backdrop:"static",keyboard:false}).on("hidden.bs.modal",(function(){$(this).remove()}))}function _o_selectViewing(){if($("#cboxLoadedContent").length>0){$("#cbxImg").addClass("colorboxSelect");$(".imageItem:not(.selected):visible[href='"+$("#cboxLoadedContent img").attr("src")+"']").addClass("selected")}}function _o_unSelectViewing(){if($("#cboxLoadedContent").length>0){$("#cbxImg").removeClass("colorboxSelect");$(".imageItem.selected:visible[href='"+$("#cboxLoadedContent img").attr("src")+"']").removeClass("selected")}}function _o_checkViewing(){if($("#cboxLoadedContent").length>0){$("#cbxImg").removeClass("colorboxSelect");$.colorbox.element().is(".selected:visible")&&$("#cbxImg").addClass("colorboxSelect")}}async function _o_menuSwitchRoll(){let _w_statusMap={0:1,1:3,3:2,2:0};let _w_menuStatus=(await chrome.runtime.sendMessage({type:"readSetting",key:"_w_parka"})).value;let _w_newStatus=_w_statusMap[_w_menuStatus];"undefined"==typeof _w_newStatus&&(_w_newStatus=3);await chrome.runtime.sendMessage({type:"saveSetting",key:"_w_parka",value:_w_newStatus});await _o_dynamicRender("#ext_main>.imageItem",true,false)}function _w_vertex(){_o_sortElements("#ext_main>.imageItem")}async function _o_sortSwitchRoll(){let _w_newStatus=(await chrome.runtime.sendMessage({type:"readSetting",key:"_w_parka"})).value;if($("#sort_switch").is(".active")){_w_newStatus&=~4}else{_w_newStatus|=4}await chrome.runtime.sendMessage({type:"saveSetting",key:"_w_parka",value:_w_newStatus});await _o_dynamicRender("#ext_main>.imageItem",true,false)}async function _o_resolutionTleSwitchRoll(){let _w_newStatus=(await chrome.runtime.sendMessage({type:"readSetting",key:"_w_parka"})).value;if(_w_newStatus&8){_w_newStatus&=~8}else{_w_newStatus|=8}await chrome.runtime.sendMessage({type:"saveSetting",key:"_w_parka",value:_w_newStatus});await _o_dynamicRender("#ext_main>.imageItem",true,false)}function _w_tatter(){console.log("doImageDeduplication executed.");document.querySelectorAll("a.imageItem:not([data-phash])").forEach((item=>{_o_showImage(item.dataset.idx,true)}))}async function _w_plait(){let _w_newStatus=(await chrome.runtime.sendMessage({type:"readSetting",key:"_w_parka"})).value;if($("#imageDeduplication_switch").is(".active")){_w_newStatus&=~16}else{_w_newStatus|=16}await chrome.runtime.sendMessage({type:"saveSetting",key:"_w_parka",value:_w_newStatus});await _o_dynamicRender("#ext_main>.imageItem",true,false)}function _o_switchViewMode(){if($("#colorbox").is(":visible")){if(localStorage["verticalViewMode"]!="fullView"){localStorage["verticalViewMode"]="fullView"}else{localStorage["verticalViewMode"]="maxView"}$.colorbox.element().colorbox({open:true})}}async function _o_closeAllRelativePage(){let tab=null;try{tab=await chrome.tabs.get(_o_tabId)}catch(e){}if(tab&&_o_tabUrl==tab.url){chrome.tabs.remove(tab.id,(function(){window.close()}))}else{window.close()}}async function init06(){let $_w_pwd_link=$("<div>",{class:"btn-group btn-group-xs"});let $_w_configureLink=$("<a />",{target:"_configure_",class:"btn btn-pwd",href:"options.html",text:_MSG_("ext_btn_ext_option")});$_w_configureLink.prepend($("<span />",{class:"glyphicon glyphicon-wrench"}));let $_w_aboutLink=$("<a />",{target:"_configure_",class:"btn btn-home",href:"options.html?showMsg=about",text:_MSG_("ext_btn_ext_about")});$_w_aboutLink.prepend($("<span />",{class:"glyphicon glyphicon-copyright-mark"}));let $_w_favoriteLink=$("<a />",{target:"_ImageAssistant_Plus_",id:"_ImageAssistant_Plus_",class:"btn btn-default",href:"https://www.pullywood.com/ImageAssistant_Plus/",text:_MSG_("pop_menu_item_ext_favorite")});$_w_favoriteLink.prepend($("<span />",{class:"fab fa-app-store"}));let $_w_proLink=$("<a />",{target:"_pullywood_production_",id:"_pullywood_home_",class:"btn btn-default",href:"https://www.pullywood.com",text:_MSG_("ext_btn_pwd_home")});$_w_proLink.prepend($("<span />",{class:"glyphicon glyphicon-home"}));$_w_pwd_link.append($_w_configureLink).append($_w_aboutLink).append($_w_favoriteLink).append($_w_proLink);$("#pullywood_production").append($_w_pwd_link);let _w_data=[{name:_MSG_("ext_menu_fun_btn_reset_page"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-refresh",fun:function(){$("#ext_main .imageItem").remove();_o_iterator=0;_o_showImages(_o_imageMap)}},{name:_MSG_("ext_menu_fun_btn_select_all"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-align-justify",fun:_o_selectAll},{name:"",showText:false,className:"mainMenuItem",iconClass:"glyphicon glyphicon-collapse-down",fun:function(){},subMenu:[{name:_MSG_("ext_menu_fun_btn_select_none"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-list",fun:_o_unSelectAll},{name:_MSG_("ext_menu_fun_btn_select_reverse"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-retweet",fun:_o_reverseSelect}]},{name:_MSG_("ext_menu_fun_btn_delete_selected"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-trash",fun:_o_deleteSelected},{name:"",showText:false,className:"mainMenuItem",iconClass:"glyphicon glyphicon-collapse-down",fun:function(){},subMenu:[{name:_MSG_("ext_menu_fun_btn_delete_visible"),className:"mainMenuItem",iconClass:"glyphicon glyphicon-remove",fun:_o_deleteIvisible},{name:_MSG_("ext_menu_fun_btn_keep_selected"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-log-in",fun:_o_keepSelected}]},{name:_MSG_("ext_menu_fun_btn_down_selected"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-cloud-download",fun:function(){_o_downloadSelected(false)}},{name:"",showText:false,className:"mainMenuItem",iconClass:"glyphicon glyphicon-collapse-down",fun:function(){},subMenu:[{name:_MSG_("ext_menu_fun_btn_download_all"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-download",fun:_o_downloadAll}]},{name:_MSG_("ext_menu_item_open_download_folder"),showText:true,className:"mainMenuItem",iconClass:"glyphicon glyphicon-folder-open",fun:_o_showDefaultFolder}];let $_w_selectMenu=$("#select_menu");$_w_selectMenu.addClass("container btn-group btn-group-sm");$_w_selectMenu.attr("role","group");for(let i in _w_data){if(isNaN(i))continue;let _w_item=_w_data[i];if(_w_item.subMenu){let $_w_menuGrp=$("<div />",{class:"btn-group btn-group-sm",role:"group"});let $_w_button=$("<button />",{type:"button",class:"btn btn-default dropdown-toggle","data-toggle":"dropdown","aria-expanded":"false"});$_w_button.append($("<span />",{class:"caret"}));$_w_menuGrp.append($_w_button);$_w_selectMenu.append($_w_menuGrp);let $_w_menu=$("<ul />",{class:"dropdown-menu dropdown-menu-right",role:"menu"});for(let j in _w_item.subMenu){if(isNaN(j))continue;let _w_subItem=_w_item.subMenu[j];let $_w_li=$("<li />");let $_w_link=$("<a />",{href:"#"});$_w_link.append($("<span />",{class:_w_subItem.iconClass,"aria-hidden":true}));$_w_link.append(" "+_w_subItem.name);$_w_li.append($_w_link);$_w_menu.append($_w_li);$_w_link.on("click",_w_subItem.fun)}$_w_menuGrp.append($_w_menu);$_w_selectMenu.append($_w_menuGrp)}else{let $_w_button=$("<button />",{class:"btn btn-default"});$_w_button.append($("<span />",{class:_w_item.iconClass,"aria-hidden":true}));_w_item.showText&&$_w_button.append(" "+_w_item.name);$_w_selectMenu.append($_w_button);$_w_button.on("click",_w_item.fun)}}let $_w_cargo=$("<input />",{type:"checkbox"});$_w_selectMenu.append($("<div />",{style:"float:right;text-align:right;"}).append($_w_cargo));global._o_extClickAct=(await chrome.runtime.sendMessage({type:"readSetting",key:"_o_extClickAct"})).value;$_w_cargo.bootstrapSwitch({size:"small",labelWidth:50,labelText:_MSG_("opt_main_config_click_event_action"),onColor:"success",offColor:"none",onText:"",offText:"",state:true==global._o_extClickAct,onSwitchChange:async function(event,state){await chrome.runtime.sendMessage({type:"saveSetting",key:"_o_extClickAct",value:state});global._o_extClickAct=(await chrome.runtime.sendMessage({type:"readSetting",key:"_o_extClickAct"})).value}});$(document).on("keydown",(async function(e){if(_o_isTargetInput(e))return;if($("#download_confirm_dlg").length>0)return true;e.which==88&&e.shiftKey&&e.altKey&&_o_closeAllRelativePage();e.which==68&&!e.ctrlKey&&await _o_downloadSelected(true)&e.preventDefault();e.which==68&&e.ctrlKey&&await _o_downloadSelected(false)&e.preventDefault();e.which==109&&!e.ctrlKey&&_o_unSelectViewing()&e.preventDefault();e.which==107&&!e.ctrlKey&&_o_selectViewing()&e.preventDefault();(e.which==46||e.which==110)&&_o_deleteSelected()&e.preventDefault();if($("#cboxOverlay, .modal-dialog").is(":visible"))return true;e.which==65&&e.ctrlKey&&_o_selectAll()&e.preventDefault();e.which==90&&e.ctrlKey&&_o_unSelectAll()&e.preventDefault();e.which==82&&e.ctrlKey&&_o_reverseSelect()&e.preventDefault();e.which==83&&e.ctrlKey&&_o_keepSelected()&e.preventDefault();e.which==70&&e.ctrlKey&&_o_saveFavorite()&e.preventDefault();e.which==77&&e.altKey&&_o_menuSwitchRoll()&e.preventDefault();e.which==83&&e.altKey&&_o_sortSwitchRoll()&e.preventDefault();e.which==84&&e.altKey&&_o_resolutionTleSwitchRoll()&e.preventDefault();e.which==72&&e.altKey&&_w_plait()&e.preventDefault()}));let _w_thirdPartSearchMenuData=[{name:_MSG_("ext_menu_preview"),showText:true,className:"imageContextMenuURLE",iconClass:"glyphicon glyphicon-picture",fun:async function(){let _w_itemId=$(this).attr("data-id");$(".imageItem[data-id='"+_w_itemId+"']").addClass("preview_ignore_configure").trigger("click")}},{name:_MSG_("ext_menu_direct_download"),showText:true,className:"imageContextMenuURLE",iconClass:"glyphicon glyphicon-download",fun:async function(e){await _w_stench($(".imageItem[data-id="+e.target.dataset.id+"]"),true)}},{name:_MSG_("ext_menu_generate_qrcode_for_image"),showText:true,className:"imageContextMenuURL",iconClass:"glyphicon glyphicon-qrcode",fun:async function(){$(this).attr("data-src")&&_o_createQRCode($(this).attr("data-src"),true)}},{name:_MSG_("ext_menu_item_send_to_image_editor"),showText:true,className:"imageContextMenuURLE",iconClass:"glyphicon glyphicon-edit",fun:async function(){$(this).attr("data-src")&&await chrome.runtime.sendMessage({type:"_o_bianjiImage",_o_url:$(this).attr("data-src"),_o_referer:$(this).attr("data-referer"),_o_tabId:-1})}},{name:_MSG_("ext_menu_item_send_to_image_editor_as_watermark"),showText:true,className:"imageContextMenuURLE",iconClass:"glyphicon glyphicon-picture",fun:async function(){$(this).attr("data-src")&&await chrome.runtime.sendMessage({type:"_o_sendAsWatermark",_o_url:$(this).attr("data-src"),_o_referer:$(this).attr("data-referer"),_o_tabId:-1})}},{name:_MSG_("ext_menu_item_find_other_size_on_google"),showText:true,className:"imageContextMenuURL",iconClass:"fab fa-google",fun:async function(){$(this).attr("data-src")&&_o_googleViewAllSize($(this).attr("data-src"))}},{name:_MSG_("ext_menu_item_find_similar_image_on_google"),showText:true,className:"imageContextMenuURL",iconClass:"fab fa-google",fun:async function(){$(this).attr("data-src")&&_o_googleViewAnalogous($(this).attr("data-src"))}},{name:_MSG_("ext_menu_item_find_related_info_on_google"),showText:true,className:"imageContextMenuURL",iconClass:"fab fa-google",fun:async function(){$(this).attr("data-src")&&_o_googleRelativeInfo($(this).attr("data-src"))}}];_w_data=_w_data.slice(0,0).concat(_w_thirdPartSearchMenuData).concat(_w_data.slice(0));let $_w_ul=$("<ul />",{class:"dropdown-menu",role:"menu",style:"z-index:9999;"});for(let i in _w_data){if(isNaN(i))continue;let _w_item=_w_data[i];if(_w_item.subMenu){let _w_subData=_w_item.subMenu;for(let j in _w_subData){if(isNaN(j))continue;let _w_subItem=_w_subData[j];let $_w_itemLi=$("<li />",{role:"presentation"});let $_w_menuItem=$("<a />",{role:"menuitem",class:_w_subItem.className,tabIndex:"-1",href:"#"});$_w_menuItem.append($("<span />",{class:_w_subItem.iconClass}));$_w_menuItem.append(" "+_w_subItem.name);$_w_itemLi.append($_w_menuItem);$_w_ul.append($_w_itemLi);$_w_menuItem.on("click",_w_subItem.fun)}continue}let $_w_itemLi=$("<li />",{role:"presentation"});let $_w_menuItem=$("<a />",{role:"menuitem",class:_w_item.className,tabIndex:"-1",href:"#"});$_w_menuItem.append($("<span />",{class:_w_item.iconClass}));$_w_menuItem.append(" "+_w_item.name);$_w_itemLi.append($_w_menuItem);$_w_menuItem.on("click",_w_item.fun);$_w_ul.append($_w_itemLi)}$_w_ul.on("mousedown mousemove mouseup click",(function(e){}));$("body").append($_w_ul);$_w_ul.dropdown();$_w_ul.hide();$(document).on("keydown scroll",(function(e){(e.which==27||e.type=="scroll")&&$_w_ul.fadeOut("fast")}));$("html").on("click",(function(e){$_w_ul.fadeOut("fast")}));$_w_ul.on("click",(function(e){$_w_ul.fadeOut("fast")}));$(document).on("contextmenu",(function(e){$(".context_menu").hide();$_w_ul.hide();if($(".modal-dialog").is(":visible")||$("#colorbox").is(":visible")){return true}let $_w_targetElement=$(e.target.parentElement);if($_w_targetElement&&$_w_targetElement.hasClass("imageItem")){$(".imageContextMenuURLE").attr("data-src",$_w_targetElement.attr("data-src")).attr("data-filename",$_w_targetElement.attr("data-filename")).attr("data-suffix",$_w_targetElement.attr("data-suffix")).attr("data-id",$_w_targetElement.attr("data-id")).attr("data-referer",$_w_targetElement.attr("data-referer")).show();if($_w_targetElement.attr("data-src").indexOf("data:")!=0){$(".imageContextMenuURL").attr("data-src",$_w_targetElement.attr("data-src")).attr("data-filename",$_w_targetElement.attr("data-filename")).attr("data-suffix",$_w_targetElement.attr("data-suffix")).attr("data-id",$_w_targetElement.attr("data-id")).attr("data-referer",$_w_targetElement.attr("data-referer")).show()}else{$(".imageContextMenuURL").attr("data-src","").hide()}$(".mainMenuItem").hide()}else{$(".imageContextMenuURLE").attr("data-src","").hide();$(".imageContextMenuURL").attr("data-src","").hide();$(".mainMenuItem").show()}$_w_ul.css("left",e.pageX+"px").css("top",e.pageY+"px");$_w_ul.fadeIn("fast");$_w_ul.offset().left+$_w_ul.outerWidth()>=window.scrollX+window.innerWidth&&$_w_ul.css("left",e.pageX-$_w_ul.outerWidth()+"px");$_w_ul.offset().top+$_w_ul.outerHeight()>=window.scrollY+window.innerHeight&&$_w_ul.css("top",e.pageY-$_w_ul.outerHeight()+"px");return false}));let $_w_imageSummary=$("#image_summary");let $_w_imageAmount=$("<span />",{id:"image_amount",role:"presentation",class:"summary_badge",text:_o_numberToFixedLengthStr(0,6)});let $_w_imageAmountLbl=$("<label />",{});$_w_imageAmountLbl.append(_MSG_("ext_header_summary_amount"));$_w_imageAmountLbl.append($_w_imageAmount);$_w_imageSummary.append($_w_imageAmountLbl);let $_w_visibleAmount=$("<span />",{id:"visible_amount",role:"presentation",class:"summary_badge",text:_o_numberToFixedLengthStr(0,6)});let $_w_visibleAmountLbl=$("<label />",{});$_w_visibleAmountLbl.append(_MSG_("ext_header_summary_visible"));$_w_visibleAmountLbl.append($_w_visibleAmount);$_w_imageSummary.append($_w_visibleAmountLbl);let $_w_selectAmount=$("<span />",{id:"select_amount",role:"presentation",class:"summary_badge",text:_o_numberToFixedLengthStr(0,6)});let $_w_selectAmountLbl=$("<label />",{});$_w_selectAmountLbl.append(_MSG_("ext_header_summary_selected"));$_w_selectAmountLbl.append($_w_selectAmount);$_w_imageSummary.append($_w_selectAmountLbl);let $_w_menuSwitch=$("#menu_switch");let $_w_menuSwitchGrp=$("<div />",{class:"btn-group btn-group-xs"});$_w_menuSwitch.append($_w_menuSwitchGrp);let $_w_filterSwitch=$("<div />",{class:"btn btn-default",id:"filter_switch",title:_MSG_("ext_menu_btn_filter_menu_switch")});let $_w_filterSwitchIcon=$("<span />",{class:"glyphicon glyphicon-filter"});$_w_filterSwitch.append($_w_filterSwitchIcon);$_w_filterSwitch.on("click",(async function(){let _w_newStatus=(await chrome.runtime.sendMessage({type:"readSetting",key:"_w_parka"})).value;if($(this).hasClass("active")){_w_newStatus&=~1}else{_w_newStatus|=1}await chrome.runtime.sendMessage({type:"saveSetting",key:"_w_parka",value:_w_newStatus});await _o_dynamicRender("#ext_main>.imageItem",true,false)}));$_w_menuSwitchGrp.append($_w_filterSwitch);let $_w_selectMenuSwitch=$("<div />",{class:"btn btn-default",id:"select_menu_switch",title:_MSG_("ext_menu_btn_operation_menu_switch")});let $_w_selectMenuSwitchIcon=$("<span />",{class:"glyphicon glyphicon-tasks"});$_w_selectMenuSwitch.append($_w_selectMenuSwitchIcon);$_w_selectMenuSwitch.on("click",(async function(){let _w_newStatus=(await chrome.runtime.sendMessage({type:"readSetting",key:"_w_parka"})).value;if($(this).hasClass("active")){_w_newStatus&=~2}else{_w_newStatus|=2}await chrome.runtime.sendMessage({type:"saveSetting",key:"_w_parka",value:_w_newStatus});await _o_dynamicRender("#ext_main>.imageItem",true,false)}));$_w_menuSwitchGrp.append($_w_selectMenuSwitch);let $_w_sortSwitch=$("<div />",{class:"btn btn-default",id:"sort_switch",title:_MSG_("ext_menu_btn_sort_switch")});let $_w_sortSwitchIcon=$("<span />",{class:"glyphicon glyphicon-sort-by-order-alt"});$_w_sortSwitch.append($_w_sortSwitchIcon);$_w_sortSwitch.on("click",_o_sortSwitchRoll);$_w_sortSwitch.on("funExec",_w_vertex);$_w_menuSwitchGrp.append($_w_sortSwitch);let $_w_resolutionTleSwitch=$("<div />",{class:"btn btn-default",id:"resolutionTle_switch",title:_MSG_("ext_menu_btn_resolution_show_switch")});let $_w_resolutionTleSwitchIcon=$("<span />",{class:"glyphicon glyphicon-text-background"});$_w_resolutionTleSwitch.append($_w_resolutionTleSwitchIcon);$_w_resolutionTleSwitch.on("click",_o_resolutionTleSwitchRoll);$_w_menuSwitchGrp.append($_w_resolutionTleSwitch);let $_w_den=$("<div />",{class:"btn btn-default",id:"imageDeduplication_switch",title:_MSG_("_w_polish")});let $_w_loaf=$("<span />",{class:"glyphicon glyphicon-compressed"});$_w_den.append($_w_loaf);$_w_den.on("click",_w_plait);$_w_den.on("funExec",_w_tatter);$_w_menuSwitchGrp.append($_w_den);let $_w_activeExtractedPageBtn=$("<div />",{class:"btn btn-success",title:_MSG_("ext_menu_btn_switch_to_origin_page")});$_w_activeExtractedPageBtn.on("click",(async function(){let tab=null;try{tab=await chrome.tabs.get(_o_tabId)}catch(e){}if(tab&&_o_tabUrl==tab.url){chrome.tabs.update(tab.id,{active:true},(function(){}))}}));$_w_activeExtractedPageBtn.append($("<span />",{class:"fa fa-exchange-alt"}));let $_w_prig=$("<div />",{class:"btn btn-primary",title:_MSG_("_w_purse")});$_w_prig.on("click",(async function(){let tab=null;try{tab=await chrome.tabs.get(_o_tabId)}catch(e){}if(tab&&_o_tabUrl==tab.url){chrome.tabs.update(tab.id,{active:true},(async function(tab){await chrome.runtime.sendMessage({type:"_w_brood",_o_tabId:tab.id,_w_timeout:100,checkVisible:false})}))}}));$_w_prig.append($("<span />",{class:"glyphicon glyphicon-save-file"}));let $_w_closeAllRelativePageBtn=$("<div />",{class:"btn btn-danger",title:_MSG_("ext_menu_btn_close_origin_page")});$_w_closeAllRelativePageBtn.on("click",_o_closeAllRelativePage);$_w_closeAllRelativePageBtn.append($("<span />",{class:"glyphicon glyphicon-remove"}));$_w_menuSwitch.append($("<div />",{class:"btn-group btn-group-xs"}).append($_w_activeExtractedPageBtn).append($_w_prig).append($_w_closeAllRelativePageBtn));let $_w_filterMenuType=$("#filter_menu_type");$_w_filterMenuType.append($("<label />",{text:_MSG_("ext_menu_label_ext_type"),class:"header_menu_label"}));let _w_filter_type=_o_filter_image_type.slice(0);_w_filter_type.unshift("all");_w_filter_type.push("other");let $_w_typeItemContainer=$("<div />",{class:"header_menu_body btn-toolbar",role:"toolbar"});for(let i in _w_filter_type){if(isNaN(i))continue;let $_w_typeButton=$("<div />",{class:"btn btn-default btn-xs imageType btn-pwd active",value:_w_filter_type[i],text:_w_filter_type[i].toUpperCase()});let $_w_counter=$("<span />",{id:"counter_"+_w_filter_type[i],role:"presentation",class:"summary_badge",text:"0"});$_w_typeButton.append($_w_counter);if(_w_filter_type[i]!="all")$_w_typeButton.hide();$_w_typeItemContainer.append($_w_typeButton)}$_w_filterMenuType.append($_w_typeItemContainer);$("#filter_menu_type .imageType").click((function(e){$(this).hasClass("active")?$(this).removeClass("btn-pwd active"):$(this).addClass("btn-pwd active");if($(this).attr("value")=="all"){$(this).hasClass("active")?$(this).siblings().addClass("btn-pwd active"):$(this).siblings().removeClass("btn-pwd active")}$("#filter_menu_type .imageType[value!=all]:not(.active)").length>0?$("#filter_menu_type .imageType[value=all]").removeClass("btn-pwd active"):$("#filter_menu_type .imageType[value=all]").addClass("btn-pwd active");_o_dynamicRender("#ext_main>.imageItem",true,false)}));let _w_size_select_type=[{name:_MSG_("ext_menu_item_larger"),value:"larger",active:true},{name:_MSG_("ext_menu_item_exact"),value:"exact"}];let $_w_filterMenuSize=$("#filter_menu_size");let $_w_mania=$("<div />",{id:"funnel_container"});$_w_mania.append($("<label />",{text:_MSG_("ext_menu_label_funnel"),class:"header_menu_label"}));let $_w_nadir=$("<div />",{class:"header_menu_body"});let _o_image_size_funnel=[];for(let item in _o_image_size){_o_image_size_funnel[item]=_o_image_size[item]}let _w_optName=_o_minRect.width+"x"+_o_minRect.height+_MSG_("ext_menu_funnel_option_def");_o_image_size_funnel.unshift(_w_optName);_o_image_size_funnel[_w_optName]={width:_o_minRect.width,height:_o_minRect.height};let _w_funnelOptionSelect=document.createElement("select");_w_funnelOptionSelect.setAttribute("id","funnelOptionSelect");for(let i in _o_image_size_funnel){if(isNaN(i))continue;let _w_funnelOption=document.createElement("option");_w_funnelOption.value=_o_image_size_funnel[i];_w_funnelOption.text=_o_image_size_funnel[i];_w_funnelOptionSelect.appendChild(_w_funnelOption);i==0&&(_w_funnelOption.selected=true)}$_w_nadir.append(_w_funnelOptionSelect);$_w_mania.append($_w_nadir);$_w_filterMenuSize.append($_w_mania);$(_w_funnelOptionSelect).on("change",(function(){let _w_selectedOptn=_o_image_size_funnel[_w_funnelOptionSelect.selectedOptions[0].value];_o_minRect.width=_w_selectedOptn.width;_o_minRect.height=_w_selectedOptn.height;let _w_removeList=[];$("#ext_main .imageItem").each((function(){if($(this).attr("data-width")-_w_selectedOptn.width<0||$(this).attr("data-height")-_w_selectedOptn.height<0){$(this).remove()}}));$(this).blur();_o_dynamicRender("#ext_main>.imageItem",true,false)}));let $_w_pitch=$("<div />",{id:"line_option_container"});$_w_pitch.append($("<label />",{text:_MSG_("ext_menu_label_resolution"),class:"header_menu_label"}));let $_w_sizeOptionContainer=$("<div />",{class:"header_menu_body btn-toolbar",role:"toolbar"});let _o_image_size_ext=[];for(let item in _o_image_size){_o_image_size_ext[item]=_o_image_size[item]}_o_image_size_ext.unshift("all");_o_image_size_ext["all"]={width:0,height:0};_o_image_size_ext.push("other");_o_image_size_ext["other"]={width:0,height:0};let $_w_gibe=$("<div />",{class:"btn-group"});for(let i in _w_size_select_type){if(isNaN(i))continue;let $_w_selectTypeButton=$("<div />",{class:"btn btn-default btn-xs selectType",value:_w_size_select_type[i].value,text:_w_size_select_type[i].name});_w_size_select_type[i].active&&$_w_selectTypeButton.addClass("btn-pwd active");$_w_gibe.append($_w_selectTypeButton)}$_w_sizeOptionContainer.append($_w_gibe);$_w_pitch.append($_w_sizeOptionContainer);$_w_filterMenuSize.append($_w_pitch);let $_w_sizeItemContainer=$_w_sizeOptionContainer;for(let i in _o_image_size_ext){if(isNaN(i))continue;let $_w_selectOptionButton=$("<div />",{class:"btn btn-default btn-xs selectOption btn-pwd active",value:_o_image_size_ext[i],text:_o_image_size_ext[i].toUpperCase()});if(_o_image_size_ext[i]!="all")$_w_selectOptionButton.hide();$_w_sizeItemContainer.append($_w_selectOptionButton)}$("#filter_menu_size .selectType").click((function(){$("#filter_menu_size .selectType").removeClass("btn-pwd active");$("#filter_menu_size .selectOption").addClass("btn-pwd active");$(this).addClass("btn-pwd active");_o_dynamicRender("#ext_main>.imageItem",true,false)}));$("#filter_menu_size .selectOption").click((function(){if($("#filter_menu_size .selectType[value=larger]").hasClass("active")){if($(this).attr("value")=="all"){$("#filter_menu_size .selectOption").addClass("btn-pwd active")}else{$("#filter_menu_size .selectOption").removeClass("btn-pwd active");$(this).addClass("btn-pwd active")}}else if($("#filter_menu_size .selectType[value=exact]").hasClass("active")){$(this).hasClass("active")?$(this).removeClass("btn-pwd active"):$(this).addClass("btn-pwd active");if($(this).attr("value")=="all"){if($(this).hasClass("active")){$("#filter_menu_size .selectOption").addClass("btn-pwd active")}else{$("#filter_menu_size .selectOption").removeClass("btn-pwd active")}}else{$("#filter_menu_size .selectOption[value!=all]:not(.active)").length>0?$("#filter_menu_size .selectOption[value=all]").removeClass("btn-pwd active"):$("#filter_menu_size .selectOption[value=all]").addClass("btn-pwd active")}}_o_dynamicRender("#ext_main>.imageItem",true,false)}));let $_w_filterMenuRegexp=$("#filter_menu_regexp");$_w_filterMenuRegexp.append($("<label />",{text:_MSG_("ext_menu_label_regexp"),class:"header_menu_label"}));let $_w_filterMenuRegexpContainer=$("<div />",{class:"header_menu_body btn-toolbar",role:"toolbar"});let $_w_filterMenuRegexpInput=$("<input />",{id:"urlRegexpFilter",class:"ext_page_input",size:64,placeHolder:"Input Regexp Expression to part/full match URL address."});$_w_filterMenuRegexpContainer.append($_w_filterMenuRegexpInput);$_w_filterMenuRegexp.append($_w_filterMenuRegexpContainer);$_w_filterMenuRegexpInput.on("change input",(function(){_o_dynamicRender("#ext_main>.imageItem",true,false)})).on("keydown",(function(e){if(e.which==13||e.which==27){$(this).blur()}}));let $_w_rivet=$("#dedup_menu");$_w_rivet.append($("<label />",{text:_MSG_("_w_fiasco"),class:"header_menu_label"}));let $_w_herd=$("<div />",{class:"header_menu_body"});let _w_din=document.createElement("select");_w_din.setAttribute("id","diffThresholdOptionSelect");Array(7).fill().forEach(((_,idx)=>{let _w_trend=document.createElement("option");_w_trend.value=idx;_w_trend.text=idx==4?`${idx} ☻`:idx;_w_din.appendChild(_w_trend);if(idx==global._w_scale){_w_din.selected=true}}));$_w_herd.append(_w_din);$_w_rivet.append($_w_herd);_w_din.value=global._w_scale;$(_w_din).on("change",(function(){global._w_scale=parseInt(_w_din.selectedOptions[0].value);document.querySelectorAll("a.imageItem[data-phash]").forEach((item=>{_w_bore({data:{id:item.dataset.id,grayHash:item.dataset.phash}},true)}));_o_dynamicRender("#ext_main>.imageItem",true,false)}));$_w_rivet.hide();_o_dynamicRender("#ext_main>.imageItem",true,true)}function _o_dump_imageMap(){let _w_now=new Date;let _w_filename="".concat(_w_now.getFullYear()).concat(_w_now.getDate()).concat(_w_now.getMonth()+1).concat(_w_now.getHours()).concat(_w_now.getMinutes()).concat(_w_now.getSeconds()).concat(".js");let _w_content="let _o_iterator = ".concat(_o_iterator).concat(";\nlet _o_max_loading = 0;\n").concat("let entityData = ").concat(JSON.stringify(Object.entries(_o_imageMap).filter((function(item){if(isNaN(item[0])){return item}})))).concat(";\n");_o_downloadText(_w_filename,_w_content)}function _o_load_imageMap(_w_entityData){let _w_imageMap=[];_w_entityData.forEach((function(item){if(typeof item[0]!="number"){_w_imageMap.push(item[0]);_w_imageMap[item[0]]=item[1]}}));_o_imageMap=_w_imageMap}function _o_retryFaildImages(_w_bypassFun){if(!_o_img_load_failed_set)return;let _w_tasks=Object.keys(_o_img_load_failed_set);let _w_intervalTimer=null;_w_intervalTimer=setInterval((function(){if(_o_loading>=_o_max_loading||$("a.imageItem").length>=_o_max_loaded-_o_loading){return}else{if(_w_tasks.length<=0){clearInterval(_w_intervalTimer);return}let _w_taskIdx=_w_tasks.shift();if(_o_isFunction(_w_bypassFun)&&_w_bypassFun(_o_imageMap[_w_taskIdx])){delete _o_img_load_failed_set[_w_taskIdx];return}_o_showImage(_w_taskIdx,false)}}),50)}$((async function(){await init01();await init02();await init03();await init04();await init05();await init06()}));