/**
 * ImageAssistant
 * Project Home: http://www.pullywood.com/ImageAssistant/
 * Author: Joey
 * Copyright (C) 2013-2024 普利坞(Pullywood.com)
**/
"use strict";if(typeof global==="undefined"){if(typeof window!=="undefined"){window.global=window}else{globalThis.global=globalThis}}global._o_currentTabId=null;global._o_url_prefetch_url_executor=_o_createTaskExecutePool(4);global.createDiv=function(className){return $("<div />",{class:className})};chrome.tabs.getCurrent((function(tab){global._o_currentTabId=tab.id}));function _o_parseExtUrl(_w_text){let _w_urlArray=_w_text.split("\n");let _o_urlArrayContainer={};for(let idx in _w_urlArray){let _w_url=_w_urlArray[idx].trim();if(_o_isAccessibleUrl(_w_url)){_o_urlArrayContainer[_w_url]=true}}return Object.keys(_o_urlArrayContainer)}$((function(){$("#header_link_container").append($("<a />",{class:"navbar-brand",text:_MSG_("opt_brand_text")}).prepend($("<img />",{src:"./images/icon128.png",id:"brand_text"})));$("#navbar").append($("<ul />",{class:"nav navbar-nav navbar-right"}).append($("<li />").append($("<a />",{id:"_pullywood_home_",target:"_pullywood_",href:"https://www.pullywood.com/",text:_MSG_("opt_navbar_item_pwd_home")}).prepend($("<span />",{class:"glyphicon glyphicon-home"})))).append($("<li />").append($("<a />",{target:"_ImageAssistant_Plus_",href:"https://www.pullywood.com/ImageAssistant_Plus/",text:_MSG_("pop_menu_item_ext_favorite")}).prepend($("<span />",{class:"fab fa-app-store"})))));let $_w_mainContainer=$("#main");let $_w_formContainer=$("<form />",{class:"form-horizontal"});$_w_formContainer.on("submit",(function(){return false}));$_w_mainContainer.append($_w_formContainer);let $_w_h4title=$("<h4 />",{text:_MSG_("multi_ext_batch_generate_ext_url")});$_w_formContainer.append($_w_h4title);let $_w_formGrp0=createDiv("form-group");let $_w_expressionInput=$("<input />",{type:"text",class:"form-control",placeHolder:_MSG_("multi_ext_wildcard_expression")});let _w_originalUrl=_o_getQueryString("originalUrl");if(_w_originalUrl&&_w_originalUrl.length>0){try{_w_originalUrl=decodeURIComponent(_w_originalUrl)}catch(exception){}$_w_expressionInput.prop("value",_w_originalUrl)}let $_w_inputGrp0=createDiv("input-group");let $_w_expressionInputAddon=$("<span />",{class:"input-group-addon",text:_MSG_("multi_ext_url_wildcard_expression")});$_w_inputGrp0.append($_w_expressionInputAddon);$_w_inputGrp0.append($_w_expressionInput);$_w_formGrp0.append(createDiv("col-md-12 col-sm-12").append($_w_inputGrp0));$_w_formContainer.append($_w_formGrp0);let $_w_formGrp1=createDiv("form-group");let $_w_startIdx=$("<input />",{class:"form-control",type:"number",min:0,max:99999999999,step:1,value:1,placeHolder:_MSG_("multi_ext_start_value")});let $_w_endIdx=$("<input />",{class:"form-control",type:"number",min:0,max:99999999999,step:1,value:1,placeHolder:_MSG_("multi_ext_start_value")});let $_w_stepIdx=$("<input />",{class:"form-control",type:"number",min:-99999999999,max:99999999999,step:1,value:1,placeHolder:_MSG_("multi_ext_step_value")});let $_w_minIdx=$("<input />",{class:"form-control",type:"number",min:1,max:128,step:1,value:1,placeHolder:_MSG_("multi_ext_wildcard_min_length")});let $_w_startIdxGrp=createDiv("input-group");let $_w_startIdxAddon=$("<span />",{class:"input-group-addon",text:_MSG_("multi_ext_start_value_title")});$_w_startIdxGrp.append($_w_startIdxAddon);$_w_startIdxGrp.append($_w_startIdx);let $_w_endIdxGrp=createDiv("input-group");let $_w_endIdxAddon=$("<span />",{class:"input-group-addon",text:_MSG_("multi_ext_end_value_title")});$_w_endIdxGrp.append($_w_endIdxAddon);$_w_endIdxGrp.append($_w_endIdx);let $_w_stepIdxGrp=createDiv("input-group");let $_w_stepIdxAddon=$("<span />",{class:"input-group-addon",text:_MSG_("multi_ext_step_value_title")});$_w_stepIdxGrp.append($_w_stepIdxAddon);$_w_stepIdxGrp.append($_w_stepIdx);let $_w_minIdxGrp=createDiv("input-group");let $_w_minIdxAddon=$("<span />",{class:"input-group-addon",text:_MSG_("multi_ext_wildcard_min_length_title")});$_w_minIdxGrp.append($_w_minIdxAddon);$_w_minIdxGrp.append($_w_minIdx);let _w_propAdjustFun=function(_w_element){let $_w_item;if(_w_element instanceof jQuery){$_w_item=_w_element}else{$_w_item=$(_w_element)}if($_w_item.prop("value")-$_w_item.prop("min")<0){$_w_item.prop("value",$_w_item.prop("min"))}else if($_w_item.prop("value")-$_w_item.prop("max")>0){$_w_item.prop("value",$_w_item.prop("max"))}};$_w_startIdx.on("change",(function(){_w_propAdjustFun($(this));if($(this).prop("value")-$_w_endIdx.prop("value")>0){$_w_endIdx.prop("value",$(this).prop("value"))}}));$_w_endIdx.on("change",(function(){_w_propAdjustFun($(this));if($(this).prop("value")-$_w_startIdx.prop("value")<0){$_w_startIdx.prop("value",$(this).prop("value"))}}));$_w_minIdx.on("change",(function(){_w_propAdjustFun($(this))}));let $_w_createBtn=$("<button />",{class:"form-control btn btn-pwd",text:_MSG_("ext_menu_item_generate_url")}).prepend($("<span />",{class:"glyphicon glyphicon-flash"}));$_w_formGrp1.append(createDiv("col-md-2 col-sm-2").append($_w_startIdxGrp));$_w_formGrp1.append(createDiv("col-md-2 col-sm-2").append($_w_endIdxGrp));$_w_formGrp1.append(createDiv("col-md-2 col-sm-2").append($_w_stepIdxGrp));$_w_formGrp1.append(createDiv("col-md-3 col-sm-3").append($_w_minIdxGrp));$_w_formGrp1.append(createDiv("col-md-3 col-sm-3").append($_w_createBtn));$_w_formContainer.append($_w_formGrp1);let $_w_h4ExtUrlTitle=$("<h4 />",{text:_MSG_("multi_ext_charactistic_ext_url")});$_w_formContainer.append($_w_h4ExtUrlTitle);let $_w_formGrp2=createDiv("form-group");let $_w_urlMark0=$("<input />",{class:"form-control",type:"text",placeHolder:_MSG_("multi_ext_url_charactistic_1")});let $_w_urlMark1=$("<input />",{class:"form-control",type:"text",placeHolder:_MSG_("multi_ext_url_charactistic_2")});let $_w_urlMark2=$("<input />",{class:"form-control",type:"text",placeHolder:_MSG_("multi_ext_url_charactistic_3")});let $_w_urlMark0Grp=createDiv("input-group");let $_w_urlMark0Addon=$("<span />",{class:"input-group-addon",text:_MSG_("multi_ext_url_charactistic_1_title")});$_w_urlMark0Grp.append($_w_urlMark0Addon);$_w_urlMark0Grp.append($_w_urlMark0);let $_w_urlMark1Grp=createDiv("input-group");let $_w_urlMark1Addon=$("<span />",{class:"input-group-addon",text:_MSG_("multi_ext_url_charactistic_2_title")});$_w_urlMark1Grp.append($_w_urlMark1Addon);$_w_urlMark1Grp.append($_w_urlMark1);let $_w_urlMark2Grp=createDiv("input-group");let $_w_urlMark2Addon=$("<span />",{class:"input-group-addon",text:_MSG_("multi_ext_url_charactistic_3_title")});$_w_urlMark2Grp.append($_w_urlMark2Addon);$_w_urlMark2Grp.append($_w_urlMark2);let $_w_extUrlBtn=$("<button />",{class:"form-control btn btn-pwd",text:_MSG_("multi_ext_charactistic_extract_url")}).prepend($("<span />",{class:"glyphicon glyphicon-list"}));let $_w_extUrlSign=$("<span />");$_w_extUrlBtn.append($_w_extUrlSign);$_w_formGrp2.append(createDiv("col-md-3 col-sm-3").append($_w_urlMark0Grp));$_w_formGrp2.append(createDiv("col-md-3 col-sm-3").append($_w_urlMark1Grp));$_w_formGrp2.append(createDiv("col-md-3 col-sm-3").append($_w_urlMark2Grp));$_w_formGrp2.append(createDiv("col-md-3 col-sm-3").append($_w_extUrlBtn));$_w_formContainer.append($_w_formGrp2);let $_w_formGrp3=createDiv("form-group");let $_w_h4TextareaTitle=$("<h4 />",{text:_MSG_("multi_ext_urls_to_deal")});let $_w_h4TextareaMark=$("<span />");$_w_h4TextareaTitle.append($_w_h4TextareaMark);$_w_formContainer.append($_w_h4TextareaTitle);let $_w_textarea=$("<textarea />",{id:"url_area",class:"form-control",rows:16,placeHolder:_MSG_("multi_ext_one_url_perline")});$_w_formGrp3.append(createDiv("col-md-12 col-sm-12").append($_w_textarea));$_w_formContainer.append($_w_formGrp3);let $_w_formGrp4=createDiv("form-group");let $_w_extImageBtn=$("<button />",{id:"batch_ext_btn",class:"btn btn-pwd linkMode",text:_MSG_("multi_ext_batch_extract_images")}).prepend($("<span />",{class:"glyphicon glyphicon-list-alt"}));let $_w_newTabExtImageBtn=$("<button />",{id:"batch_new_tab_ext_btn",class:"btn btn-success",text:_MSG_("multi_ext_open_new_window_for_extract")}).prepend($("<span />",{class:"fa fa-bomb"}));$_w_formGrp4.append(createDiv("col-md-12 col-sm-12").append(createDiv("btn-group").append($_w_extImageBtn).append($_w_newTabExtImageBtn)));$_w_formContainer.append($_w_formGrp4);$_w_createBtn.on("click",(function(){let _w_expressionStr=$_w_expressionInput.prop("value");let _w_startIdx=parseInt($_w_startIdx.prop("value"));let _w_endIdx=parseInt($_w_endIdx.prop("value"));let _w_stepIdx=parseInt($_w_stepIdx.prop("value"));let _w_minIdx=parseInt($_w_minIdx.prop("value"));if(!_o_isAccessibleUrl(_w_expressionStr)||_w_expressionStr.indexOf("(*)")<0){$_w_expressionInputAddon.popover({title:"<span class='glyphicon glyphicon-info-sign'></span> "+_MSG_("multi_ext_illegal_wildcard_expression"),content:_MSG_("multi_ext_illegal_wildcard_expression_content"),placement:"right",html:true}).popover("show").next().on("click",(function(){$(this).popover("destroy")})).next().on("click",(function(){$(this).prev().popover("destroy")}));return}let _w_createdUrls="";_w_startIdx=Math.floor(_w_startIdx);_w_endIdx=Math.floor(_w_endIdx);if(_w_stepIdx>=0&&_w_stepIdx<1){_w_stepIdx=1}else{_w_stepIdx=Math.floor(_w_stepIdx)}for(let idx=_w_startIdx;idx<=_w_endIdx;idx+=Math.abs(_w_stepIdx)){let _w_expressionValue=_o_numberToFixedLengthStr(idx,_w_minIdx);_w_expressionValue=_w_expressionStr.replaceAll("(*)",_w_expressionValue);if(_w_stepIdx>0){_w_createdUrls+=_w_expressionValue+"\n"}else{_w_createdUrls=_w_expressionValue+"\n"+_w_createdUrls}}$_w_textarea.prop("value",$_w_textarea.prop("value")+"\n"+_w_createdUrls)}));$_w_extUrlBtn.on("click",(function(){let _o_urlArray=_o_parseExtUrl($_w_textarea.prop("value"));if(_o_urlArray.length==0){$_w_h4TextareaMark.popover({title:"<span class='glyphicon glyphicon-info-sign'></span> "+_MSG_("multi_ext_url_list_is_empty"),content:_MSG_("multi_ext_url_list_is_empty_content"),placement:"right",html:true}).popover("show").next().on("click",(function(){$(this).popover("destroy")}));return}let _w_markArray=[];let _w_mark0=$_w_urlMark0.prop("value");let _w_mark1=$_w_urlMark1.prop("value");let _w_mark2=$_w_urlMark2.prop("value");if(_w_mark0&&_w_mark0.trim().length>0)_w_markArray.push(_w_mark0);if(_w_mark1&&_w_mark1.trim().length>0)_w_markArray.push(_w_mark1);if(_w_mark2&&_w_mark2.trim().length>0)_w_markArray.push(_w_mark2);$_w_textarea.prop("value","");let _w_split_mark=" {#^_^#}";let _w_cur_print=_w_mark0+_w_split_mark+_w_mark1+_w_split_mark+_w_mark2;if(!global._o_prev_print||global._o_prev_print!=_w_cur_print){global._o_prev_print=_w_cur_print;global._o_cache={}}function _o_ruleMatch(_w_aHref,_w_markArray){for(let idx=0;idx<_w_markArray.length;++idx){let _w_markRule=_w_markArray[idx];if(_w_aHref.indexOf(_w_markRule)<0){return false}}return true}let _w_resultContainer={};let _w_resultUrls=_o_urlArray.filter((function(item){if(_o_ruleMatch(item,_w_markArray)){_w_resultContainer[item]=true;return item}}));while(_o_urlArray.length>0){let _w_taskUrl=_o_urlArray.shift();if(global._o_cache[_w_taskUrl]){Object.keys(global._o_cache[_w_taskUrl]).forEach((function(item){if(!_w_resultContainer[item]&&_o_ruleMatch(item,_w_markArray)){_w_resultContainer[item]=true;_w_resultUrls.push(item)}}));continue}_o_url_prefetch_url_executor.addTask((function(_w_beginFun,_w_endFun,_w_taskLeftFun){let _w_statusFun=function(_w_lockBtn){let _w_taskStatus=_w_taskLeftFun();$_w_extUrlSign.html("("+_w_taskStatus[0]+"/"+_w_taskStatus[1]+" -> "+_w_resultUrls.length+")");if(_w_lockBtn||_w_taskStatus[0]>0||_w_taskStatus[1]>0){$_w_createBtn.attr("disabled",true);$_w_extUrlBtn.attr("disabled",true);$_w_extImageBtn.attr("disabled",true);$_w_newTabExtImageBtn.attr("disabled",true)}else{$_w_extUrlSign.html("");$_w_createBtn.attr("disabled",false);$_w_extUrlBtn.attr("disabled",false);$_w_extImageBtn.attr("disabled",false);$_w_newTabExtImageBtn.attr("disabled",false)}};_w_statusFun(true);_w_beginFun();$.ajax({method:"get",url:_w_taskUrl,timeout:_o_ajax_request_timeout,headers:{Accept:"*/*; charset=UTF-8","Cache-Control":"no-cache, no-store, must-revalidate, max-age=0, post-check=0, pre-check=0",Pragma:"no-cache",Expires:"0","IA-Tag":"extractor_hash_temporarily_unavaiable"}}).done((function(data){let _w_parseHTMLDocument=document.implementation.createHTMLDocument("parseHTMLDocument");let _w__html=_w_parseHTMLDocument.createElement("html");_w__html.innerHTML=DOMPurify.sanitize(data,{WHOLE_DOCUMENT:true});let $_w__html=$(_w__html);$_w__html.find("a").each((function(){let _w_aHref=$(this).attr("href");_w_aHref=_o_pathConvert(_w_taskUrl,_w_aHref);if(_o_ruleMatch(_w_aHref,_w_markArray)){if(!global._o_cache[_w_taskUrl])global._o_cache[_w_taskUrl]={};global._o_cache[_w_taskUrl][_w_aHref]=true;if(_w_aHref.indexOf("#")>0)_w_aHref=_w_aHref.substring(0,_w_aHref.indexOf("#"));if(!_w_resultContainer[_w_aHref]){_w_resultContainer[_w_aHref]=true;_w_resultUrls.push(_w_aHref)}}}))})).always((function(){_w_endFun();_w_statusFun()}))}))}let _w_waitResultInterval=setInterval((function(){if(_o_url_prefetch_url_executor.getTaskNum()>0||_o_url_prefetch_url_executor.getProcessingNum()>0)return;clearInterval(_w_waitResultInterval);$_w_textarea.prop("value",_w_resultUrls.reduce((function(a,b){return a+"\n"+b})));$_w_textarea.scrollTop($_w_textarea.get(0).scrollHeight)}),250)}));$_w_extImageBtn.on("click",(async function(){$(".btn").attr("disabled",true);let _o_urlArray=_o_parseExtUrl($_w_textarea.prop("value"));if(_o_urlArray.length>0){await _o_linkExt(_o_urlArray)}}));$_w_newTabExtImageBtn.on("click",(async function(){let _o_urlArray=_o_parseExtUrl($_w_textarea.prop("value"));if(_o_urlArray.length>0){$_w_textarea.attr("disabled",true);$(".btn").attr("disabled",true);await _o_tabExt(_o_urlArray,(function(){$_w_textarea.prop("value","");$_w_textarea.attr("disabled",false);$(".btn").attr("disabled",false)}))}}));let _w_msgChannel=_o_getQueryString("msgChannel");if(_w_msgChannel&&_w_msgChannel.length>0){chrome.runtime.onMessage.addListener((function(message,sender,callback){message&&message.type=="_o_tezhengExt"&&message.channel==_w_msgChannel&&_o_links_ext(message.links,message.currentPageUrl)&_o_characteristic_ext(message.collections)}))}$("#dialog_add_all").on("click",(function(){$(".btn.add_task_btn:visible").click()}));$("#dialog_ext_all").on("click",(function(){$(".btn.add_task_btn:visible").click();$("#batch_ext_btn").click()}));$("#dialog_ext_all_in_new_window").on("click",(function(){$(".btn.add_task_btn:visible").click();setTimeout((function(){$("#batch_new_tab_ext_btn").click()}),0)}));document.title=_MSG_("multi_ext_html_title");$("#i18n_charactistic_url_ext").text(_MSG_("multi_ext_charactistic_url_ext"));$("#i18n_group_keyword_filter").text(_MSG_("multi_ext_group_keyword_filter"));$("#dialog_add_all").text(_MSG_("multi_ext_dialog_add_all_btn"));$("#dialog_ext_all").text(_MSG_("multi_ext_dialog_ext_all_btn"));$("#dialog_ext_all_in_new_window").text(_MSG_("multi_ext_dialog_ext_all_in_new_window_btn"));$("#grp_keyword_filter").attr("placeHolder",_MSG_("multi_ext_group_keyword_filter_placeholder"));$("#dialog_close_btn").text(_MSG_("multi_ext_dialog_close_btn"))}));global.waterBasic=function(){function init(){$("#group_container").css("height",$(window).height()-280);let _w_nodeWidth=$(".grp_item:visible").outerWidth(true),colNum=3,colSumHeight=[];for(let i=0;i<colNum;i++){colSumHeight.push(0)}$(".grp_item:visible").each((function(){let $_w_tariff=$(this),idx=0,minSumHeight=colSumHeight[0];for(let i=0;i<colSumHeight.length;i++){if(minSumHeight>colSumHeight[i]){minSumHeight=colSumHeight[i];idx=i}}$_w_tariff.css({left:_w_nodeWidth*idx,top:minSumHeight});colSumHeight[idx]=colSumHeight[idx]+$_w_tariff.outerHeight(true)}))}$(window).on("resize",(function(){init()}));return{init:init}}();function _o_links_ext(_w_links,_w_currentPageUrl){if(_w_links.length==0){return}let $_w_links_filter_container=$("#links_filter_container");let $_w_links_filter_item_container=$("#links_filter_item_container");let $_w_add_task_btn=$_w_links_filter_container.find(".add_task_btn").text(_MSG_("multi_ext_insert_into_list"));let $_w_ext_task_btn=$_w_links_filter_container.find(".ext_task_btn").text(_MSG_("multi_ext_extract_from_current_list"));let $_w_new_window_ext_btn=$_w_links_filter_container.find(".new_window_ext_btn").text(_MSG_("multi_ext_extract_from_new_window"));let $_w_link_item_template=$_w_links_filter_item_container.find(".list-group-item#link_item_template").remove().removeAttr("id");$_w_links_filter_container.find(".msg_links_filter_original_links").text(_MSG_("msg_links_filter_original_links"));let _w_reapItem=function(){let _w_resultStr="";$_w_links_filter_item_container.find(".list-group-item:visible").remove().each((function(){_w_resultStr+=$(this).attr("data-url")+"\n"}));return _w_resultStr};$_w_add_task_btn.on("click",(function(){$("#url_area").prop("value",$("#url_area").prop("value")+_w_reapItem()+"\n");waterBasic.init();return false}));$_w_ext_task_btn.on("click",(function(){$("#url_area").prop("value",_w_reapItem());$("#batch_ext_btn").click()}));$_w_new_window_ext_btn.on("click",(function(){$("#url_area").prop("value",_w_reapItem());setTimeout((function(){$("#batch_new_tab_ext_btn").click()}),0)}));for(let link in _w_links){let _w_title=_w_links[link];let $_w_link_item=$_w_link_item_template.clone();$_w_link_item.attr("data-url",link);$_w_link_item.find(".link_item_title").text(_w_title).addClass(link==_w_currentPageUrl?"bold-text":"");$_w_link_item.find(".link_item_url").text(link);$_w_link_item.appendTo($_w_links_filter_item_container);let _w_charactisticStr=_w_title+" "+link;$("#grp_keyword_filter").on("input change blur",(function(){let _w_keywords=$(this).prop("value").match(/\S+/g);if(!_w_keywords){$_w_link_item.show()}else{let _w_allMatch=true;for(let i in _w_keywords){if(_w_charactisticStr.indexOf(_w_keywords[i])<0){_w_allMatch=false;break}}if(_w_allMatch){$_w_link_item.show()}else{$_w_link_item.hide()}}}))}}function _o_characteristic_ext(_w_collections){let $_w_containers=$("#group_container");for(let idx=0;idx<_w_collections.length;++idx){let _w_collection=_w_collections[idx];let _w_urlList=_w_collection["fillUrlList"];let _w_urlText=_w_collection["fillUrlText"];let _w_currentPageUrl=_w_collection["currentPageUrl"];let _w_charactisticStr=_w_collection["urlList"].reduce((function(a,b){return a+" "+b}))+Object.values(_w_collection["urlText"]).reduce((function(a,b){return a+" "+b}));let $_w_listGrp=$("<div />",{class:"list-group"});let $_w_container=$("<div />",{class:"col-md-4 col-sm-4 grp_item"});$_w_container.append($_w_listGrp);$_w_containers.append($_w_container);let _w_genGrpItem=function(_w_titleText,_w_text,_w_h4Bold){return $("<a />",{class:"list-group-item"}).append($("<h4 />",{class:"list-group-item-heading break_all_word"+(_w_h4Bold?" bold-text":""),text:_w_titleText})).append($("<p />",{class:"list-group-item-text break_all_word",text:_w_text}))};let _w_maxShowItems=8;for(let i=0;i<_w_urlList.length;++i){if(i<_w_maxShowItems-1||_w_maxShowItems==_w_urlList.length){if(_w_currentPageUrl==_w_urlList[i]){$_w_listGrp.append(_w_genGrpItem(_w_urlText[_w_urlList[i]],_w_urlList[i],true))}else{$_w_listGrp.append(_w_genGrpItem(_w_urlText[_w_urlList[i]],_w_urlList[i]))}}else{$_w_listGrp.append(_w_genGrpItem("......",_w_urlList.length-(_w_maxShowItems-1)+_MSG_("multi_ext_redords_not_show")));break}}let _w_genBtn=function(_w_text,_w_extClass){return $("<button />",{class:"btn "+_w_extClass,text:_w_text,"data-dismiss":"modal"})};let _w_genBtnGrp=function($btn){return $("<div />",{class:"btn-group"}).append($btn)};let $_w_btn1=_w_genBtn(_MSG_("multi_ext_insert_into_list"),"btn-primary add_task_btn");let $_w_btn2=_w_genBtn(_MSG_("multi_ext_extract_from_current_list"),"btn-pwd");let $_w_btn3=_w_genBtn(_MSG_("multi_ext_extract_from_new_window"),"btn-success");let $_w_toolbar=$("<div />",{class:"btn-toolbar"});$_w_toolbar.append(_w_genBtnGrp($_w_btn1)).append(_w_genBtnGrp($_w_btn2)).append(_w_genBtnGrp($_w_btn3));$_w_listGrp.prepend($("<a />",{class:"list-group-item"}).append($("<h4 />",{class:"list-group-item-heading break_all_word"}).append($_w_toolbar)));let _w_reduceFun=function(a,b){return a+"\n"+b};$_w_btn1.on("click",(function(){$("#url_area").prop("value",$("#url_area").prop("value")+_w_urlList.reduce(_w_reduceFun)+"\n");$_w_container.remove();waterBasic.init();return false}));$_w_btn2.on("click",(function(){$("#url_area").prop("value",_w_urlList.reduce(_w_reduceFun));$("#batch_ext_btn").click()}));$_w_btn3.on("click",(function(){$("#url_area").prop("value",_w_urlList.reduce(_w_reduceFun));setTimeout((function(){$("#batch_new_tab_ext_btn").click()}),0)}));$("#grp_keyword_filter").on("input change blur",(function(){let _w_keywords=$(this).prop("value").match(/\S+/g);if(!_w_keywords){$_w_container.show()}else{let _w_allMatch=true;for(let i in _w_keywords){if(_w_charactisticStr.indexOf(_w_keywords[i])<0){_w_allMatch=false;break}}if(_w_allMatch){$_w_container.show()}else{$_w_container.hide()}}waterBasic.init()}))}$("#characteristic_ext").on("shown.bs.modal",(function(){waterBasic.init()})).modal()}async function _o_linkExt(_o_urlArray){let _o_fetchLevel=2;await chrome.runtime.sendMessage({type:"_o_resetTabIdMapper",_o_tabId:_o_currentTabId});await chrome.runtime.sendMessage({type:"_o_extractImageFromTab",tabId:_o_currentTabId,fetchLevel:_o_fetchLevel});let _o_extHash=(await chrome.runtime.sendMessage({type:"_o_getTabExtractorHash",_o_tabId:_o_currentTabId})).value+_o_randomFingerChar();let _o_tabInfo={tabId:_o_currentTabId,lastFullScroll:1,lastRequest:1,lastPushImage:1,invalidRequestCount:0,requestLog:{}};await chrome.runtime.sendMessage({type:"_w_hamper",_o_tabInfo:_o_tabInfo});_o_createLink(_o_urlArray,_o_tabInfo);_o_extractImage(_o_fetchLevel,_o_extHash)}async function _o_tabExt(_o_urlArray,_o_callback){let _o_fetchLevel=0;let _o_originalTaskLength=_o_urlArray.length;await chrome.runtime.sendMessage({type:"_o_resetTabIdMapper",_o_tabId:_o_currentTabId});await chrome.runtime.sendMessage({type:"_o_extractImageFromTab",tabId:_o_currentTabId,fetchLevel:_o_fetchLevel});let _o_extHash=(await chrome.runtime.sendMessage({type:"_o_getTabExtractorHash",_o_tabId:_o_currentTabId})).value+_o_randomFingerChar();let _o_currentTitle=document.title;(function doMultiExt(_o_urlArray){if(!_o_urlArray||_o_urlArray.length==0){if(_o_callback){_o_callback()}document.title=_o_currentTitle;return}document.title="Tasks: 0/"+_o_urlArray.length+"/"+_o_originalTaskLength+" - "+_o_currentTitle;let _w_url=_o_urlArray.shift();chrome.tabs.create({url:_w_url,active:false},(function(tab){setTimeout((async function(){if(!tab){doMultiExt(_o_urlArray);return}let _o_tabId=tab.id;let _o_tabInfo={tabId:_o_currentTabId,lastFullScroll:1,lastRequest:1,lastPushImage:1,invalidRequestCount:0,requestLog:{}};await chrome.runtime.sendMessage({type:"_w_hamper",_o_tabInfo:_o_tabInfo});let _o_fullScrollTimeout=1500;let _o_requestTimeout=1500;let _o_pushImageTimeout=2e3;let _o_interval_timer=null;_o_interval_timer=setInterval((async function(){const _w_spike=(await chrome.runtime.sendMessage({type:"_w_bark",tabId:_o_tabInfo.tabId})).value;document.title="Tasks: "+_w_spike["requestNum"]+"/"+_o_urlArray.length+"/"+_o_originalTaskLength+" - "+_o_currentTitle;let _o_currentTime=(new Date).getTime();if(_w_spike["requestNum"]==0&&_o_currentTime-_w_spike["lastFullScroll"]>_o_fullScrollTimeout&&_o_currentTime-_w_spike["lastRequest"]>_o_requestTimeout&&_o_currentTime-_w_spike["lastPushImage"]>_o_pushImageTimeout){(function _o_removeTab(){_w_stern(tab.id,(function(){if(chrome.runtime.lastError&&chrome.runtime.lastError.message.indexOf("dragging")>0){console.log(chrome.runtime.lastError.message,"Retry in one second.");setTimeout(_o_removeTab,1e3)}}))})();doMultiExt(_o_urlArray);clearInterval(_o_interval_timer)}}),100);await chrome.runtime.sendMessage({type:"_w_polish",_o_extHash:_o_extHash,_o_fetchLevel:_o_fetchLevel,_o_tabId:tab.id});await chrome.runtime.sendMessage({type:"_o_registerSecondHashForTab",_o_tabId:tab.id,_w_extractHash:(await chrome.runtime.sendMessage({type:"_o_getTabExtractorHash",_o_tabId:_o_tabId})).value});await chrome.runtime.sendMessage({type:"_w_brood",_o_tabId:tab.id,_w_timeout:50,checkVisible:true})}),512)}))})(_o_urlArray)}function _o_createLink(_w_urls,_o_tabInfo){document.title=_MSG_("multi_ext_imageassistant_multi_url_extract")+"("+(new Date).getTime()+")";let $_w_body=$("body");$_w_body.html("");$_w_body.append(_MSG_("multi_ext_please_do_not_close_before_finish")+"<br />\n");$_w_body.append($("<div />",{id:"linkCounter"}));$_w_body.append($("<div />",{id:"attrSniffCounter"}));$_w_body.append($("<div />",{id:"ajaxTaskCounter"}));let _w_idx=0;setInterval((async function(){const _w_spike=(await chrome.runtime.sendMessage({type:"_w_bark",tabId:_o_tabInfo.tabId})).value;$("#linkCounter").html(_MSG_("multi_ext_url_task_amount")+_w_idx+"/"+_w_urls.length);$("#attrSniffCounter").html(_MSG_("multi_ext_attribute_sniff_thread")+_o_url_prefetch_url_executor.getProcessingNum()+"/"+_o_url_prefetch_url_executor.getTaskNum()+"/"+Object.keys(_o_attr_sniffed_container).length);if(window.funExecutePool){$("#ajaxTaskCounter").html(_MSG_("multi_ext_ajax_request_concurrency")+window.funExecutePool.getProcessingNum()+"/"+window.funExecutePool.getTaskNum()+" - "+_w_spike["requestNum"])}let _o_fullScrollTimeout=1500;let _o_requestTimeout=1500;let _o_pushImageTimeout=2e3;let _o_currentTime=(new Date).getTime();if(_w_spike["requestNum"]==0&&_o_currentTime-_w_spike["lastFullScroll"]>_o_fullScrollTimeout&&_o_currentTime-_w_spike["lastRequest"]>_o_requestTimeout&&_o_currentTime-_w_spike["lastPushImage"]>_o_pushImageTimeout){if(_w_idx>=_w_urls.length)return;if($(".prefetch_link").length>0)return;if(_o_url_prefetch_url_executor&&_o_url_prefetch_url_executor.getTaskNum()>64)return;if(window.funExecutePool&&window.funExecutePool.getTaskNum()>4)return;let _w_url=_w_urls[_w_idx++];$_w_body.append($("<a />",{class:"prefetch_link",href:_w_url}))}}),100)}function _o_prefetch_extend_fun(link){$(link).remove()}