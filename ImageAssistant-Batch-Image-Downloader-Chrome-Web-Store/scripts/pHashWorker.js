/**
 * ImageAssistant
 * Project Home: http://www.pullywood.com/ImageAssistant/
 * Author: Joey
 * Copyright (C) 2013-2024 普利坞(Pullywood.com)
**/
"use strict";importScripts("../libs/jimp/0.16.0/jimp.js");function precomputeCosines(size){let cosines=new Array(size);for(let i=0;i<size;i++){cosines[i]=new Array(size);for(let j=0;j<size;j++){cosines[i][j]=Math.cos(Math.PI*i*(j+.5)/size)}}return cosines}function dct(mat,m,n,cosines){let isqrt2=1/Math.sqrt(2);let r=new Array(m*n).fill(0);for(let ry=0;ry<n;ry++){for(let rx=0;rx<m;rx++){let c=Math.pow(isqrt2,(rx===0)+(ry===0));for(let y=0;y<n;y++){for(let x=0;x<m;x++){r[ry*m+rx]+=mat[y*m+x]*cosines[rx][x]*cosines[ry][y]}}r[ry*m+rx]*=c/4}}return r}function phash(pixels,hashsize=8,hfreq_fact=4){const OCTLEN=8;let imgsize=hashsize*hfreq_fact;let midpoint=Math.floor(hashsize*hashsize/2);let noctets=Math.floor(hashsize*hashsize/OCTLEN);let cosines=precomputeCosines(imgsize);let coef=dct(pixels,imgsize,imgsize,cosines);let lofreqcoef=[];for(let y=0;y<hashsize;y++){for(let x=0;x<hashsize;x++){lofreqcoef.push(coef[y*imgsize+x])}}let median=lofreqcoef.slice().sort(((a,b)=>a-b))[midpoint];let bits=new Uint8Array(noctets);for(let i=0;i<noctets;i++){bits[i]=lofreqcoef.slice(i*OCTLEN,(i+1)*OCTLEN).reduce(((acc,val,idx)=>acc|=(val>median?1:0)<<OCTLEN-idx-1),0)}return bits.reduce(((acc,val)=>acc+=val.toString(16).padStart(2,"0")),"")}onmessage=async function(oEvent){let id=oEvent.data.id;let data=oEvent.data.data;const width=oEvent.data.width;const height=oEvent.data.height;const LUMASCALE=[.2989,.587,.114];let pixels=new Array(width*height);for(let y=0;y<height;y++){for(let x=0;x<width;x++){let idx=(width*y+x)*4;pixels[width*y+x]=data[idx]*LUMASCALE[0]+data[idx+1]*LUMASCALE[1]+data[idx+2]*LUMASCALE[2]}}let hash=phash(pixels);postMessage({id:id,grayHash:hash})};